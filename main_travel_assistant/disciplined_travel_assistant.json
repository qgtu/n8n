{
  "name": "Disciplined Travel Assistant (Production)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "disciplined-travel",
        "responseMode": "lastNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "61bf2a25-6106-4059-9c7d-16c4fd853e25",
      "name": "Webhook_ReceiveMessage",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        56800,
        68400
      ],
      "webhookId": "disciplined-travel"
    },
    {
      "parameters": {
        "jsCode": "// ===== NORMALIZE INPUT =====\n// Mission: Clean ONLY, khÃ´ng sá»­a nghÄ©a\n\nconst body = $json.body || {};\nconst query = $json.query || {};\nconst headers = $json.headers || {};\n\nlet sessionId = body.sessionId || query.sessionId || headers['x-session-id'];\nif (!sessionId) {\n  sessionId = `sess_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;\n}\n\nconst message = String(body.message || '').trim();\nconst messageLower = message.toLowerCase();\nconst userLocation = body.user_location || null;\n\nreturn { sessionId, message, messageLower, userLocation, _startTime: Date.now() };"
      },
      "id": "d1dd8dc6-c5a1-4739-a831-e70ae7bfa4ae",
      "name": "Fn_NormalizeInput",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57024,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== INTENT SCORING ENGINE =====\n// Deterministic scoring with threshold + tie-breaking\n// NO AI, NO ML, pure weighted keyword scoring\n\nconst msg = $json.messageLower;\nconst prevData = $json;\n\nconst scores = {\n  SEARCH_NEARBY: 0,\n  GET_PLACE_INFO: 0,\n  SEARCH_TOUR: 0,\n  GET_WEATHER: 0,\n  SEARCH_HOTEL: 0,\n  SEARCH_POI: 0,\n  GET_DISTANCE: 0\n};\n\nconst INTENT_PRIORITY = {\n  GET_DISTANCE: 7,\n  GET_PLACE_INFO: 6,\n  SEARCH_NEARBY: 5,\n  SEARCH_TOUR: 4,\n  GET_WEATHER: 3,\n  SEARCH_HOTEL: 2,\n  SEARCH_POI: 1\n};\n\n// GET_DISTANCE\nif (/khoáº£ng cÃ¡ch|bao xa|how far/.test(msg)) scores.GET_DISTANCE += 5;\nif (/tá»«\\s.+\\sÄ‘áº¿n\\s/.test(msg)) scores.GET_DISTANCE += 5;\nif (/Ä‘Æ°á»ng Ä‘i|route|directions/.test(msg)) scores.GET_DISTANCE += 4;\nif (/máº¥t bao lÃ¢u|bao lÃ¢u/.test(msg)) scores.GET_DISTANCE += 3;\nif (/cÃ¡ch.*bao/.test(msg)) scores.GET_DISTANCE += 3;\n\n// SEARCH_NEARBY\nif (/gáº§n tÃ´i|quanh tÃ´i|xung quanh tÃ´i|near me|nearby/.test(msg)) scores.SEARCH_NEARBY += 5;\nif (/gáº§n Ä‘Ã¢y/.test(msg)) scores.SEARCH_NEARBY += 3;\n\n// GET_PLACE_INFO\nif (/giÃ¡ vÃ©|vÃ© vÃ o|phÃ­ tham quan/.test(msg)) scores.GET_PLACE_INFO += 5;\nif (/giá» má»Ÿ cá»­a|má»Ÿ cá»­a lÃºc/.test(msg)) scores.GET_PLACE_INFO += 5;\nif (/thÃ´ng tin/.test(msg)) scores.GET_PLACE_INFO += 3;\nif (/miá»…n phÃ­|máº¥t phÃ­/.test(msg)) scores.GET_PLACE_INFO += 3;\n\n// SEARCH_TOUR\nif (/tour\\s/.test(msg)) scores.SEARCH_TOUR += 5;\nif (/\\d+\\s*ngÃ y/.test(msg)) scores.SEARCH_TOUR += 4;\nif (/hÃ nh trÃ¬nh|lá»‹ch trÃ¬nh|chuyáº¿n Ä‘i/.test(msg)) scores.SEARCH_TOUR += 3;\n\n// GET_WEATHER\nif (/thá»i tiáº¿t|weather/.test(msg)) scores.GET_WEATHER += 5;\nif (/nhiá»‡t Ä‘á»™|Ä‘á»™ c/.test(msg)) scores.GET_WEATHER += 3;\nif (/mÆ°a|náº¯ng/.test(msg)) scores.GET_WEATHER += 2;\n\n// SEARCH_HOTEL\nif (/khÃ¡ch sáº¡n|hotel/.test(msg)) scores.SEARCH_HOTEL += 5;\nif (/phÃ²ng nghá»‰|homestay|resort|nhÃ  nghá»‰/.test(msg)) scores.SEARCH_HOTEL += 4;\n\n// SEARCH_POI\nif (/Ä‘á»‹a Ä‘iá»ƒm|tham quan/.test(msg)) scores.SEARCH_POI += 4;\nif (/du lá»‹ch|Ä‘i chÆ¡i|Ä‘i Ä‘Ã¢u/.test(msg)) scores.SEARCH_POI += 3;\nif (/attraction/.test(msg)) scores.SEARCH_POI += 3;\n\nconst THRESHOLD = 3;\nconst sorted = Object.entries(scores)\n  .sort((a, b) => b[1] - a[1] || INTENT_PRIORITY[b[0]] - INTENT_PRIORITY[a[0]]);\nconst top = sorted[0];\nconst second = sorted[1];\n\nlet intent = 'UNKNOWN';\nlet confidence = 'low';\nlet hasOverlap = false;\n\nif (top[1] >= THRESHOLD) {\n  intent = top[0];\n  const gap = top[1] - second[1];\n  if (gap >= 3) confidence = 'high';\n  else if (gap >= 1) confidence = 'medium';\n  else { confidence = 'low'; hasOverlap = true; }\n}\n\nconsole.log('[IntentScoring] Winner:', intent, '| Score:', top[1], '| Gap:', top[1] - second[1], '| Overlap:', hasOverlap);\n\nreturn {\n  ...prevData,\n  intent,\n  confidence,\n  intentScores: scores,\n  hasOverlap\n};"
      },
      "id": "af8b5ae1-rule-based-intent",
      "name": "Fn_DetectIntentRuleBased",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57248,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== CHECK REQUIRED SLOTS (SLOT SCHEMA) =====\nconst data = $json;\nconst msg = data.messageLower || '';\nconst intent = data.intent || 'UNKNOWN';\nconst userLocation = data.userLocation || null;\n\nconst hasPlaceName = /Ä‘á»n|chÃ¹a|nhÃ  thá»|báº£o tÃ ng|lÄƒng|há»“(?:\\s|$)|nÃºi(?:\\s|$)|biá»ƒn|hang|Ä‘á»™ng|thÃ¡c|cáº§u|cÃ´ng viÃªn|di tÃ­ch/.test(msg);\nconst hasLocation = /á»Ÿ\\s|táº¡i\\s|gáº§n\\s(?!tÃ´i)|quanh\\s(?!tÃ´i)|khu vá»±c|hÃ  ná»™i|sÃ i gÃ²n|Ä‘Ã  náºµng|ninh bÃ¬nh|huáº¿|nha trang|Ä‘Ã  láº¡t|phÃº quá»‘c|há»™i an|háº¡ long|quáº£ng ninh/.test(msg);\nconst hasUserLocation = !!(userLocation && userLocation.lat && userLocation.lng);\nconst hasDateTime = /hÃ´m nay|ngÃ y mai|cuá»‘i tuáº§n|tuáº§n nÃ y|tuáº§n tá»›i|\\d+\\/\\d+/.test(msg);\nconst durationMatch = msg.match(/(\\d+)\\s*ngÃ y/);\nconst duration = durationMatch ? parseInt(durationMatch[1]) : null;\n\nlet needClarification = false;\nlet clarificationMessage = '';\nlet pipelineType = 'none';\nlet missingSlots = [];\n\nswitch (intent) {\n  case 'GET_DISTANCE':\n    const distMatch = msg.match(/tá»«\\s+(.+?)\\s+(?:Ä‘áº¿n|tá»›i|sang)\\s+(.+?)(?:\\s+(?:lÃ |bao|máº¥t|khoáº£ng)|[?.!]|$)/i);\n    if (distMatch) {\n      pipelineType = 'distance';\n    } else if (hasLocation || hasPlaceName) {\n      needClarification = true;\n      missingSlots.push('origin');\n      clarificationMessage = 'ðŸ“ Báº¡n muá»‘n tÃ­nh khoáº£ng cÃ¡ch tá»« Ä‘Ã¢u?\\n\\nVÃ­ dá»¥: \"Tá»« HÃ  Ná»™i Ä‘áº¿n Ninh BÃ¬nh\" hoáº·c cho phÃ©p truy cáº­p vá»‹ trÃ­.';\n    } else {\n      needClarification = true;\n      missingSlots.push('origin', 'destination');\n      clarificationMessage = 'ðŸ“ Báº¡n muá»‘n tÃ­nh khoáº£ng cÃ¡ch giá»¯a hai Ä‘iá»ƒm nÃ o?\\n\\nVÃ­ dá»¥: \"Khoáº£ng cÃ¡ch tá»« HÃ  Ná»™i Ä‘áº¿n ÄÃ  Náºµng\"';\n    }\n    break;\n  case 'GET_WEATHER':\n    if (!hasLocation && !hasPlaceName) {\n      needClarification = true;\n      missingSlots.push('location');\n      clarificationMessage = 'ðŸŒ¦ï¸ Báº¡n muá»‘n xem thá»i tiáº¿t á»Ÿ Ä‘Ã¢u?\\n\\nVÃ­ dá»¥: HÃ  Ná»™i, ÄÃ  Náºµng, Ninh BÃ¬nh...';\n    } else { pipelineType = 'geocode'; }\n    break;\n  case 'SEARCH_POI':\n    if (!hasLocation && !hasPlaceName) {\n      needClarification = true;\n      missingSlots.push('location');\n      clarificationMessage = 'ðŸžï¸ Báº¡n muá»‘n tÃ¬m Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch á»Ÿ Ä‘Ã¢u?\\n\\nVÃ­ dá»¥: HÃ  Ná»™i, Ninh BÃ¬nh, ÄÃ  Náºµng...';\n    } else { pipelineType = 'geocode'; }\n    break;\n  case 'SEARCH_TOUR':\n    if (!duration) {\n      needClarification = true;\n      missingSlots.push('duration');\n      clarificationMessage = 'ðŸ§³ Báº¡n muá»‘n tÃ¬m tour bao nhiÃªu ngÃ y?\\n\\nVÃ­ dá»¥: \"Tour 3 ngÃ y ÄÃ  Náºµng\", \"Tour 5 ngÃ y PhÃº Quá»‘c\"...';\n    } else { pipelineType = 'textFilter'; }\n    break;\n  case 'GET_PLACE_INFO':\n    if (!hasPlaceName) {\n      needClarification = true;\n      missingSlots.push('place_name');\n      clarificationMessage = 'ðŸ“ Báº¡n muá»‘n xem thÃ´ng tin Ä‘á»‹a Ä‘iá»ƒm nÃ o?\\n\\nVÃ­ dá»¥: Äá»n ThÃ¡i Vi, ChÃ¹a BÃ¡i ÄÃ­nh, Há»“ HoÃ n Kiáº¿m...';\n    } else { pipelineType = 'placeName'; }\n    break;\n  case 'SEARCH_HOTEL':\n    if (!hasLocation && !hasPlaceName) {\n      needClarification = true;\n      missingSlots.push('location');\n      clarificationMessage = 'ðŸ¨ Báº¡n muá»‘n tÃ¬m khÃ¡ch sáº¡n á»Ÿ Ä‘Ã¢u?\\n\\nVÃ­ dá»¥: HÃ  Ná»™i, ÄÃ  Náºµng, Quáº­n 1 SÃ i GÃ²n...';\n    } else { pipelineType = 'geocode'; }\n    break;\n  case 'SEARCH_NEARBY':\n    if (!hasUserLocation) {\n      needClarification = true;\n      missingSlots.push('user_location');\n      clarificationMessage = 'ðŸ“ Äá»ƒ tÃ¬m Ä‘á»‹a Ä‘iá»ƒm gáº§n báº¡n, vui lÃ²ng cho phÃ©p truy cáº­p vá»‹ trÃ­.\\n\\nHoáº·c cho biáº¿t khu vá»±c báº¡n Ä‘ang á»Ÿ (VD: \"Quáº­n 1 SÃ i GÃ²n\")';\n    } else { pipelineType = 'userLocation'; }\n    break;\n  default:\n    needClarification = true;\n    clarificationMessage = 'TÃ´i cÃ³ thá»ƒ giÃºp báº¡n:\\n\\nðŸŒ¦ï¸ Xem thá»i tiáº¿t\\nðŸžï¸ TÃ¬m Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch\\nðŸ§³ TÃ¬m tour\\nðŸ“ ThÃ´ng tin Ä‘á»‹a Ä‘iá»ƒm\\nðŸ¨ TÃ¬m khÃ¡ch sáº¡n\\nðŸ“ TÃ¬m gáº§n tÃ´i\\nðŸ“ TÃ­nh khoáº£ng cÃ¡ch\\n\\nVÃ­ dá»¥: \"Thá»i tiáº¿t HÃ  Ná»™i\" hoáº·c \"Tá»« HÃ  Ná»™i Ä‘áº¿n ÄÃ  Náºµng bao xa?\"';\n}\n\nconsole.log('[Fn_CheckSlots] Intent:', intent, '| Pipeline:', pipelineType, '| Need clarify:', needClarification);\n\nreturn {\n  ...data,\n  hasPlaceName, hasLocation, hasUserLocation, hasDateTime, duration,\n  missingSlots, needClarification, clarificationMessage, pipelineType\n};"
      },
      "id": "6661cacf-8468-4fc4-a8c7-2194fee08157",
      "name": "Fn_CheckRequiredSlots",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57472,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needClarification === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "78a1e412-7eed-4b7e-9471-7f72c8f92e3c",
      "name": "IF_NeedClarification",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        57696,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Return clarification message + metrics\nlet _st = null, _sid = null;\ntry { _st = $('Fn_NormalizeInput').item.json._startTime; _sid = $('Fn_NormalizeInput').item.json.sessionId; } catch(e) {}\nreturn {\n  response: $json.clarificationMessage || 'Vui lÃ²ng cung cáº¥p thÃªm thÃ´ng tin.',\n  type: 'clarification',\n  intent: $json.intent,\n  missingSlots: $json.missingSlots,\n  _log: {\n    sessionId: _sid || 'unknown',\n    intent: $json.intent || 'UNKNOWN',\n    latencyMs: _st ? Date.now() - _st : 0,\n    cacheHitWeather: false, cacheHitDistance: false,\n    knowledgeHit: false, fallbackTriggered: false,\n    clarificationTriggered: true, errorType: null\n  }\n};"
      },
      "id": "75036388-respond-clarify",
      "name": "Respond_Clarify",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57920,
        68600
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pipelineType }}",
                    "rightValue": "geocode",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Geocode"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pipelineType }}",
                    "rightValue": "placeName",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PlaceName"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pipelineType }}",
                    "rightValue": "userLocation",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "UserLocation"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pipelineType }}",
                    "rightValue": "textFilter",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "TextFilter"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pipelineType }}",
                    "rightValue": "distance",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Distance"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "b9c7e234-switch-pipeline",
      "name": "Switch_Pipeline",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        57920,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== EXTRACT LOCATION =====\n// Phase 1: Strip temporal phrases\n// Phase 2: Extract location from cleaned text\n\nconst message = ($json.message || '').trim();\nconst msgLower = message.toLowerCase();\n\nconst temporalPatterns = [\n  /\\b(hÃ´m nay|hÃ´m qua|ngÃ y mai|ngÃ y kia)\\b/gi,\n  /\\b(cuá»‘i tuáº§n|tuáº§n nÃ y|tuáº§n tá»›i|tuáº§n sau)\\b/gi,\n  /\\b(sÃ¡ng nay|chiá»u nay|tá»‘i nay|Ä‘Ãªm nay)\\b/gi,\n  /\\b(sÃ¡ng mai|chiá»u mai|tá»‘i mai)\\b/gi,\n  /\\b(thá»©\\s*[2-7]|chá»§ nháº­t)\\b/gi\n];\n\nlet cleanedMsg = msgLower;\nlet detectedTime = null;\n\nfor (const pattern of temporalPatterns) {\n  const match = cleanedMsg.match(pattern);\n  if (match && !detectedTime) detectedTime = match[0].trim();\n  cleanedMsg = cleanedMsg.replace(pattern, ' ');\n}\ncleanedMsg = cleanedMsg.replace(/\\s+/g, ' ').trim();\n\nlet locationRaw = null;\n\nconst matchAfter = cleanedMsg.match(/(?:\\bá»Ÿ|\\btáº¡i|\\bgáº§n|\\bquanh)\\s+([^,?.!]+)/i);\nif (matchAfter) {\n  locationRaw = matchAfter[1].trim()\n    .replace(/\\s+(nháº¥t|Ä‘áº¹p|ná»•i tiáº¿ng|hay|tá»‘t|xa|ngon).*$/i, '')\n    .replace(/^\\d+\\s*/, '')\n    .trim();\n}\n\nif (!locationRaw) {\n  const placeMatch = cleanedMsg.match(/(?:Ä‘á»n|chÃ¹a|lÄƒng|miáº¿u|há»“|nÃºi|bÃ£i|cÃ´ng viÃªn|báº£o tÃ ng|di tÃ­ch)\\s+([\\p{L}\\s]+?)(?:\\s+(giÃ¡|giá»|thÃ´ng)|$)/iu);\n  if (placeMatch) {\n    locationRaw = placeMatch[0].replace(/\\s+(giÃ¡|giá»|thÃ´ng).*$/i, '').trim();\n  }\n}\n\nif (!locationRaw) {\n  const landmarks = ['há»“ hoÃ n kiáº¿m', 'há»“ gÆ°Æ¡m', 'lÄƒng bÃ¡c', 'chÃ¹a má»™t cá»™t', 'chÃ¹a bÃ¡i Ä‘Ã­nh', 'trÃ ng an', 'tam cá»‘c', 'vá»‹nh háº¡ long', 'Ä‘á»™ng phong nha', 'Ä‘á»n thÃ¡i vi', 'bÃ  nÃ  hills', 'sapa', 'sa pa', 'phá»‘ cá»• há»™i an', 'cá»‘ Ä‘Ã´ huáº¿', 'mÅ©i nÃ©', 'nÃºi bÃ  Ä‘en'];\n  for (const place of landmarks) {\n    if (cleanedMsg.includes(place)) { locationRaw = place; break; }\n  }\n}\n\nif (!locationRaw) {\n  const cities = ['hÃ  ná»™i', 'sÃ i gÃ²n', 'há»“ chÃ­ minh', 'Ä‘Ã  náºµng', 'huáº¿', 'nha trang', 'phÃº quá»‘c', 'há»™i an', 'Ä‘Ã  láº¡t', 'sapa', 'háº¡ long', 'ninh bÃ¬nh', 'quáº£ng ninh', 'quáº£ng bÃ¬nh'];\n  for (const city of cities) {\n    if (cleanedMsg.includes(city)) { locationRaw = city; break; }\n  }\n}\n\nif (locationRaw) {\n  locationRaw = locationRaw.replace(/[?!.]*$/, '').trim();\n  if (['tÃ´i', 'Ä‘Ã¢y', 'Ä‘Ã¢u'].includes(locationRaw.toLowerCase())) locationRaw = null;\n}\n\nconsole.log('[Fn_ExtractLocation] Raw:', message, '| Location:', locationRaw, '| Time:', detectedTime);\n\nreturn {\n  ...$json,\n  location: locationRaw,\n  detectedTime: detectedTime,\n  cleanedMessage: cleanedMsg\n};"
      },
      "id": "a394e134-extract-location",
      "name": "Fn_ExtractLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58144,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.location }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "6b174c18-location-valid",
      "name": "IF_LocationValid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58368,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "let _st = null, _sid = null, _intent = null;\ntry { const _ni = $('Fn_NormalizeInput').item.json; _st = _ni._startTime; _sid = _ni.sessionId; } catch(e) {}\ntry { _intent = $('Fn_DetectIntentRuleBased').item.json.intent; } catch(e) {}\nreturn {\n  response: 'âŒ KhÃ´ng thá»ƒ xÃ¡c Ä‘á»‹nh Ä‘á»‹a Ä‘iá»ƒm.\\n\\nVui lÃ²ng cung cáº¥p rÃµ hÆ¡n, vÃ­ dá»¥:\\nâ€¢ HÃ  Ná»™i\\nâ€¢ Äá»n ThÃ¡i Vi\\nâ€¢ Quáº­n 1, SÃ i GÃ²n',\n  type: 'error',\n  _log: {\n    sessionId: _sid || 'unknown', intent: _intent || 'UNKNOWN',\n    latencyMs: _st ? Date.now() - _st : 0,\n    cacheHitWeather: false, cacheHitDistance: false,\n    knowledgeHit: false, fallbackTriggered: false,\n    clarificationTriggered: false, errorType: 'location_invalid'\n  }\n};"
      },
      "id": "1607049d-location-invalid",
      "name": "Respond_LocationInvalid",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        68600
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== NORMALIZE ALIAS =====\n// Contract: DB stores lowercase, no-diacritics, underscore-separated aliases\n\nconst data = $json;\nconst raw = (data.location || '').toLowerCase().trim();\n\nfunction normalizeAlias(text) {\n  if (!text) return null;\n  return text\n    .replace(/\\s+/g, ' ').trim()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/Ä‘/g, 'd').replace(/Ä/g, 'D')\n    .replace(/[.,!?;:'\\\"()\\[\\]{}]/g, '')\n    .replace(/\\s+/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '')\n    .toLowerCase() || null;\n}\n\nconst normalized_alias = normalizeAlias(raw);\nconsole.log('[Fn_NormalizeAlias] Raw:', raw, '| Normalized:', normalized_alias);\n\nreturn {\n  ...data,\n  place: { raw: raw, normalized: normalized_alias },\n  normalized_alias: normalized_alias,\n  intent: data.intent\n};"
      },
      "id": "fn-normalize-alias",
      "name": "Fn_NormalizeAlias",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        68400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT canonical_name, lat, lng, place_type, admin_level, priority FROM poi_override WHERE status = 'active' AND aliases ? '{{ $json.normalized_alias }}' AND intent_support ? '{{ $json.intent }}' ORDER BY admin_level DESC, priority DESC LIMIT 1;"
      },
      "id": "db-poi-lookup",
      "name": "DB_POI_Lookup",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        58816,
        68400
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== DB RESULT GUARD =====\nconst items = $input.all();\n\nif (items.length > 0 && items[0].json && Object.keys(items[0].json).length > 0) {\n  const row = items[0].json;\n  console.log('[DBResultGuard] DB HIT:', row.canonical_name);\n  return [{ json: { ...row, dbMatch: true } }];\n} else {\n  console.log('[DBResultGuard] DB MISS');\n  return [{ json: { dbMatch: false } }];\n}"
      },
      "id": "fn-db-result-guard",
      "name": "Fn_DBResultGuard",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59040,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.dbMatch === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-db-match",
      "name": "IF_DBMatch",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        59264,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== USE DB RESULT (FAST PATH) =====\n// Bypass geocode API when DB has authoritative match\nconst extractData = $('Fn_ExtractLocation').item.json;\nconst dbResult = $json;\n\nconst lat = parseFloat(dbResult.lat);\nconst lng = parseFloat(dbResult.lng);\n\nconsole.log('[Fn_UseDBResult] DB HIT:', dbResult.canonical_name, '| Coords:', lat, lng);\n\nreturn {\n  ...extractData,\n  locationDisplay: dbResult.canonical_name,\n  coordinates: lat + ',' + lng,\n  geocoded: true,\n  lat: lat,\n  lng: lng,\n  source: 'poi_override_db',\n  place_type: dbResult.place_type,\n  db_priority: dbResult.priority\n};"
      },
      "id": "fn-use-db-result",
      "name": "Fn_UseDBResult",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59488,
        68300
      ]
    },
    {
      "parameters": {
        "url": "https://geocode.search.hereapi.com/v1/geocode",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.location }}"
            },
            {
              "name": "apiKey",
              "value": "={{ $env.HERE_API_KEY || 'DyD7QbF6uEeLGB47HYJ-ixnpiuYuS_HNFVaZso01_lQ' }}"
            },
            {
              "name": "lang",
              "value": "vi-VN"
            },
            {
              "name": "limit",
              "value": "1"
            },
            {
              "name": "in",
              "value": "countryCode:VNM"
            }
          ]
        },
        "options": {
          "timeout": 8000
        }
      },
      "id": "806ae408-geocode",
      "name": "HTTP_Geocode",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59488,
        68550
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE GEOCODE RESPONSE =====\nconst prevData = $('Fn_ExtractLocation').item.json;\nconst res = $json;\n\nlet lat = null, lng = null, displayName = null, success = false;\n\nif (res.items && res.items.length > 0 && res.items[0].position) {\n  lat = res.items[0].position.lat;\n  lng = res.items[0].position.lng;\n  displayName = res.items[0].title || prevData.location;\n  success = true;\n}\n\nconst coordinates = success ? lat + ',' + lng : null;\nconsole.log('[Fn_ParseGeocode] Success:', success, '| Coords:', coordinates);\n\nreturn {\n  ...prevData,\n  locationDisplay: displayName || prevData.location,\n  coordinates: coordinates,\n  geocoded: success,\n  lat: lat,\n  lng: lng,\n  source: 'here_api'\n};"
      },
      "id": "0ff38a7e-parse-geocode",
      "name": "Fn_ParseGeocode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59712,
        68550
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.coordinates }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "70536312-geocode-success",
      "name": "IF_GeocodeSuccess",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        59936,
        68550
      ]
    },
    {
      "parameters": {
        "jsCode": "const location = $json.location || 'Ä‘á»‹a Ä‘iá»ƒm';\nlet _st = null, _sid = null, _intent = null;\ntry { const _ni = $('Fn_NormalizeInput').item.json; _st = _ni._startTime; _sid = _ni.sessionId; } catch(e) {}\ntry { _intent = $('Fn_DetectIntentRuleBased').item.json.intent; } catch(e) {}\nreturn {\n  response: 'âŒ KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ cho \"' + location + '\".\\n\\nVui lÃ²ng thá»­:\\nâ€¢ ThÃªm tá»‰nh/thÃ nh phá»‘ (VD: Äá»n ThÃ¡i Vi, Ninh BÃ¬nh)\\nâ€¢ DÃ¹ng tÃªn phá»• biáº¿n hÆ¡n',\n  type: 'geocode_failed',\n  _log: {\n    sessionId: _sid || 'unknown', intent: _intent || 'UNKNOWN',\n    latencyMs: _st ? Date.now() - _st : 0,\n    cacheHitWeather: false, cacheHitDistance: false,\n    knowledgeHit: false, fallbackTriggered: false,\n    clarificationTriggered: false, errorType: 'geocode_failed'\n  }\n};"
      },
      "id": "560a2e50-geocode-failed",
      "name": "Respond_GeocodeFailed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        68700
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_POI",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "POI"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "GET_WEATHER",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Weather"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_HOTEL",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Hotel"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "f8548ae8-route-api",
      "name": "Switch_RouteToAPI",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        60160,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== RESOLVE PLACE NAME (for GET_PLACE_INFO) =====\n// Enhanced: Also check DB canonical_name for better search accuracy\nconst msg = $json.messageLower || '';\nlet placeName = null;\n\n// Strategy 1: Place type keywords\nconst placeMatch = msg.match(/(?:Ä‘á»n|chÃ¹a|lÄƒng|miáº¿u|há»“|nÃºi|bÃ£i biá»ƒn|cÃ´ng viÃªn|báº£o tÃ ng|di tÃ­ch|khu)\\s+([\\wÃ€-á»¹\\s]+?)(?:\\s+giÃ¡|\\s+giá»|\\s+thÃ´ng|\\s+cuá»‘i|\\s+hÃ´m|\\s+\\?|$)/i);\nif (placeMatch) {\n  placeName = placeMatch[0].replace(/giÃ¡|giá»|thÃ´ng.*$|cuá»‘i.*$|hÃ´m.*$|\\?/gi, '').trim();\n}\n\n// Strategy 2: Famous landmarks\nif (!placeName) {\n  const landmarks = ['há»“ hoÃ n kiáº¿m', 'há»“ gÆ°Æ¡m', 'lÄƒng bÃ¡c', 'chÃ¹a má»™t cá»™t', 'chÃ¹a bÃ¡i Ä‘Ã­nh', 'trÃ ng an', 'tam cá»‘c', 'vá»‹nh háº¡ long', 'phá»‘ cá»• há»™i an', 'bÃ  nÃ  hills', 'sapa', 'cá»‘ Ä‘Ã´ huáº¿', 'mÅ©i nÃ©', 'nÃºi bÃ  Ä‘en', 'Ä‘á»™ng phong nha'];\n  const found = landmarks.find(l => msg.includes(l));\n  if (found) placeName = found;\n}\n\nif (!placeName) {\n  console.log('[Fn_ResolvePlaceName] WARN: No place name found in message');\n}\n\nconsole.log('[Fn_ResolvePlaceName] PlaceName:', placeName);\n\nreturn {\n  ...$json,\n  placeName,\n  locationDisplay: placeName\n};"
      },
      "id": "fn-resolve-placename",
      "name": "Fn_ResolvePlaceName",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58144,
        68200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== NORMALIZE PLACE ALIAS (for Knowledge Layer DB lookup) =====\nconst data = $json;\nconst raw = (data.placeName || data.locationDisplay || '').toLowerCase().trim();\n\nfunction normalizeAlias(text) {\n  if (!text) return null;\n  return text\n    .replace(/\\s+/g, ' ').trim()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/Ä‘/g, 'd').replace(/Ä/g, 'D')\n    .replace(/[.,!?;:'\\\"()\\[\\]{}]/g, '')\n    .replace(/\\s+/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '')\n    .toLowerCase() || null;\n}\n\nconst placeAlias = normalizeAlias(raw);\nconsole.log('[Fn_NormalizePlaceAlias] Raw:', raw, '| Alias:', placeAlias);\n\nreturn { ...data, placeAlias };"
      },
      "id": "fn-normalize-place-alias",
      "name": "Fn_NormalizePlaceAlias",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58368,
        68200
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT canonical_name, description, opening_hours_json, ticket_price_json, address, lat, lng, place_type, last_verified_at FROM poi_override WHERE status = 'active' AND aliases ? '{{ $json.placeAlias }}' AND intent_support ? 'GET_PLACE_INFO' ORDER BY admin_level DESC, priority DESC LIMIT 1;"
      },
      "id": "db-place-metadata-lookup",
      "name": "DB_PlaceMetadataLookup",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        58592,
        68200
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== PLACE METADATA GUARD =====\nconst items = $input.all();\n\nif (items.length > 0 && items[0].json && Object.keys(items[0].json).length > 0) {\n  const row = items[0].json;\n  const hasMetadata = !!(row.description || row.ticket_price_json || row.opening_hours_json);\n  console.log('[PlaceMetadataGuard] DB HIT:', row.canonical_name, '| Has metadata:', hasMetadata);\n  return [{ json: { ...row, dbMatch: true, hasMetadata: hasMetadata } }];\n} else {\n  console.log('[PlaceMetadataGuard] DB MISS');\n  return [{ json: { dbMatch: false, hasMetadata: false } }];\n}"
      },
      "id": "fn-place-metadata-guard",
      "name": "Fn_PlaceMetadataGuard",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58816,
        68200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.dbMatch === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "leftValue": "={{ $json.hasMetadata === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-has-place-metadata",
      "name": "IF_HasPlaceMetadata",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        59040,
        68200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT PLACE INFO FROM DB (Knowledge Layer) =====\n// Contract: Output MUST match Fn_FormatPlaceInfo output exactly\nconst dbData = $json;\nconst resolveData = $('Fn_ResolvePlaceName').item.json;\n\nconst place_info = {\n  name: dbData.canonical_name || resolveData.placeName,\n  description: dbData.description || null,\n  ticket_price: null,\n  opening_hours: null,\n  address: dbData.address || null\n};\n\n// Format ticket_price from JSONB\nif (dbData.ticket_price_json) {\n  const tp = typeof dbData.ticket_price_json === 'string'\n    ? JSON.parse(dbData.ticket_price_json) : dbData.ticket_price_json;\n  const parts = [];\n  if (tp.adult) parts.push('NgÆ°á»i lá»›n: ' + tp.adult);\n  if (tp.child) parts.push('Tráº» em: ' + tp.child);\n  if (tp.child_1m_1m4) parts.push('Tráº» 1m-1m4: ' + tp.child_1m_1m4);\n  if (tp.ve_tham_quan) parts.push(tp.ve_tham_quan);\n  if (tp.ho) parts.push('Há»“: ' + tp.ho);\n  if (tp.den_ngoc_son) parts.push('Äá»n Ngá»c SÆ¡n: ' + tp.den_ngoc_son);\n  if (tp.cap_treo_fansipan) parts.push('CÃ¡p treo Fansipan: ' + tp.cap_treo_fansipan);\n  if (tp.cap_treo_1_chieu) parts.push('CÃ¡p treo 1 chiá»u: ' + tp.cap_treo_1_chieu);\n  if (tp.cap_treo_2_chieu) parts.push('CÃ¡p treo 2 chiá»u: ' + tp.cap_treo_2_chieu);\n  if (tp.xe_dien) parts.push('Xe Ä‘iá»‡n: ' + tp.xe_dien);\n  if (tp.thuyen) parts.push('Thuyá»n: ' + tp.thuyen);\n  if (tp.combo) parts.push('Combo: ' + tp.combo);\n  if (tp.pho_co) parts.push('Phá»‘ cá»•: ' + tp.pho_co);\n  if (tp.doi_cat_trang) parts.push('Äá»“i cÃ¡t tráº¯ng: ' + tp.doi_cat_trang);\n  if (tp.doi_cat_hong) parts.push('Äá»“i cÃ¡t há»“ng: ' + tp.doi_cat_hong);\n  if (tp.note) parts.push(tp.note);\n  place_info.ticket_price = parts.length > 0 ? parts.join('. ') : null;\n}\n\n// Format opening_hours from JSONB\nif (dbData.opening_hours_json) {\n  const oh = typeof dbData.opening_hours_json === 'string'\n    ? JSON.parse(dbData.opening_hours_json) : dbData.opening_hours_json;\n  const parts = [];\n  if (oh.default) parts.push(oh.default);\n  if (oh.tue_thu) parts.push('Thá»© 3-5: ' + oh.tue_thu);\n  if (oh.sat_sun) parts.push('Thá»© 7-CN: ' + oh.sat_sun);\n  if (oh.summer) parts.push('MÃ¹a hÃ¨: ' + oh.summer);\n  if (oh.pho_co) parts.push('Phá»‘ cá»•: ' + oh.pho_co);\n  if (oh.di_tich) parts.push('Di tÃ­ch: ' + oh.di_tich);\n  if (oh.den_ngoc_son) parts.push('Äá»n Ngá»c SÆ¡n: ' + oh.den_ngoc_son);\n  if (oh.cap_treo) parts.push('CÃ¡p treo: ' + oh.cap_treo);\n  if (oh.cap_treo_fansipan) parts.push('CÃ¡p treo Fansipan: ' + oh.cap_treo_fansipan);\n  if (oh.thi_tran) parts.push('Thá»‹ tráº¥n: ' + oh.thi_tran);\n  if (oh.bai_bien) parts.push('BÃ£i biá»ƒn: ' + oh.bai_bien);\n  if (oh.doi_cat) parts.push('Äá»“i cÃ¡t: ' + oh.doi_cat);\n  if (oh.khu_du_lich) parts.push('Khu du lá»‹ch: ' + oh.khu_du_lich);\n  if (oh.closed) parts.push('ÄÃ³ng cá»­a: ' + oh.closed);\n  if (oh.note) parts.push(oh.note);\n  place_info.opening_hours = parts.length > 0 ? parts.join('. ') : null;\n}\n\n// Temporal intelligence (is_open_now)\nlet is_open_now = null;\nlet open_status_text = null;\nif (dbData.opening_hours_json) {\n  const _oh = typeof dbData.opening_hours_json === 'string'\n    ? JSON.parse(dbData.opening_hours_json) : dbData.opening_hours_json;\n  const _defaultHours = _oh.default || null;\n  if (_defaultHours) {\n    const _tm = _defaultHours.match(/(\\d{1,2})[h:](\\d{0,2})\\s*-\\s*(\\d{1,2})[h:](\\d{0,2})/);\n    if (_tm) {\n      const _openH = parseInt(_tm[1]), _openM = parseInt(_tm[2] || '0');\n      const _closeH = parseInt(_tm[3]), _closeM = parseInt(_tm[4] || '0');\n      const _now = new Date();\n      const _vnH = (_now.getUTCHours() + 7) % 24, _vnM = _now.getUTCMinutes();\n      const _curMins = _vnH * 60 + _vnM;\n      const _openMins = _openH * 60 + _openM, _closeMins = _closeH * 60 + _closeM;\n      is_open_now = _curMins >= _openMins && _curMins <= _closeMins;\n      open_status_text = is_open_now\n        ? 'Äang má»Ÿ cá»­a (' + _defaultHours + ')'\n        : 'ÄÃ£ Ä‘Ã³ng cá»­a (má»Ÿ láº¡i lÃºc ' + _tm[1] + ':' + (_tm[2] || '00').padStart(2, '0') + ')';\n    }\n  }\n}\nplace_info.is_open_now = is_open_now;\nplace_info.open_status_text = open_status_text;\n\nconsole.log('[Fn_FormatPlaceFromDB] Name:', place_info.name, '| Source: knowledge_db', '| Open:', is_open_now);\n\nreturn {\n  intent: 'GET_PLACE_INFO',\n  place_info,\n  location: resolveData.placeName,\n  has_results: true,\n  source: 'knowledge_db'\n};"
      },
      "id": "fn-format-place-from-db",
      "name": "Fn_FormatPlaceFromDB",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59264,
        68100
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $('Fn_PlaceMetadataGuard').item.json.canonical_name || $('Fn_ResolvePlaceName').item.json.locationDisplay }} giÃ¡ vÃ© giá» má»Ÿ cá»­a thÃ´ng tin"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-place-info",
      "name": "HTTP_SearchPlaceInfo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59264,
        68200
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT PLACE INFO (API fallback path) =====\nconst placeData = $('Fn_ResolvePlaceName').item.json;\nconst results = $json.organic_results || [];\nconst kg = $json.knowledge_graph || {};\n\nconst place_info = {\n  name: placeData.placeName || placeData.locationDisplay,\n  description: kg.description || (results[0]?.snippet || null),\n  ticket_price: null,\n  opening_hours: kg.hours || null,\n  address: kg.address || null\n};\n\n// Extract price and hours from snippets\nfor (const r of results) {\n  const snippet = (r.snippet || '').toLowerCase();\n  const priceMatch = snippet.match(/(\\d+[.,]?\\d*)\\s*(Ä‘|vnÄ‘|Ä‘á»“ng|k|nghÃ¬n)/i);\n  if (priceMatch && !place_info.ticket_price) place_info.ticket_price = priceMatch[0];\n  const hoursMatch = snippet.match(/(\\d{1,2}[h:]\\d{0,2}\\s*-\\s*\\d{1,2}[h:]\\d{0,2})/i);\n  if (hoursMatch && !place_info.opening_hours) place_info.opening_hours = hoursMatch[0];\n}\n\n// Fallback: if no data found, provide user-friendly message\nif (!place_info.description && !place_info.ticket_price) {\n  console.log('[Fn_FormatPlaceInfo] WARN: No data found for', place_info.name);\n}\n\nconsole.log('[Fn_FormatPlaceInfo] Name:', place_info.name, '| HasDesc:', !!place_info.description, '| HasPrice:', !!place_info.ticket_price);\n\nreturn {\n  intent: 'GET_PLACE_INFO',\n  place_info,\n  location: placeData.placeName,\n  has_results: !!(place_info.description || place_info.ticket_price),\n  source: 'serpapi'\n};"
      },
      "id": "fn-format-place-info",
      "name": "Fn_FormatPlaceInfo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59488,
        68200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== BUILD NEARBY SEARCH =====\nconst data = $json;\n\nconst finalUserLocation = data.userLocation || { lat: 21.0285, lng: 105.8542, source: 'default' };\nconst lat = finalUserLocation.lat;\nconst lng = finalUserLocation.lng;\n\nconst msg = data.messageLower;\nlet poiType = 'Ä‘á»‹a Ä‘iá»ƒm du lá»‹ch';\nif (/Äƒn|quÃ¡n|nhÃ  hÃ ng/.test(msg)) poiType = 'nhÃ  hÃ ng quÃ¡n Äƒn';\nelse if (/cafe|cÃ  phÃª/.test(msg)) poiType = 'quÃ¡n cafe';\nelse if (/khÃ¡ch sáº¡n|hotel/.test(msg)) poiType = 'khÃ¡ch sáº¡n';\n\nconst countMatch = msg.match(/(\\d+)\\s*(?:Ä‘iá»ƒm|chá»—|nÆ¡i|Ä‘á»‹a Ä‘iá»ƒm)/);\nconst requestedCount = countMatch ? Math.min(parseInt(countMatch[1]), 10) : 5;\n\nreturn {\n  ...data,\n  userLocation: finalUserLocation,\n  coordinates: `${lat},${lng}`,\n  poiType,\n  requestedCount\n};"
      },
      "id": "fn-build-nearby-search",
      "name": "Fn_BuildNearbySearch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58144,
        68000
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google_maps"
            },
            {
              "name": "q",
              "value": "={{ $json.poiType }}"
            },
            {
              "name": "ll",
              "value": "=@{{ $json.userLocation.lat }},{{ $json.userLocation.lng }},15z"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "type",
              "value": "search"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-nearby",
      "name": "HTTP_SearchNearby",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        58368,
        68000
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT NEARBY + BUILD ORS REQUEST (MERGED) =====\n// WHY: Reduces 2 nodes into 1, both operate on same data\n// INPUT: SerpAPI local_results + user location from Fn_BuildNearbySearch\n// OUTPUT: formatted nearby_raw + ORS request body (if valid coords exist)\n\nconst prevData = $('Fn_BuildNearbySearch').item.json;\nconst results = $json.local_results || [];\nconst userLoc = prevData.userLocation;\n\n// === STEP 1: Format nearby results ===\nconst nearby_raw = results.slice(0, prevData.requestedCount).map((p, idx) => ({\n  rank: idx + 1,\n  name: p.title || 'N/A',\n  address: p.address || null,\n  rating: p.rating || null,\n  type: p.type || prevData.poiType,\n  distance: p.distance || null,\n  lat: p.gps_coordinates?.latitude || null,\n  lng: p.gps_coordinates?.longitude || null\n}));\n\nconst has_results = nearby_raw.length > 0;\n\n// === STEP 2: Build ORS matrix request ===\nconst validPlaces = nearby_raw.filter(p => p.lat != null && p.lng != null);\nlet orsSkipped = true;\nlet orsRequestBody = null;\nlet orsValidCount = 0;\n\nif (validPlaces.length > 0 && userLoc && userLoc.lat && userLoc.lng) {\n  // CRITICAL: ORS uses [lng, lat] NOT [lat, lng]\n  const locations = [\n    [userLoc.lng, userLoc.lat],\n    ...validPlaces.map(p => [p.lng, p.lat])\n  ];\n  orsRequestBody = {\n    locations,\n    sources: [0],\n    destinations: validPlaces.map((_, i) => i + 1),\n    metrics: ['distance', 'duration'],\n    units: 'm'\n  };\n  orsSkipped = false;\n  orsValidCount = validPlaces.length;\n  console.log('[FormatNearbyAndBuildORS] ORS request:', validPlaces.length, 'destinations');\n} else {\n  console.log('[FormatNearbyAndBuildORS] ORS skipped: no valid coordinates');\n}\n\nreturn {\n  intent: 'SEARCH_NEARBY',\n  nearby_raw,\n  location: 'vá»‹ trÃ­ cá»§a báº¡n',\n  poiType: prevData.poiType,\n  has_results,\n  userLocation: userLoc,\n  orsSkipped,\n  orsRequestBody,\n  orsValidCount\n};"
      },
      "id": "fn-format-nearby-build-ors",
      "name": "Fn_FormatNearbyAndBuildORS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        68000
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openrouteservice.org/v2/matrix/driving-car",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.orsRequestBody) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "http-ors-matrix",
      "name": "HTTP_ORS_Matrix",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        58816,
        68000
      ],
      "onError": "continueRegularOutput",
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_ORS_CREDENTIAL_ID",
          "name": "ORS API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== ENRICH WITH ROAD DISTANCES =====\nconst prevData = $('Fn_FormatNearbyAndBuildORS').item.json;\nconst orsResponse = $json;\nconst nearby = prevData.nearby_raw || [];\nconst userLoc = prevData.userLocation;\n\nfunction haversine(lat1, lng1, lat2, lng2) {\n  const R = 6371;\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLng = (lng2 - lng1) * Math.PI / 180;\n  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n    Math.sin(dLng/2) * Math.sin(dLng/2);\n  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n}\n\nconst orsDistances = orsResponse?.distances?.[0];\nconst orsDurations = orsResponse?.durations?.[0];\nconst orsOK = !prevData.orsSkipped && Array.isArray(orsDistances) && orsDistances.length > 0;\n\nif (orsOK) {\n  console.log('[ORS] Success:', orsDistances.length, 'distances received');\n} else {\n  console.log('[ORS] Fallback to Haversine');\n}\n\nlet orsDestIdx = 0;\nconst enriched = nearby.map(place => {\n  if (place.lat == null || place.lng == null) {\n    return { ...place, road_distance_km: null, drive_duration_min: null, distance_source: 'unavailable' };\n  }\n  if (orsOK && orsDestIdx < orsDistances.length) {\n    const distM = orsDistances[orsDestIdx];\n    const durS = orsDurations[orsDestIdx];\n    orsDestIdx++;\n    if (distM != null && durS != null) {\n      return {\n        ...place,\n        road_distance_km: Math.round(distM / 100) / 10,\n        drive_duration_min: Math.round(durS / 60),\n        distance_source: 'ors'\n      };\n    }\n  }\n  const km = haversine(userLoc.lat, userLoc.lng, place.lat, place.lng);\n  return {\n    ...place,\n    road_distance_km: Math.round(km * 10) / 10,\n    drive_duration_min: null,\n    distance_source: 'haversine'\n  };\n});\n\n// Relevance ranking\nconst _maxDist = Math.max(...enriched.filter(p => p.road_distance_km != null).map(p => p.road_distance_km), 0.1);\nconst ranked = enriched.map(place => {\n  const normDist = place.road_distance_km != null ? place.road_distance_km / _maxDist : 1;\n  const ratingScore = (place.rating || 3) / 5;\n  const score = 0.4 * (1 - normDist) + 0.3 * ratingScore + 0.2 * 0.5 + 0.1 * 0.5;\n  return { ...place, _relevanceScore: Math.round(score * 100) / 100 };\n});\nranked.sort((a, b) => b._relevanceScore - a._relevanceScore);\nconsole.log('[Ranking] Top:', ranked[0]?._relevanceScore, '| Bottom:', ranked[ranked.length-1]?._relevanceScore);\n\nreturn {\n  intent: 'SEARCH_NEARBY',\n  nearby_raw: ranked,\n  location: prevData.location,\n  poiType: prevData.poiType,\n  has_results: prevData.has_results,\n  userLocation: prevData.userLocation\n};"
      },
      "id": "fn-enrich-distances",
      "name": "Fn_EnrichWithDistances",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59040,
        68000
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE TOUR DURATION & LOCATION =====\nconst data = $json;\nconst msg = (data.messageLower || '').toLowerCase();\n\nconst durationMatch = msg.match(/(\\d+)\\s*ngÃ y/);\nconst duration = durationMatch ? parseInt(durationMatch[1]) : 3;\n\nlet tourLocation = null;\n\nconst landmarks = {\n  'há»“ hoÃ n kiáº¿m': 'Há»“ HoÃ n Kiáº¿m, HÃ  Ná»™i',\n  'há»“ gÆ°Æ¡m': 'Há»“ GÆ°Æ¡m, HÃ  Ná»™i',\n  'trÃ ng an': 'TrÃ ng An, Ninh BÃ¬nh',\n  'tam cá»‘c': 'Tam Cá»‘c, Ninh BÃ¬nh',\n  'vá»‹nh háº¡ long': 'Vá»‹nh Háº¡ Long, Quáº£ng Ninh',\n  'phá»‘ cá»• há»™i an': 'Phá»‘ cá»• Há»™i An',\n  'bÃ  nÃ  hills': 'BÃ  NÃ  Hills, ÄÃ  Náºµng',\n  'Ä‘á»n thÃ¡i vi': 'Äá»n ThÃ¡i Vi, Ninh BÃ¬nh',\n  'chÃ¹a bÃ¡i Ä‘Ã­nh': 'ChÃ¹a BÃ¡i ÄÃ­nh, Ninh BÃ¬nh',\n  'sapa': 'Sapa, LÃ o Cai'\n};\nfor (const [key, fullName] of Object.entries(landmarks)) {\n  if (msg.includes(key)) { tourLocation = fullName; break; }\n}\n\nif (!tourLocation) {\n  const cities = [\n    { pattern: 'hÃ  ná»™i', display: 'HÃ  Ná»™i' },\n    { pattern: 'sÃ i gÃ²n', display: 'SÃ i GÃ²n' },\n    { pattern: 'Ä‘Ã  náºµng', display: 'ÄÃ  Náºµng' },\n    { pattern: 'huáº¿', display: 'Huáº¿' },\n    { pattern: 'nha trang', display: 'Nha Trang' },\n    { pattern: 'phÃº quá»‘c', display: 'PhÃº Quá»‘c' },\n    { pattern: 'há»™i an', display: 'Há»™i An' },\n    { pattern: 'Ä‘Ã  láº¡t', display: 'ÄÃ  Láº¡t' },\n    { pattern: 'háº¡ long', display: 'Háº¡ Long' },\n    { pattern: 'ninh bÃ¬nh', display: 'Ninh BÃ¬nh' }\n  ];\n  const found = cities.find(c => msg.includes(c.pattern));\n  if (found) tourLocation = found.display;\n}\n\nif (!tourLocation) {\n  const locMatch = msg.match(/(?:á»Ÿ|táº¡i|Ä‘i)\\s+([\\wÃ€-á»¹\\s]+?)(?:\\s+\\d+|[?.!,]|$)/i);\n  if (locMatch) {\n    tourLocation = locMatch[1].trim().replace(/\\s+(nháº¥t|Ä‘áº¹p|hay|tá»‘t|giÃºp|tÃ´i).*$/i, '').trim();\n  }\n}\n\nif (tourLocation && ['tÃ´i', 'Ä‘Ã¢y', 'Ä‘Ã¢u'].includes(tourLocation.toLowerCase())) tourLocation = null;\n\nconsole.log('[Fn_ParseTourDuration] Duration:', duration, '| Location:', tourLocation);\n\nreturn {\n  ...data,\n  tourDuration: duration,\n  tourLocation,\n  hasLocation: !!tourLocation\n};"
      },
      "id": "fn-parse-tour-duration",
      "name": "Fn_ParseTourDuration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58144,
        67800
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "=tour {{ $json.tourDuration }} ngÃ y {{ $json.tourLocation }} giÃ¡"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-tour",
      "name": "HTTP_SearchTour",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        58368,
        67800
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT TOUR RESULTS =====\nconst prevData = $('Fn_ParseTourDuration').item.json;\nconst results = $json.organic_results || [];\n\nconst tours_raw = results.slice(0, 5).map(t => ({\n  title: t.title || 'N/A',\n  snippet: t.snippet || null,\n  source: t.link || null,\n  provider: t.displayed_link || null\n}));\n\nconsole.log('[Fn_FormatTour] Tours found:', tours_raw.length, '| Location:', prevData.tourLocation);\n\nreturn {\n  intent: 'SEARCH_TOUR',\n  tours_raw,\n  location: prevData.tourLocation,\n  duration: prevData.tourDuration,\n  has_results: tours_raw.length > 0\n};"
      },
      "id": "fn-format-tour",
      "name": "Fn_FormatTour",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        67800
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} Ä‘iá»ƒm tham quan du lá»‹ch"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-poi",
      "name": "HTTP_SearchPOI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        60384,
        68200
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT POI =====\nconst geocodeData = $('Switch_RouteToAPI').item.json;\nconst results = $json.organic_results || [];\n\nconst poi_raw = results.slice(0, 5).map(p => ({\n  name: p.title || 'N/A',\n  source: p.link || null,\n  short_fact: p.snippet || null\n}));\n\nconsole.log('[Fn_FormatPOI] POIs found:', poi_raw.length, '| Location:', geocodeData.locationDisplay);\n\nreturn {\n  intent: 'SEARCH_POI',\n  poi_raw,\n  location: geocodeData.locationDisplay || 'unknown',\n  source: geocodeData.source || 'unknown',\n  has_results: poi_raw.length > 0\n};"
      },
      "id": "fn-format-poi",
      "name": "Fn_FormatPOI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60608,
        68200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== NORMALIZE WEATHER TIME =====\nconst data = $json;\n\nlet timeText;\ntry { timeText = $('Fn_ExtractLocation').item.json.detectedTime; } catch(e) { timeText = null; }\nconst text = (timeText || data.message || '').toLowerCase();\n\nlet weatherMode = 'current';\nlet forecastDays = 0;\nlet timeDescription = 'hiá»‡n táº¡i';\n\nif (/ngÃ y mai|tomorrow/.test(text)) {\n  weatherMode = 'forecast'; forecastDays = 2; timeDescription = 'ngÃ y mai';\n} else if (/cuá»‘i tuáº§n|weekend/.test(text)) {\n  weatherMode = 'forecast'; forecastDays = 7; timeDescription = 'cuá»‘i tuáº§n';\n} else if (/\\d+\\s*(ngÃ y|day)/.test(text)) {\n  const match = text.match(/(\\d+)\\s*(ngÃ y|day)/);\n  if (match) { forecastDays = Math.min(parseInt(match[1]), 14); weatherMode = 'forecast'; timeDescription = forecastDays + ' ngÃ y tá»›i'; }\n} else if (/tuáº§n nÃ y|tuáº§n tá»›i/.test(text)) {\n  weatherMode = 'forecast'; forecastDays = 7; timeDescription = 'tuáº§n nÃ y';\n}\n\nconst _coords = (data.coordinates || '').split(',');\nconst _rlat = _coords[0] ? Math.round(parseFloat(_coords[0]) * 1000) / 1000 : 0;\nconst _rlng = _coords[1] ? Math.round(parseFloat(_coords[1]) * 1000) / 1000 : 0;\nconst weatherCacheKey = 'weather_' + _rlat + '_' + _rlng + '_' + weatherMode + '_' + forecastDays;\n\nconsole.log('[Fn_NormalizeWeatherTime] Mode:', weatherMode, '| Days:', forecastDays, '| CacheKey:', weatherCacheKey);\n\nreturn { ...data, weatherMode, forecastDays, timeDescription, weatherCacheKey };"
      },
      "id": "fn-normalize-weather-time",
      "name": "Fn_NormalizeWeatherTime",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60384,
        68400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT response_data FROM weather_cache WHERE cache_key = '{{ $json.weatherCacheKey }}' AND expires_at > NOW() LIMIT 1;"
      },
      "id": "db-check-weather-cache",
      "name": "DB_CheckWeatherCache",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        60608,
        68400
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== WEATHER CACHE GUARD =====\nconst items = $input.all();\nconst prevData = $('Fn_NormalizeWeatherTime').item.json;\n\nif (items.length > 0 && items[0].json && items[0].json.response_data) {\n  const cached = typeof items[0].json.response_data === 'string'\n    ? JSON.parse(items[0].json.response_data) : items[0].json.response_data;\n  console.log('[WeatherCacheGuard] CACHE HIT for key:', prevData.weatherCacheKey);\n  return [{ json: { ...cached, weatherMode: 'cache_hit', _cacheHit: true } }];\n} else {\n  console.log('[WeatherCacheGuard] CACHE MISS for key:', prevData.weatherCacheKey);\n  return [{ json: { ...prevData, _cacheHit: false } }];\n}"
      },
      "id": "fn-weather-cache-guard",
      "name": "Fn_WeatherCacheGuard",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60832,
        68400
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.weatherMode }}",
                    "rightValue": "cache_hit",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CacheHit"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.weatherMode }}",
                    "rightValue": "forecast",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Forecast"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "switch-weather-mode",
      "name": "Switch_WeatherMode",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        61056,
        68400
      ]
    },
    {
      "parameters": {
        "url": "https://api.weatherapi.com/v1/current.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{ $env.WEATHER_API_KEY || '52c2f536877444ec8a0165526260501' }}"
            },
            {
              "name": "q",
              "value": "={{ $json.coordinates }}"
            },
            {
              "name": "lang",
              "value": "vi"
            },
            {
              "name": "aqi",
              "value": "yes"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "http-get-weather",
      "name": "HTTP_GetWeather",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        61280,
        68500
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://api.weatherapi.com/v1/forecast.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "={{ $env.WEATHER_API_KEY || '52c2f536877444ec8a0165526260501' }}"
            },
            {
              "name": "q",
              "value": "={{ $json.coordinates }}"
            },
            {
              "name": "days",
              "value": "={{ $json.forecastDays || 3 }}"
            },
            {
              "name": "lang",
              "value": "vi"
            },
            {
              "name": "aqi",
              "value": "yes"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "http-get-weather-forecast",
      "name": "HTTP_GetWeatherForecast",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        61280,
        68300
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT WEATHER =====\nconst geocodeData = $('Switch_RouteToAPI').item.json;\nconst extractData = $('Fn_ExtractLocation').item.json;\nconst current = $json.current;\nconst apiLocation = $json.location;\n\nif (!current) {\n  console.log('[Fn_FormatWeather] WARN: No current weather data');\n  return { intent: 'GET_WEATHER', weather_raw: null, location: extractData.location, has_results: false };\n}\n\nlet airQuality = null;\nif (current.air_quality) {\n  const aqi = current.air_quality;\n  const epaIndex = aqi['us-epa-index'];\n  const epaLabels = { 1: 'Tá»‘t', 2: 'Trung bÃ¬nh', 3: 'KhÃ´ng tá»‘t cho nhÃ³m nháº¡y cáº£m', 4: 'KhÃ´ng tá»‘t', 5: 'Ráº¥t khÃ´ng tá»‘t', 6: 'Nguy háº¡i' };\n  airQuality = {\n    pm2_5: Math.round(aqi.pm2_5 * 10) / 10,\n    pm10: Math.round(aqi.pm10 * 10) / 10,\n    us_epa_index: epaIndex,\n    label: epaLabels[epaIndex] || 'KhÃ´ng rÃµ'\n  };\n}\n\nconsole.log('[Fn_FormatWeather] Temp:', current.temp_c, '| Condition:', current.condition?.text);\n\nreturn {\n  intent: 'GET_WEATHER',\n  weather_raw: {\n    temp_c: current.temp_c,\n    feelslike_c: current.feelslike_c,\n    condition: current.condition?.text || '',\n    humidity: current.humidity || 0,\n    wind_kph: current.wind_kph || 0,\n    wind_dir: current.wind_dir || '',\n    precip_mm: current.precip_mm || 0,\n    uv: current.uv,\n    vis_km: current.vis_km || 0,\n    cloud: current.cloud || 0,\n    is_day: !!current.is_day,\n    air_quality: airQuality\n  },\n  location: geocodeData.locationDisplay || extractData.location,\n  localtime: apiLocation?.localtime || null,\n  last_updated: current.last_updated || null,\n  source: geocodeData.source || 'unknown',\n  has_results: true\n};"
      },
      "id": "fn-format-weather",
      "name": "Fn_FormatWeather",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61504,
        68500
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT WEATHER FORECAST =====\nconst geocodeData = $('Switch_RouteToAPI').item.json;\nconst normalizeData = $('Fn_NormalizeWeatherTime').item.json;\nconst extractData = $('Fn_ExtractLocation').item.json;\nconst forecast = $json.forecast?.forecastday || [];\nconst currentData = $json.current;\n\nconst forecast_raw = forecast.map(day => ({\n  date: day.date,\n  maxtemp_c: day.day.maxtemp_c,\n  mintemp_c: day.day.mintemp_c,\n  avgtemp_c: day.day.avgtemp_c,\n  condition: day.day.condition?.text || '',\n  chance_of_rain: day.day.daily_chance_of_rain || 0,\n  totalprecip_mm: day.day.totalprecip_mm || 0,\n  maxwind_kph: day.day.maxwind_kph || 0,\n  avghumidity: day.day.avghumidity || 0,\n  uv: day.day.uv\n}));\n\nlet current_snapshot = null;\nif (currentData) {\n  current_snapshot = {\n    temp_c: currentData.temp_c,\n    condition: currentData.condition?.text || '',\n    humidity: currentData.humidity || 0\n  };\n}\n\nconsole.log('[Fn_FormatWeatherForecast] Days:', forecast_raw.length, '| Location:', geocodeData.locationDisplay);\n\nreturn {\n  intent: 'GET_WEATHER',\n  forecast_raw,\n  current_snapshot,\n  location: geocodeData.locationDisplay || extractData.location,\n  timeDescription: normalizeData.timeDescription,\n  source: geocodeData.source || 'unknown',\n  has_results: forecast_raw.length > 0,\n  isForecast: true\n};"
      },
      "id": "fn-format-weather-forecast",
      "name": "Fn_FormatWeatherForecast",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61504,
        68300
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO weather_cache (cache_key, response_data, expires_at) VALUES ('{{ $('Fn_NormalizeWeatherTime').item.json.weatherCacheKey }}', '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb, NOW() + INTERVAL '15 minutes') ON CONFLICT (cache_key) DO UPDATE SET response_data = EXCLUDED.response_data, expires_at = EXCLUDED.expires_at;"
      },
      "id": "db-write-weather-cache",
      "name": "DB_WriteWeatherCache",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        61728,
        68700
      ],
      "onError": "continueRegularOutput",
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google_hotels"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} hotels"
            },
            {
              "name": "check_in_date",
              "value": "={{ $now.format('yyyy-MM-dd') }}"
            },
            {
              "name": "check_out_date",
              "value": "={{ $now.plus({days: 1}).format('yyyy-MM-dd') }}"
            },
            {
              "name": "currency",
              "value": "VND"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-hotel",
      "name": "HTTP_SearchHotel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        60384,
        68600
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT HOTEL (Enhanced: added address field) =====\nconst geocodeData = $('Switch_RouteToAPI').item.json;\nconst hotels = $json.properties || [];\n\nconst hotels_raw = hotels.slice(0, 5).map(h => ({\n  name: h.name || 'N/A',\n  price: h.rate_per_night?.lowest || null,\n  rating: h.overall_rating || null,\n  description: h.description || null,\n  address: h.address || h.neighborhood || null\n}));\n\nconsole.log('[Fn_FormatHotel] Hotels found:', hotels_raw.length, '| Location:', geocodeData.locationDisplay);\n\nreturn {\n  intent: 'SEARCH_HOTEL',\n  hotels_raw,\n  location: geocodeData.locationDisplay || 'unknown',\n  source: geocodeData.source || 'unknown',\n  has_results: hotels_raw.length > 0\n};"
      },
      "id": "fn-format-hotel",
      "name": "Fn_FormatHotel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60608,
        68600
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== EXTRACT DISTANCE ENTITIES (Enhanced: DB-first alias normalization) =====\n// WHY: Normalize aliases for DB lookup before geocoding\n// OUTPUT: origin/dest text + normalized aliases for DB query\n\nconst msg = $json.messageLower || '';\nconst data = $json;\n\nlet origin = null;\nlet destination = null;\n\n// Strategy 1: \"tá»« A Ä‘áº¿n/tá»›i B\"\nconst pattern1 = msg.match(/tá»«\\s+(.+?)\\s+(?:Ä‘áº¿n|tá»›i|sang)\\s+(.+?)(?:\\s+(?:lÃ |bao|máº¥t|khoáº£ng|cÃ¡ch)|[?.!]|$)/i);\nif (pattern1) {\n  origin = pattern1[1].trim();\n  destination = pattern1[2].trim();\n}\n\n// Strategy 2: \"A cÃ¡ch B\"\nif (!origin) {\n  const pattern2 = msg.match(/(.+?)\\s+cÃ¡ch\\s+(.+?)\\s+(?:bao|máº¥y|bao xa|bao lÃ¢u)/i);\n  if (pattern2) {\n    origin = pattern2[1].trim();\n    destination = pattern2[2].trim();\n  }\n}\n\nconst cleanup = (text) => {\n  if (!text) return null;\n  return text\n    .replace(/^(thÃ nh phá»‘|tp|tá»‰nh|huyá»‡n|quáº­n)\\s+/i, '')\n    .replace(/\\s+(lÃ |bao|máº¥t|khÃ´ng|nhá»‰|váº­y|tháº¿|nÃ o).*$/i, '')\n    .replace(/[?.!,]+$/, '')\n    .trim() || null;\n};\n\norigin = cleanup(origin);\ndestination = cleanup(destination);\n\n// Normalize aliases for DB lookup (same algorithm as Fn_NormalizeAlias)\nfunction normalizeAlias(text) {\n  if (!text) return null;\n  return text\n    .replace(/\\s+/g, ' ').trim()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/Ä‘/g, 'd').replace(/Ä/g, 'D')\n    .replace(/[.,!?;:'\\\"()\\[\\]{}]/g, '')\n    .replace(/\\s+/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '')\n    .toLowerCase() || null;\n}\n\nconst originAlias = normalizeAlias(origin);\nconst destAlias = normalizeAlias(destination);\n\nconsole.log('[ExtractDistanceEntities] Origin:', origin, '(' + originAlias + ') | Dest:', destination, '(' + destAlias + ')');\n\nreturn {\n  ...data,\n  distanceOrigin: origin,\n  distanceDestination: destination,\n  originAlias,\n  destAlias,\n  hasOrigin: !!origin,\n  hasDestination: !!destination\n};"
      },
      "id": "fn-extract-distance-entities",
      "name": "Fn_ExtractDistanceEntities",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58144,
        67600
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT canonical_name, lat, lng, aliases::text, place_type, admin_level FROM poi_override WHERE status = 'active' AND intent_support ? 'GET_DISTANCE' AND (aliases ? '{{ $json.originAlias }}' OR aliases ? '{{ $json.destAlias }}') ORDER BY admin_level DESC, priority DESC;"
      },
      "id": "db-distance-poi-lookup",
      "name": "DB_DistancePOILookup",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        58368,
        67600
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== RESOLVE DISTANCE COORDS FROM DB =====\n// WHY: Use DB coords when available, skip geocode API for known places\n// INPUT: DB rows matching origin/dest aliases + extracted distance entities\n// OUTPUT: Coords for origin/dest (from DB or flagged for geocode)\n\nconst items = $input.all();\nconst prevData = $('Fn_ExtractDistanceEntities').item.json;\n\nconst originAlias = prevData.originAlias;\nconst destAlias = prevData.destAlias;\n\nlet originLat = null, originLng = null, originName = null, originSource = null;\nlet destLat = null, destLng = null, destName = null, destSource = null;\n\n// Process DB results - match aliases to origin/dest\nfor (const item of items) {\n  const row = item.json;\n  if (!row || !row.canonical_name) continue;\n\n  // Parse aliases text back to check membership\n  let aliasArr = [];\n  try {\n    aliasArr = typeof row.aliases === 'string' ? JSON.parse(row.aliases) : (row.aliases || []);\n  } catch(e) { continue; }\n\n  const matchesOrigin = originAlias && aliasArr.includes(originAlias);\n  const matchesDest = destAlias && aliasArr.includes(destAlias);\n\n  if (matchesOrigin && !originLat) {\n    originLat = parseFloat(row.lat);\n    originLng = parseFloat(row.lng);\n    originName = row.canonical_name;\n    originSource = 'poi_override_db';\n    console.log('[ResolveDistanceCoords] Origin DB HIT:', originName);\n  }\n\n  if (matchesDest && !destLat) {\n    destLat = parseFloat(row.lat);\n    destLng = parseFloat(row.lng);\n    destName = row.canonical_name;\n    destSource = 'poi_override_db';\n    console.log('[ResolveDistanceCoords] Dest DB HIT:', destName);\n  }\n}\n\nconst allCoordsResolved = !!(originLat && originLng && destLat && destLng);\nconst needGeocode = !allCoordsResolved;\n\nconsole.log('[ResolveDistanceCoords] AllResolved:', allCoordsResolved, '| NeedGeocode:', needGeocode);\n\nreturn [{ json: {\n  ...prevData,\n  originLat, originLng, originName: originName || prevData.distanceOrigin, originSource,\n  destLat, destLng, destName: destName || prevData.distanceDestination, destSource,\n  allCoordsResolved,\n  needGeocode\n}}];"
      },
      "id": "fn-resolve-distance-coords",
      "name": "Fn_ResolveDistanceCoords",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        67600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.allCoordsResolved === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-all-coords-resolved",
      "name": "IF_AllCoordsResolved",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58816,
        67600
      ]
    },
    {
      "parameters": {
        "url": "https://geocode.search.hereapi.com/v1/geocode",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.distanceOrigin }}"
            },
            {
              "name": "apiKey",
              "value": "={{ $env.HERE_API_KEY || 'DyD7QbF6uEeLGB47HYJ-ixnpiuYuS_HNFVaZso01_lQ' }}"
            },
            {
              "name": "lang",
              "value": "vi-VN"
            },
            {
              "name": "limit",
              "value": "1"
            },
            {
              "name": "in",
              "value": "countryCode:VNM"
            }
          ]
        },
        "options": {
          "timeout": 8000
        }
      },
      "id": "http-geocode-origin",
      "name": "HTTP_GeocodeOrigin",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59040,
        67400
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://geocode.search.hereapi.com/v1/geocode",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $('Fn_ResolveDistanceCoords').item.json.distanceDestination }}"
            },
            {
              "name": "apiKey",
              "value": "={{ $env.HERE_API_KEY || 'DyD7QbF6uEeLGB47HYJ-ixnpiuYuS_HNFVaZso01_lQ' }}"
            },
            {
              "name": "lang",
              "value": "vi-VN"
            },
            {
              "name": "limit",
              "value": "1"
            },
            {
              "name": "in",
              "value": "countryCode:VNM"
            }
          ]
        },
        "options": {
          "timeout": 8000
        }
      },
      "id": "http-geocode-destination",
      "name": "HTTP_GeocodeDestination",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59264,
        67400
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ===== BUILD DISTANCE ORS REQUEST (MERGED with PrepareDestGeocode) =====\n// WHY: Handles BOTH paths - DB-direct and geocode fallback\n// INPUT: Either from IF_AllCoordsResolved (true) or HTTP_GeocodeDestination\n// OUTPUT: ORS request body + validated coords + distance cache key\n\nconst resolveData = $('Fn_ResolveDistanceCoords').item.json;\n\nlet originLat, originLng, originName;\nlet destLat, destLng, destName;\n\nif (resolveData.allCoordsResolved) {\n  // === DB-DIRECT PATH: All coords from poi_override ===\n  originLat = resolveData.originLat;\n  originLng = resolveData.originLng;\n  originName = resolveData.originName;\n  destLat = resolveData.destLat;\n  destLng = resolveData.destLng;\n  destName = resolveData.destName;\n  console.log('[BuildDistanceORS] DB-direct path:', originName, 'â†’', destName);\n} else {\n  // === GEOCODE PATH: Parse geocode API responses ===\n  // Use DB coords if partially resolved, otherwise parse geocode\n  if (resolveData.originLat && resolveData.originLng) {\n    originLat = resolveData.originLat;\n    originLng = resolveData.originLng;\n    originName = resolveData.originName;\n  } else {\n    try {\n      const origGeo = $('HTTP_GeocodeOrigin').item.json;\n      if (origGeo.items && origGeo.items[0]?.position) {\n        originLat = origGeo.items[0].position.lat;\n        originLng = origGeo.items[0].position.lng;\n        originName = origGeo.items[0].title || resolveData.distanceOrigin;\n      }\n    } catch(e) { console.log('[BuildDistanceORS] Origin geocode parse failed:', e.message); }\n  }\n\n  if (resolveData.destLat && resolveData.destLng) {\n    destLat = resolveData.destLat;\n    destLng = resolveData.destLng;\n    destName = resolveData.destName;\n  } else {\n    try {\n      const destGeo = $json; // Current input from HTTP_GeocodeDestination\n      if (destGeo.items && destGeo.items[0]?.position) {\n        destLat = destGeo.items[0].position.lat;\n        destLng = destGeo.items[0].position.lng;\n        destName = destGeo.items[0].title || resolveData.distanceDestination;\n      }\n    } catch(e) { console.log('[BuildDistanceORS] Dest geocode parse failed:', e.message); }\n  }\n  console.log('[BuildDistanceORS] Geocode path:', originName, 'â†’', destName);\n}\n\n// Validate both coords\nconst originOK = !!(originLat && originLng);\nconst destOK = !!(destLat && destLng);\n\nif (!originOK || !destOK) {\n  const missing = [];\n  if (!originOK) missing.push(resolveData.distanceOrigin || 'Ä‘iá»ƒm Ä‘i');\n  if (!destOK) missing.push(resolveData.distanceDestination || 'Ä‘iá»ƒm Ä‘áº¿n');\n  console.log('[BuildDistanceORS] FAIL: Missing coords for', missing.join(', '));\n  return {\n    ...resolveData,\n    originLat, originLng, originName,\n    destLat, destLng, destName,\n    geocodeFailed: true,\n    failedLocations: missing,\n    orsRequestBody: null,\n    distanceCacheKey: null\n  };\n}\n\n// CRITICAL: ORS uses [lng, lat]\nconst orsRequestBody = {\n  locations: [\n    [originLng, originLat],\n    [destLng, destLat]\n  ],\n  sources: [0],\n  destinations: [1],\n  metrics: ['distance', 'duration'],\n  units: 'm'\n};\n\n// Build cache key (rounded coords for de-duplication)\nconst _roLat = Math.round(originLat * 1000) / 1000;\nconst _roLng = Math.round(originLng * 1000) / 1000;\nconst _rdLat = Math.round(destLat * 1000) / 1000;\nconst _rdLng = Math.round(destLng * 1000) / 1000;\nconst distanceCacheKey = 'dist_' + _roLat + '_' + _roLng + '_' + _rdLat + '_' + _rdLng;\n\nconsole.log('[BuildDistanceORS] CacheKey:', distanceCacheKey);\n\nreturn {\n  ...resolveData,\n  originLat, originLng, originName,\n  destLat, destLng, destName,\n  geocodeFailed: false,\n  orsRequestBody,\n  distanceCacheKey\n};"
      },
      "id": "fn-build-distance-ors",
      "name": "Fn_BuildDistanceORS",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59488,
        67600
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT response_data FROM distance_cache WHERE cache_key = '{{ $json.distanceCacheKey }}' AND expires_at > NOW() LIMIT 1;"
      },
      "id": "db-check-distance-cache",
      "name": "DB_CheckDistanceCache",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        59712,
        67600
      ],
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== DISTANCE CACHE GUARD =====\nconst items = $input.all();\nconst prevData = $('Fn_BuildDistanceORS').item.json;\n\nif (prevData.geocodeFailed) {\n  console.log('[DistanceCacheGuard] Geocode failed, skip cache');\n  return [{ json: { ...prevData, distanceCacheHit: false } }];\n}\n\nif (items.length > 0 && items[0].json && items[0].json.response_data) {\n  const cached = typeof items[0].json.response_data === 'string'\n    ? JSON.parse(items[0].json.response_data) : items[0].json.response_data;\n  console.log('[DistanceCacheGuard] CACHE HIT');\n  return [{ json: { ...cached, distanceCacheHit: true } }];\n} else {\n  console.log('[DistanceCacheGuard] CACHE MISS');\n  return [{ json: { ...prevData, distanceCacheHit: false } }];\n}"
      },
      "id": "fn-distance-cache-guard",
      "name": "Fn_DistanceCacheGuard",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59936,
        67600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "leftValue": "={{ $json.distanceCacheHit === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "if-distance-cache-hit",
      "name": "IF_DistanceCacheHit",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        60160,
        67600
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openrouteservice.org/v2/matrix/driving-car",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.orsRequestBody) }}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "http-ors-distance-calc",
      "name": "HTTP_ORS_DistanceCalc",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        60384,
        67400
      ],
      "onError": "continueRegularOutput",
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_ORS_CREDENTIAL_ID",
          "name": "ORS API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT DISTANCE RESULT =====\nconst prevData = $('Fn_BuildDistanceORS').item.json;\nconst orsResponse = $json;\n\n// Check geocode failure\nif (prevData.geocodeFailed) {\n  const failed = prevData.failedLocations || [];\n  console.log('[FormatDistance] FAIL: Geocode failed for', failed.join(', '));\n  return {\n    intent: 'GET_DISTANCE',\n    has_results: false,\n    error: 'geocode_failed',\n    failedLocations: failed,\n    response_hint: 'KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ cho: ' + failed.join(', ')\n  };\n}\n\nfunction haversine(lat1, lng1, lat2, lng2) {\n  const R = 6371;\n  const dLat = (lat2 - lat1) * Math.PI / 180;\n  const dLng = (lng2 - lng1) * Math.PI / 180;\n  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *\n    Math.sin(dLng/2) * Math.sin(dLng/2);\n  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n}\n\nconst orsDistances = orsResponse?.distances?.[0];\nconst orsDurations = orsResponse?.durations?.[0];\nconst orsOK = Array.isArray(orsDistances) && orsDistances.length > 0 && orsDistances[0] != null;\n\nlet distance_km, duration_min, distance_source;\n\nif (orsOK) {\n  distance_km = Math.round(orsDistances[0] / 100) / 10;\n  duration_min = Math.round(orsDurations[0] / 60);\n  distance_source = 'ors';\n  console.log('[FormatDistance] ORS:', distance_km, 'km,', duration_min, 'min');\n} else {\n  distance_km = Math.round(haversine(\n    prevData.originLat, prevData.originLng,\n    prevData.destLat, prevData.destLng\n  ) * 10) / 10;\n  duration_min = null;\n  distance_source = 'haversine';\n  console.log('[FormatDistance] Haversine fallback:', distance_km, 'km');\n}\n\nreturn {\n  intent: 'GET_DISTANCE',\n  distance_info: {\n    origin: { name: prevData.originName, lat: prevData.originLat, lng: prevData.originLng },\n    destination: { name: prevData.destName, lat: prevData.destLat, lng: prevData.destLng },\n    road_distance_km: distance_km,\n    drive_duration_min: duration_min,\n    distance_source\n  },\n  has_results: true\n};"
      },
      "id": "fn-format-distance",
      "name": "Fn_FormatDistance",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60608,
        67400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO distance_cache (cache_key, response_data, expires_at) SELECT '{{ $('Fn_BuildDistanceORS').item.json.distanceCacheKey }}', '{{ JSON.stringify($json).replace(/'/g, \"''\") }}'::jsonb, NOW() + INTERVAL '1 day' WHERE '{{ $json.has_results }}' = 'true' ON CONFLICT (cache_key) DO UPDATE SET response_data = EXCLUDED.response_data, expires_at = EXCLUDED.expires_at;"
      },
      "id": "db-write-distance-cache",
      "name": "DB_WriteDistanceCache",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        60832,
        67600
      ],
      "onError": "continueRegularOutput",
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "respond-final",
      "name": "Respond_Final",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        62400,
        68400
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO request_log (session_id, intent, latency_ms, cache_hit_weather, cache_hit_distance, knowledge_hit, fallback_triggered, clarification_triggered, error_type) VALUES ('{{ $json._log ? $json._log.sessionId : \"unknown\" }}', '{{ $json._log ? $json._log.intent : \"UNKNOWN\" }}', {{ $json._log ? ($json._log.latencyMs || 0) : 0 }}, {{ $json._log ? $json._log.cacheHitWeather : false }}, {{ $json._log ? $json._log.cacheHitDistance : false }}, {{ $json._log ? $json._log.knowledgeHit : false }}, {{ $json._log ? $json._log.fallbackTriggered : false }}, {{ $json._log ? $json._log.clarificationTriggered : false }}, {{ $json._log && $json._log.errorType ? \"'\" + $json._log.errorType + \"'\" : 'NULL' }});"
      },
      "id": "db-write-request-log",
      "name": "DB_WriteRequestLog",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        62624,
        68600
      ],
      "onError": "continueRegularOutput",
      "credentials": {
        "postgres": {
          "id": "YOUR_POSTGRES_CREDENTIAL_ID",
          "name": "POI Override DB"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== DIRECT RESPONSE FORMATTER =====\n// Deterministic template-based responses â€” NO AI, NO external API\n// Handles all 7 intents with structured templates\n// Follows instruction: \"AI Does ONLY 2 Things: Choose intent + Extract entities\"\n\nconst data = $json;\nconst intent = data.intent || 'UNKNOWN';\n\n// â”€â”€â”€ Metrics â”€â”€â”€\nlet _st = null, _sid = null;\ntry { _st = $('Fn_NormalizeInput').item.json._startTime; _sid = $('Fn_NormalizeInput').item.json.sessionId; } catch(e) {}\n\nlet _cacheWeather = false, _cacheDist = false, _knowledge = false;\ntry { _cacheWeather = !!$('Fn_WeatherCacheGuard').item.json._cacheHit; } catch(e) {}\ntry { _cacheDist = !!$('Fn_DistanceCacheGuard').item.json.distanceCacheHit; } catch(e) {}\ntry { _knowledge = data.source === 'knowledge_db'; } catch(e) {}\n\nfunction buildLog(extra) {\n  return {\n    sessionId: _sid || 'unknown',\n    intent,\n    latencyMs: _st ? Date.now() - _st : 0,\n    cacheHitWeather: _cacheWeather,\n    cacheHitDistance: _cacheDist,\n    knowledgeHit: _knowledge,\n    fallbackTriggered: false,\n    clarificationTriggered: false,\n    errorType: null,\n    ...(extra || {})\n  };\n}\n\nlet response = '';\nlet need_tool = true;\nlet tool_name = null;\nlet tool_input = {};\n\nswitch (intent) {\n\n  // â•â•â•â•â•â•â•â•â•â•â• GET_PLACE_INFO â•â•â•â•â•â•â•â•â•â•â•\n  case 'GET_PLACE_INFO': {\n    const p = data.place_info || {};\n    tool_name = data.source === 'knowledge_db' ? 'DB_PlaceMetadataLookup' : 'HTTP_SearchPlaceInfo';\n    tool_input = { place_name: p.name };\n\n    if (!p.name && !p.description) {\n      response = 'KhÃ´ng tÃ¬m tháº¥y thÃ´ng tin cho Ä‘á»‹a Ä‘iá»ƒm nÃ y. Vui lÃ²ng thá»­ láº¡i vá»›i tÃªn cá»¥ thá»ƒ hÆ¡n.';\n      break;\n    }\n\n    const parts = ['ðŸ“ **' + (p.name || 'Äá»‹a Ä‘iá»ƒm') + '**'];\n    if (p.description) parts.push('\\n' + p.description);\n    if (p.ticket_price) parts.push('\\nðŸŽ« **GiÃ¡ vÃ©**: ' + p.ticket_price);\n    else parts.push('\\nðŸŽ« **GiÃ¡ vÃ©**: ChÆ°a cÃ³ thÃ´ng tin chÃ­nh thá»©c');\n    if (p.opening_hours) parts.push('\\nðŸ• **Giá» má»Ÿ cá»­a**: ' + p.opening_hours);\n    if (p.open_status_text) parts.push('\\nðŸ“Œ ' + p.open_status_text);\n    if (p.address) parts.push('\\nðŸ“« **Äá»‹a chá»‰**: ' + p.address);\n    if (data.source === 'knowledge_db') parts.push('\\n\\n_Nguá»“n: CÆ¡ sá»Ÿ dá»¯ liá»‡u ná»™i bá»™_');\n    parts.push('\\n\\nBáº¡n muá»‘n biáº¿t thÃªm gÃ¬ vá» Ä‘á»‹a Ä‘iá»ƒm nÃ y?');\n    response = parts.join('');\n    break;\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â• GET_WEATHER â•â•â•â•â•â•â•â•â•â•â•\n  case 'GET_WEATHER': {\n    const loc = data.location || 'khu vá»±c';\n\n    if (data.isForecast) {\n      // â”€â”€ Forecast â”€â”€\n      const forecast = data.forecast_raw || [];\n      tool_name = 'HTTP_GetWeatherForecast';\n      tool_input = { location: loc, days: forecast.length };\n\n      if (forecast.length === 0) {\n        response = 'KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u dá»± bÃ¡o thá»i tiáº¿t cho **' + loc + '**.';\n        break;\n      }\n\n      const parts = ['ðŸŒ¤ï¸ **Dá»± bÃ¡o thá»i tiáº¿t ' + loc + '** (' + (data.timeDescription || '') + '):'];\n      if (data.current_snapshot) {\n        const c = data.current_snapshot;\n        parts.push('\\nðŸ“Œ Hiá»‡n táº¡i: ' + c.temp_c + 'Â°C, ' + c.condition + ', Ä‘á»™ áº©m ' + c.humidity + '%');\n      }\n      for (const day of forecast) {\n        let line = '\\nðŸ“… **' + day.date + '**: ' + day.mintemp_c + 'Â°C - ' + day.maxtemp_c + 'Â°C, ' + day.condition;\n        if (day.chance_of_rain > 30) line += ' | ðŸŒ§ï¸ ' + day.chance_of_rain + '% mÆ°a';\n        if (day.uv != null && day.uv >= 6) line += ' | â˜€ï¸ UV: ' + day.uv + ' (cao)';\n        parts.push(line);\n      }\n      parts.push('\\n\\nBáº¡n cáº§n chuáº©n bá»‹ gÃ¬ cho chuyáº¿n Ä‘i?');\n      response = parts.join('');\n\n    } else {\n      // â”€â”€ Current weather â”€â”€\n      const w = data.weather_raw;\n      tool_name = 'HTTP_GetWeather';\n      tool_input = { location: loc };\n\n      if (!w) {\n        response = 'KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u thá»i tiáº¿t cho **' + loc + '**.';\n        break;\n      }\n\n      const parts = ['ðŸŒ¡ï¸ **Thá»i tiáº¿t ' + loc + (data.localtime ? ' (' + data.localtime + ')' : '') + '**:'];\n      parts.push('\\nðŸŒ¡ï¸ Nhiá»‡t Ä‘á»™: ' + w.temp_c + 'Â°C (cáº£m giÃ¡c ' + w.feelslike_c + 'Â°C)');\n      parts.push('\\nðŸŒ¤ï¸ TÃ¬nh tráº¡ng: ' + w.condition);\n      parts.push('\\nðŸ’§ Äá»™ áº©m: ' + w.humidity + '%');\n      parts.push('\\nðŸ’¨ GiÃ³: ' + w.wind_kph + ' km/h, hÆ°á»›ng ' + w.wind_dir);\n      if (w.precip_mm > 0) parts.push('\\nðŸŒ§ï¸ LÆ°á»£ng mÆ°a: ' + w.precip_mm + 'mm');\n      if (w.uv != null) {\n        parts.push('\\nâ˜€ï¸ UV: ' + w.uv);\n        if (w.uv >= 6) parts.push(' âš ï¸ NÃªn che cháº¯n khi ra ngoÃ i');\n      }\n      if (w.air_quality) {\n        const aq = w.air_quality;\n        parts.push('\\nðŸŒ«ï¸ KhÃ´ng khÃ­: PM2.5: ' + aq.pm2_5 + ' (' + aq.label + ')');\n        if (aq.pm2_5 > 35) parts.push(' âš ï¸ NÃªn háº¡n cháº¿ hoáº¡t Ä‘á»™ng ngoÃ i trá»i');\n      }\n      parts.push('\\n\\nBáº¡n muá»‘n xem dá»± bÃ¡o nhá»¯ng ngÃ y tá»›i khÃ´ng?');\n      response = parts.join('');\n    }\n    break;\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â• GET_DISTANCE â•â•â•â•â•â•â•â•â•â•â•\n  case 'GET_DISTANCE': {\n    const d = data.distance_info;\n\n    if (data.error === 'geocode_failed') {\n      const failed = data.failedLocations || [];\n      response = 'KhÃ´ng tÃ¬m tháº¥y tá»a Ä‘á»™ cho: ' + failed.join(', ') + '.\\n\\nVui lÃ²ng thá»­ ghi rÃµ hÆ¡n, vÃ­ dá»¥: \"Tá»« HÃ  Ná»™i Ä‘áº¿n ÄÃ  Náºµng\"';\n      need_tool = false;\n      break;\n    }\n\n    if (!d) {\n      response = 'KhÃ´ng tÃ­nh Ä‘Æ°á»£c khoáº£ng cÃ¡ch. Vui lÃ²ng thá»­ láº¡i.';\n      need_tool = false;\n      break;\n    }\n\n    tool_name = d.distance_source === 'ors' ? 'HTTP_ORS_DistanceCalc' : 'haversine';\n    tool_input = { origin: d.origin && d.origin.name, destination: d.destination && d.destination.name };\n\n    const oName = (d.origin && d.origin.name) || '?';\n    const dName = (d.destination && d.destination.name) || '?';\n    const parts = ['ðŸ“ **Khoáº£ng cÃ¡ch tá»« ' + oName + ' Ä‘áº¿n ' + dName + '**:'];\n\n    if (d.distance_source === 'ors') {\n      parts.push('\\nðŸ›£ï¸ ÄÆ°á»ng bá»™: **' + d.road_distance_km + ' km**');\n      if (d.drive_duration_min) {\n        const hours = Math.floor(d.drive_duration_min / 60);\n        const mins = d.drive_duration_min % 60;\n        const timeStr = hours > 0 ? hours + ' giá» ' + mins + ' phÃºt' : mins + ' phÃºt';\n        parts.push('\\nâ±ï¸ Thá»i gian lÃ¡i xe: khoáº£ng **' + timeStr + '**');\n      }\n    } else {\n      parts.push('\\nâœˆï¸ ÄÆ°á»ng chim bay: **' + d.road_distance_km + ' km**');\n      parts.push('\\n_LÆ°u Ã½: Khoáº£ng cÃ¡ch thá»±c táº¿ Ä‘Æ°á»ng bá»™ cÃ³ thá»ƒ dÃ i hÆ¡n._');\n    }\n\n    parts.push('\\n\\nBáº¡n muá»‘n tÃ¬m hiá»ƒu thÃªm gÃ¬ vá» lá»™ trÃ¬nh nÃ y?');\n    response = parts.join('');\n    break;\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â• SEARCH_NEARBY â•â•â•â•â•â•â•â•â•â•â•\n  case 'SEARCH_NEARBY': {\n    const places = data.nearby_raw || [];\n    tool_name = 'HTTP_SearchNearby';\n    tool_input = { poi_type: data.poiType };\n\n    if (places.length === 0) {\n      response = 'KhÃ´ng tÃ¬m tháº¥y ' + (data.poiType || 'Ä‘á»‹a Ä‘iá»ƒm') + ' nÃ o xung quanh báº¡n.';\n      break;\n    }\n\n    const top = places.slice(0, 5);\n    const parts = ['ðŸ“ **' + top.length + ' ' + (data.poiType || 'Ä‘á»‹a Ä‘iá»ƒm') + ' gáº§n báº¡n**:'];\n\n    for (const p of top) {\n      let line = '\\n' + p.rank + '. **' + p.name + '**';\n      if (p.road_distance_km != null) {\n        if (p.distance_source === 'ors') {\n          line += ' - ' + p.road_distance_km + ' km';\n          if (p.drive_duration_min) line += ' (~' + p.drive_duration_min + ' phÃºt)';\n        } else if (p.distance_source === 'haversine') {\n          line += ' - ' + p.road_distance_km + ' km (Ä‘Æ°á»ng chim bay)';\n        }\n      }\n      if (p.rating) line += ' â­ ' + p.rating;\n      if (p.address) line += '\\n   ðŸ“« ' + p.address;\n      parts.push(line);\n    }\n\n    parts.push('\\n\\nBáº¡n muá»‘n biáº¿t thÃªm vá» Ä‘á»‹a Ä‘iá»ƒm nÃ o?');\n    response = parts.join('');\n    break;\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â• SEARCH_TOUR â•â•â•â•â•â•â•â•â•â•â•\n  case 'SEARCH_TOUR': {\n    const tours = data.tours_raw || [];\n    tool_name = 'HTTP_SearchTour';\n    tool_input = { location: data.location, duration: data.duration };\n\n    if (tours.length === 0) {\n      response = 'KhÃ´ng tÃ¬m tháº¥y tour' + (data.location ? ' táº¡i ' + data.location : '') + '.';\n      break;\n    }\n\n    const dur = data.duration ? ' ' + data.duration + ' ngÃ y' : '';\n    const loc = data.location ? ' ' + data.location : '';\n    const parts = ['ðŸ§³ **Tour' + dur + loc + '**:'];\n\n    for (let i = 0; i < tours.length; i++) {\n      const t = tours[i];\n      parts.push('\\n' + (i + 1) + '. **' + t.title + '**');\n      if (t.snippet) parts.push('\\n   ' + t.snippet.substring(0, 150));\n      if (t.provider) parts.push('\\n   ðŸ“Ž ' + t.provider);\n    }\n\n    parts.push('\\n\\nBáº¡n muá»‘n xem chi tiáº¿t tour nÃ o?');\n    response = parts.join('');\n    break;\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â• SEARCH_HOTEL â•â•â•â•â•â•â•â•â•â•â•\n  case 'SEARCH_HOTEL': {\n    const hotels = data.hotels_raw || [];\n    tool_name = 'HTTP_SearchHotel';\n    tool_input = { location: data.location };\n\n    if (hotels.length === 0) {\n      response = 'KhÃ´ng tÃ¬m tháº¥y khÃ¡ch sáº¡n' + (data.location ? ' táº¡i ' + data.location : '') + '.';\n      break;\n    }\n\n    const parts = ['ðŸ¨ **KhÃ¡ch sáº¡n' + (data.location ? ' táº¡i ' + data.location : '') + '**:'];\n\n    for (let i = 0; i < hotels.length; i++) {\n      const h = hotels[i];\n      let line = '\\n' + (i + 1) + '. **' + h.name + '**';\n      if (h.rating) line += ' â­ ' + h.rating;\n      if (h.price) line += ' | ðŸ’° ' + h.price;\n      if (h.address) line += '\\n   ðŸ“« ' + h.address;\n      parts.push(line);\n    }\n\n    parts.push('\\n\\nBáº¡n muá»‘n biáº¿t thÃªm vá» khÃ¡ch sáº¡n nÃ o?');\n    response = parts.join('');\n    break;\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â• SEARCH_POI â•â•â•â•â•â•â•â•â•â•â•\n  case 'SEARCH_POI': {\n    const pois = data.poi_raw || [];\n    tool_name = 'HTTP_SearchPOI';\n    tool_input = { location: data.location };\n\n    if (pois.length === 0) {\n      response = 'KhÃ´ng tÃ¬m tháº¥y Ä‘iá»ƒm tham quan' + (data.location ? ' táº¡i ' + data.location : '') + '.';\n      break;\n    }\n\n    const parts = ['ðŸžï¸ **Äiá»ƒm tham quan' + (data.location ? ' ' + data.location : '') + '**:'];\n\n    for (let i = 0; i < pois.length; i++) {\n      const p = pois[i];\n      parts.push('\\n' + (i + 1) + '. **' + p.name + '**');\n      if (p.short_fact) parts.push('\\n   ' + p.short_fact.substring(0, 150));\n    }\n\n    parts.push('\\n\\nBáº¡n muá»‘n biáº¿t chi tiáº¿t vá» Ä‘á»‹a Ä‘iá»ƒm nÃ o?');\n    response = parts.join('');\n    break;\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â• DEFAULT â•â•â•â•â•â•â•â•â•â•â•\n  default: {\n    response = 'Xin lá»—i, tÃ´i chÆ°a há»— trá»£ yÃªu cáº§u nÃ y.\\n\\nTÃ´i cÃ³ thá»ƒ giÃºp:\\nðŸŒ¦ï¸ Thá»i tiáº¿t\\nðŸ“ ThÃ´ng tin Ä‘á»‹a Ä‘iá»ƒm\\nðŸžï¸ Äiá»ƒm tham quan\\nðŸ§³ Tour du lá»‹ch\\nðŸ¨ KhÃ¡ch sáº¡n\\nðŸ“ Khoáº£ng cÃ¡ch\\nðŸ“ TÃ¬m gáº§n tÃ´i';\n    need_tool = false;\n  }\n}\n\nreturn {\n  intent,\n  need_tool,\n  tool_name,\n  tool_input,\n  response_to_user: response,\n  response,\n  type: data.has_results !== false ? 'success' : 'no_results',\n  _log: buildLog()\n};"
      },
      "id": "fn-direct-response-formatter",
      "name": "Fn_DirectResponseFormatter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61728,
        68400
      ]
    }
  ],
  "connections": {
    "Webhook_ReceiveMessage": {
      "main": [
        [
          {
            "node": "Fn_NormalizeInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_NormalizeInput": {
      "main": [
        [
          {
            "node": "Fn_DetectIntentRuleBased",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_DetectIntentRuleBased": {
      "main": [
        [
          {
            "node": "Fn_CheckRequiredSlots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_CheckRequiredSlots": {
      "main": [
        [
          {
            "node": "IF_NeedClarification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_NeedClarification": {
      "main": [
        [
          {
            "node": "Respond_Clarify",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch_Pipeline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_Clarify": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB_WriteRequestLog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_Pipeline": {
      "main": [
        [
          {
            "node": "Fn_ExtractLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ResolvePlaceName",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_BuildNearbySearch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ParseTourDuration",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ExtractDistanceEntities",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ExtractLocation": {
      "main": [
        [
          {
            "node": "IF_LocationValid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_LocationValid": {
      "main": [
        [
          {
            "node": "Fn_NormalizeAlias",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_LocationInvalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_LocationInvalid": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB_WriteRequestLog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_NormalizeAlias": {
      "main": [
        [
          {
            "node": "DB_POI_Lookup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB_POI_Lookup": {
      "main": [
        [
          {
            "node": "Fn_DBResultGuard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_DBResultGuard": {
      "main": [
        [
          {
            "node": "IF_DBMatch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_DBMatch": {
      "main": [
        [
          {
            "node": "Fn_UseDBResult",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_Geocode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_UseDBResult": {
      "main": [
        [
          {
            "node": "Switch_RouteToAPI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_Geocode": {
      "main": [
        [
          {
            "node": "Fn_ParseGeocode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseGeocode": {
      "main": [
        [
          {
            "node": "IF_GeocodeSuccess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_GeocodeSuccess": {
      "main": [
        [
          {
            "node": "Switch_RouteToAPI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_GeocodeFailed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_GeocodeFailed": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB_WriteRequestLog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_RouteToAPI": {
      "main": [
        [
          {
            "node": "HTTP_SearchPOI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_NormalizeWeatherTime",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchHotel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ResolvePlaceName": {
      "main": [
        [
          {
            "node": "Fn_NormalizePlaceAlias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_NormalizePlaceAlias": {
      "main": [
        [
          {
            "node": "DB_PlaceMetadataLookup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB_PlaceMetadataLookup": {
      "main": [
        [
          {
            "node": "Fn_PlaceMetadataGuard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_PlaceMetadataGuard": {
      "main": [
        [
          {
            "node": "IF_HasPlaceMetadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_HasPlaceMetadata": {
      "main": [
        [
          {
            "node": "Fn_FormatPlaceFromDB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatPlaceFromDB": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchPlaceInfo": {
      "main": [
        [
          {
            "node": "Fn_FormatPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatPlaceInfo": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_BuildNearbySearch": {
      "main": [
        [
          {
            "node": "HTTP_SearchNearby",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchNearby": {
      "main": [
        [
          {
            "node": "Fn_FormatNearbyAndBuildORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatNearbyAndBuildORS": {
      "main": [
        [
          {
            "node": "HTTP_ORS_Matrix",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_ORS_Matrix": {
      "main": [
        [
          {
            "node": "Fn_EnrichWithDistances",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_EnrichWithDistances": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseTourDuration": {
      "main": [
        [
          {
            "node": "HTTP_SearchTour",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchTour": {
      "main": [
        [
          {
            "node": "Fn_FormatTour",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatTour": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchPOI": {
      "main": [
        [
          {
            "node": "Fn_FormatPOI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatPOI": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_NormalizeWeatherTime": {
      "main": [
        [
          {
            "node": "DB_CheckWeatherCache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB_CheckWeatherCache": {
      "main": [
        [
          {
            "node": "Fn_WeatherCacheGuard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_WeatherCacheGuard": {
      "main": [
        [
          {
            "node": "Switch_WeatherMode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_WeatherMode": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_GetWeatherForecast",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_GetWeather",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_GetWeather": {
      "main": [
        [
          {
            "node": "Fn_FormatWeather",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_GetWeatherForecast": {
      "main": [
        [
          {
            "node": "Fn_FormatWeatherForecast",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatWeather": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB_WriteWeatherCache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatWeatherForecast": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB_WriteWeatherCache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchHotel": {
      "main": [
        [
          {
            "node": "Fn_FormatHotel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatHotel": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ExtractDistanceEntities": {
      "main": [
        [
          {
            "node": "DB_DistancePOILookup",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB_DistancePOILookup": {
      "main": [
        [
          {
            "node": "Fn_ResolveDistanceCoords",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ResolveDistanceCoords": {
      "main": [
        [
          {
            "node": "IF_AllCoordsResolved",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_AllCoordsResolved": {
      "main": [
        [
          {
            "node": "Fn_BuildDistanceORS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_GeocodeOrigin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_GeocodeOrigin": {
      "main": [
        [
          {
            "node": "HTTP_GeocodeDestination",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_GeocodeDestination": {
      "main": [
        [
          {
            "node": "Fn_BuildDistanceORS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_BuildDistanceORS": {
      "main": [
        [
          {
            "node": "DB_CheckDistanceCache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB_CheckDistanceCache": {
      "main": [
        [
          {
            "node": "Fn_DistanceCacheGuard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_DistanceCacheGuard": {
      "main": [
        [
          {
            "node": "IF_DistanceCacheHit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_DistanceCacheHit": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_ORS_DistanceCalc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_ORS_DistanceCalc": {
      "main": [
        [
          {
            "node": "Fn_FormatDistance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatDistance": {
      "main": [
        [
          {
            "node": "Fn_DirectResponseFormatter",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB_WriteDistanceCache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_DirectResponseFormatter": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          },
          {
            "node": "DB_WriteRequestLog",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v2",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "executionTimeout": 120
  },
  "meta": {
    "instanceId": "8298d6d82438e8d5ee28189bff4aaace26c9e5a75151cb6d6f4c18d7bb992ea7"
  }
}