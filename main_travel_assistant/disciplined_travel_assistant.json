{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "disciplined-travel",
        "responseMode": "lastNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "61bf2a25-6106-4059-9c7d-16c4fd853e25",
      "name": "Webhook_ReceiveMessage",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        56800,
        68400
      ],
      "webhookId": "disciplined-travel"
    },
    {
      "parameters": {
        "jsCode": "// ===== NORMALIZE INPUT =====\n// Mission: Clean ONLY, kh√¥ng s·ª≠a nghƒ©a\n// ‚ö° FIX: X·ª≠ l√Ω m·ªçi c√°ch n8n tr·∫£ data t·ª´ webhook\n\n// n8n webhook tr·∫£ data trong $json.body\nconst body = $json.body || {};\nconst query = $json.query || {};\nconst headers = $json.headers || {};\n\n// Get or generate sessionId\nlet sessionId = body.sessionId || query.sessionId || headers['x-session-id'];\nif (!sessionId) {\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 15);\n  sessionId = `sess_${timestamp}_${random}`;\n}\n\n// Extract message t·ª´ body\nconst message = String(body.message || '').trim();\nconst messageLower = message.toLowerCase();\n\n// Nh·∫≠n user_location t·ª´ client (cho Nearby)\nconst userLocation = body.user_location || null;\n\nreturn {\n  sessionId,\n  message,\n  messageLower,\n  userLocation\n};"
      },
      "id": "d1dd8dc6-c5a1-4739-a831-e70ae7bfa4ae",
      "name": "Fn_NormalizeInput",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57024,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.messageLower }}",
              "rightValue": "du l·ªãch|ƒë·ªãa ƒëi·ªÉm|tham quan|ƒëi ch∆°i|ƒëi ƒë√¢u|th·ªùi ti·∫øt|kh√°ch s·∫°n|hotel|weather|attraction|tour|g·∫ßn t√¥i|quanh t√¥i|gi√° v√©|gi·ªù m·ªü c·ª≠a|th√¥ng tin|h√†nh tr√¨nh|ng√†y",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "6dd02752-a823-4850-b3b9-27d87d26a203",
      "name": "IF_IsTravelDomain",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        57248,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: 'Hi·ªán t·∫°i t√¥i h·ªó tr·ª£:\\n\\nüìç Th√¥ng tin ƒë·ªãa ƒëi·ªÉm (gi√° v√©, gi·ªù m·ªü c·ª≠a)\\nüèûÔ∏è T√¨m ƒë·ªãa ƒëi·ªÉm du l·ªãch\\nüèöÔ∏è T√¨m kh√°ch s·∫°n\\nüß≥ T√¨m tour tr·ªçn g√≥i\\nüå¶Ô∏è Xem th·ªùi ti·∫øt\\nüìç T√¨m g·∫ßn t√¥i\\n\\nV√≠ d·ª•: \"Th√¥ng tin ƒë·ªÅn Th√°i Vi\" ho·∫∑c \"3 ƒëi·ªÉm du l·ªãch g·∫ßn t√¥i\"',\n  type: 'out_of_scope'\n};"
      },
      "id": "dfaba99e-ddd3-40f9-80cd-2360487bdcc5",
      "name": "Respond_OutOfScope",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        69200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== RULE-BASED INTENT DETECTION =====\n// Mission: Ph√¢n lo·∫°i intent b·∫±ng keyword, KH√îNG AI\n// ‚ö° TH√äM: GET_PLACE_INFO, SEARCH_NEARBY, SEARCH_TOUR\n\nconst msg = $json.messageLower;\nconst prevData = $json;\n\nlet intent = 'UNKNOWN';\nlet confidence = 'low';\n\n// ===== PRIORITY ORDER (quan tr·ªçng!) =====\n\n// 1Ô∏è‚É£ SEARCH_NEARBY - ∆Øu ti√™n cao nh·∫•t\nif (\n  msg.includes('g·∫ßn t√¥i') ||\n  msg.includes('quanh t√¥i') ||\n  msg.includes('xung quanh t√¥i') ||\n  msg.includes('g·∫ßn ƒë√¢y') ||\n  msg.includes('near me') ||\n  msg.includes('nearby')\n) {\n  intent = 'SEARCH_NEARBY';\n  confidence = 'high';\n}\n\n// 2Ô∏è‚É£ GET_PLACE_INFO - Th√¥ng tin chi ti·∫øt\nelse if (\n  msg.includes('gi√° v√©') ||\n  msg.includes('gi·ªù m·ªü c·ª≠a') ||\n  msg.includes('th√¥ng tin') ||\n  msg.includes('m·ªü c·ª≠a l√∫c') ||\n  msg.includes('v√© v√†o') ||\n  msg.includes('ph√≠ tham quan') ||\n  msg.includes('mi·ªÖn ph√≠') ||\n  msg.includes('m·∫•t ph√≠')\n) {\n  intent = 'GET_PLACE_INFO';\n  confidence = 'high';\n}\n\n// 3Ô∏è‚É£ SEARCH_TOUR - Tour du l·ªãch\nelse if (\n  msg.includes('tour ') ||\n  msg.match(/\\d+\\s*ng√†y/) ||  // \"5 ng√†y\", \"3ng√†y\"\n  msg.includes('h√†nh tr√¨nh') ||\n  msg.includes('l·ªãch tr√¨nh') ||\n  msg.includes('chuy·∫øn ƒëi')\n) {\n  intent = 'SEARCH_TOUR';\n  confidence = 'high';\n}\n\n// 4Ô∏è‚É£ GET_WEATHER - Th·ªùi ti·∫øt\nelse if (\n  msg.includes('th·ªùi ti·∫øt') ||\n  msg.includes('weather') ||\n  msg.includes('m∆∞a') ||\n  msg.includes('n·∫Øng') ||\n  msg.includes('nhi·ªát ƒë·ªô') ||\n  msg.includes('ƒë·ªô c')\n) {\n  intent = 'GET_WEATHER';\n  confidence = 'high';\n}\n\n// 5Ô∏è‚É£ SEARCH_HOTEL - Kh√°ch s·∫°n\nelse if (\n  msg.includes('kh√°ch s·∫°n') ||\n  msg.includes('hotel') ||\n  msg.includes('ph√≤ng ngh·ªâ') ||\n  msg.includes('homestay') ||\n  msg.includes('resort') ||\n  msg.includes('nh√† ngh·ªâ')\n) {\n  intent = 'SEARCH_HOTEL';\n  confidence = 'high';\n}\n\n// 6Ô∏è‚É£ SEARCH_POI - ƒê·ªãa ƒëi·ªÉm du l·ªãch (default cho travel domain)\nelse if (\n  msg.includes('ƒë·ªãa ƒëi·ªÉm') ||\n  msg.includes('tham quan') ||\n  msg.includes('du l·ªãch') ||\n  msg.includes('ƒëi ch∆°i') ||\n  msg.includes('ƒëi ƒë√¢u') ||\n  msg.includes('attraction')\n) {\n  intent = 'SEARCH_POI';\n  confidence = 'high';\n}\n\nreturn {\n  sessionId: prevData.sessionId,\n  message: prevData.message,\n  messageLower: prevData.messageLower,\n  userLocation: prevData.userLocation,\n  intent,\n  confidence\n};"
      },
      "id": "af8b5ae1-rule-based-intent",
      "name": "Fn_DetectIntentRuleBased",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57472,
        68304
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== CHECK REQUIRED SLOTS (STRICT, NO GUESS) =====\n// Mission: Check d·ªØ li·ªáu c√≥ s·∫µn - KH√îNG t·∫°o default\n// ‚ö° AGODA-STYLE: Location = placeName HO·∫∂C userLocation (ch∆∞a c·∫ßn lat/lng)\n\nconst data = $json;\nconst message = data.messageLower || '';\nconst intent = data.intent || 'UNKNOWN';\n\n// ‚úÖ LU√îN ƒê·ªåC T·ª™ $json\nconst userLocation = data.userLocation || null;\n\n// ---- CHECK PLACE NAME (explicit text) ----\nconst hasPlaceName =\n  message.includes('ƒë·ªÅn') ||\n  message.includes('ch√πa') ||\n  message.includes('nh√† th·ªù') ||\n  message.includes('b·∫£o t√†ng') ||\n  message.includes('lƒÉng') ||\n  message.includes('h·ªì ') ||\n  message.includes('n√∫i ') ||\n  message.includes('bi·ªÉn');\n\n// ---- CHECK LOCATION HINT (city/area names) ----\nconst hasLocationHint =\n  message.includes('·ªü ') ||\n  message.includes('t·∫°i ') ||\n  message.includes('g·∫ßn ') ||\n  message.includes('quanh ') ||\n  message.includes('xung quanh ') ||\n  message.includes('khu v·ª±c ') ||\n  message.includes('h√† n·ªôi') ||\n  message.includes('s√†i g√≤n') ||\n  message.includes('ƒë√† n·∫µng') ||\n  message.includes('ninh b√¨nh');\n\n// ---- CHECK \"G·∫¶N T√îI\" ----\nconst isNearMe =\n  message.includes('g·∫ßn t√¥i') ||\n  message.includes('quanh t√¥i') ||\n  message.includes('xung quanh t√¥i') ||\n  message.includes('g·∫ßn ƒë√¢y');\n\n// ---- CHECK USER LOCATION AVAILABLE ----\nconst hasUserLocation = !!(userLocation && userLocation.lat && userLocation.lng);\n\n// ---- CHECK TIME ----\nconst hasTimeHint =\n  message.includes('h√¥m nay') ||\n  message.includes('cu·ªëi tu·∫ßn') ||\n  message.includes('ng√†y mai') ||\n  message.includes('tu·∫ßn n√†y');\n\n// ---- CHECK TOUR DURATION ----\nconst durationMatch = message.match(/(\\d+)\\s*ng√†y/);\nconst tourDuration = durationMatch ? parseInt(durationMatch[1]) : null;\n\n// ---- SLOT VALIDATION - AGODA LOGIC ----\nlet missingSlots = [];\nlet needClarification = false;\n\n// üî• SEARCH_POI / SEARCH_NEARBY - Ch·∫•p nh·∫≠n place name HO·∫∂C userLocation HO·∫∂C isNearMe\nif (intent === 'SEARCH_POI' || intent === 'SEARCH_NEARBY') {\n  // ‚úÖ C√≥ √≠t nh·∫•t 1 trong 4 ngu·ªìn location l√† H·ª¢P L·ªÜ:\n  // 1. Place name (\"H·ªì G∆∞∆°m\", \"ƒê·ªÅn Th√°i Vi\")\n  // 2. Location hint (\"g·∫ßn H√† N·ªôi\", \"·ªü ƒê√† N·∫µng\")\n  // 3. User location (lat/lng t·ª´ device)\n  // 4. \"G·∫ßn t√¥i\" (s·∫Ω xin quy·ªÅn sau)\n  const hasAnyLocationSource = hasPlaceName || hasLocationHint || hasUserLocation || isNearMe;\n  \n  if (!hasAnyLocationSource) {\n    missingSlots.push('location');\n    needClarification = true;\n  } else {\n    // ‚úÖ C√≥ ngu·ªìn location ‚Üí workflow ti·∫øp t·ª•c\n    needClarification = false;\n  }\n}\n// GET_PLACE_INFO - Ch·ªâ c·∫ßn place name\nelse if (intent === 'GET_PLACE_INFO') {\n  if (!hasPlaceName) {\n    missingSlots.push('placeName');\n    needClarification = true;\n  }\n}\n// GET_WEATHER - C·∫ßn location hint\nelse if (intent === 'GET_WEATHER') {\n  if (!hasLocationHint && !hasPlaceName) {\n    missingSlots.push('location');\n    needClarification = true;\n  }\n}\n// SEARCH_HOTEL - C·∫ßn location hint\nelse if (intent === 'SEARCH_HOTEL') {\n  if (!hasLocationHint) {\n    missingSlots.push('location');\n    needClarification = true;\n  }\n}\n// SEARCH_TOUR - C·∫ßn duration\nelse if (intent === 'SEARCH_TOUR') {\n  if (!tourDuration) {\n    missingSlots.push('duration');\n    needClarification = true;\n  }\n}\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  messageLower: data.messageLower,\n  userLocation: data.userLocation,\n  intent: data.intent,\n  confidence: data.confidence,\n  hasLocationHint,\n  isNearMe,\n  hasUserLocation,\n  hasPlaceName,\n  hasTimeHint,\n  tourDuration,\n  missingSlots,\n  needClarification\n};"
      },
      "id": "6661cacf-8468-4fc4-a8c7-2194fee08157",
      "name": "Fn_CheckRequiredSlots",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57696,
        68304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.needClarification }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "78a1e412-7eed-4b7e-9471-7f72c8f92e3c",
      "name": "IF_NeedIntentClarification",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        57920,
        68304
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== GUIDE USER (AGODA-STYLE) =====\n// Mission: Xoay user v·ªÅ h∆∞·ªõng r√µ r√†ng - KH√îNG h·ªèi m∆° h·ªì\n\nreturn {\n  response: 'B·∫°n ƒëang mu·ªën:\\n\\nüìç Xem th√¥ng tin ƒë·ªãa ƒëi·ªÉm (gi√° v√©, gi·ªù m·ªü c·ª≠a)\\nüèûÔ∏è T√¨m ƒë·ªãa ƒëi·ªÉm du l·ªãch\\nüèöÔ∏è T√¨m kh√°ch s·∫°n\\nüß≥ T√¨m tour tr·ªçn g√≥i\\nüå¶Ô∏è Xem th·ªùi ti·∫øt\\nüìç T√¨m ƒëi·ªÉm g·∫ßn t√¥i\\n\\nV√≠ d·ª•: \"Th√¥ng tin ƒë·ªÅn Th√°i Vi\" ho·∫∑c \"T√¨m 3 ƒëi·ªÉm du l·ªãch g·∫ßn t√¥i\"',\n  type: 'guide_user'\n};"
      },
      "id": "75036388-2e81-49ee-ae1a-652ee1c16f20",
      "name": "Respond_ClarifyIntent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        69008
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_NEARBY",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Nearby"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_TOUR",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Tour"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "GET_PLACE_INFO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PlaceInfo"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "switch-special-intent",
      "name": "Switch_SpecialIntent",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        58144,
        68208
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasUserLocation }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "if-nearby-no-location",
      "name": "IF_Nearby_NoLocation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58368,
        67904
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: 'üìç ƒê·ªÉ t√¨m ƒë·ªãa ƒëi·ªÉm g·∫ßn b·∫°n, vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ c·ªßa b·∫°n.\\n\\nB·∫°n c√≥ th·ªÉ:\\n1. B·∫≠t ƒë·ªãnh v·ªã tr√™n thi·∫øt b·ªã\\n2. Ho·∫∑c cho bi·∫øt khu v·ª±c b·∫°n ƒëang ·ªü (VD: \"Qu·∫≠n 1 S√†i G√≤n\")',\n  type: 'request_location_permission',\n  require_location: true\n};"
      },
      "id": "respond-request-location",
      "name": "Respond_RequestLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        67712
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== BUILD NEARBY SEARCH (AGODA-STYLE) =====\n// Mission: X√¢y d·ª±ng query t√¨m ki·∫øm theo t·ªça ƒë·ªô user\n// ‚ö° CH·ªà ·ªü ƒê√ÇY m·ªõi fallback default coords (SAU KHI bi·∫øt intent)\n\nconst data = $json;\n\n// Fallback default coords n·∫øu client kh√¥ng g·ª≠i\nconst finalUserLocation = (!data.userLocation || !data.userLocation.lat || !data.userLocation.lng) \n  ? { lat: 21.0285, lng: 105.8542, source: 'device-default' }\n  : data.userLocation;\n\nconst lat = finalUserLocation.lat;\nconst lng = finalUserLocation.lng;\n\n// X√°c ƒë·ªãnh lo·∫°i ƒë·ªãa ƒëi·ªÉm t·ª´ message\nconst msg = data.messageLower;\nlet poiType = 'ƒë·ªãa ƒëi·ªÉm du l·ªãch';\n\nif (msg.includes('ƒÉn') || msg.includes('qu√°n') || msg.includes('nh√† h√†ng')) {\n  poiType = 'nh√† h√†ng qu√°n ƒÉn';\n} else if (msg.includes('cafe') || msg.includes('c√† ph√™')) {\n  poiType = 'qu√°n cafe';\n} else if (msg.includes('kh√°ch s·∫°n') || msg.includes('hotel')) {\n  poiType = 'kh√°ch s·∫°n';\n}\n\n// Extract s·ªë l∆∞·ª£ng n·∫øu c√≥\nconst countMatch = msg.match(/(\\d+)\\s*(?:ƒëi·ªÉm|ch·ªó|n∆°i|ƒë·ªãa ƒëi·ªÉm)/);\nconst requestedCount = countMatch ? parseInt(countMatch[1]) : 5;\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  intent: 'SEARCH_NEARBY',\n  userLocation: finalUserLocation,\n  coordinates: `${lat},${lng}`,\n  searchQuery: `${poiType} g·∫ßn ${lat},${lng}`,\n  poiType,\n  requestedCount: Math.min(requestedCount, 10)\n};"
      },
      "id": "fn-build-nearby-search",
      "name": "Fn_BuildNearbySearch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        67808
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google_maps"
            },
            {
              "name": "q",
              "value": "={{ $json.poiType }}"
            },
            {
              "name": "ll",
              "value": "=@{{ $json.userLocation.lat }},{{ $json.userLocation.lng }},15z"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "type",
              "value": "search"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-nearby",
      "name": "HTTP_SearchNearby",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        58816,
        67808
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT NEARBY RESULTS =====\nconst prevData = $('Fn_BuildNearbySearch').item.json;\nconst apiData = $json;\n\nconst results = apiData.local_results || [];\nconst requestedCount = prevData.requestedCount || 5;\n\nif (results.length === 0) {\n  return {\n    intent: 'SEARCH_NEARBY',\n    nearby_raw: [],\n    location: 'v·ªã tr√≠ c·ªßa b·∫°n',\n    poiType: prevData.poiType,\n    has_results: false\n  };\n}\n\nconst nearby_raw = results.slice(0, requestedCount).map((p, idx) => ({\n  rank: idx + 1,\n  name: p.title || 'N/A',\n  address: p.address || null,\n  rating: p.rating || null,\n  reviews: p.reviews || null,\n  type: p.type || prevData.poiType,\n  distance: p.distance || null\n}));\n\nreturn {\n  intent: 'SEARCH_NEARBY',\n  nearby_raw,\n  location: 'v·ªã tr√≠ c·ªßa b·∫°n',\n  poiType: prevData.poiType,\n  requestedCount,\n  has_results: true\n};"
      },
      "id": "fn-format-nearby",
      "name": "Fn_FormatNearby",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59040,
        67808
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE TOUR DURATION =====\n// Mission: Extract s·ªë ng√†y v√† location cho tour\n\nconst data = $json;\nconst msg = data.messageLower;\n\n// Extract duration\nlet duration = data.tourDuration || 3; // default 3 ng√†y\n\n// Extract location n·∫øu c√≥\nlet tourLocation = null;\nconst locationMatch = msg.match(/(?:·ªü|t·∫°i|ƒëi|tour)\\s+([\\w√Ä-·ªπ\\s]+?)(?:\\s+\\d+|$)/i);\nif (locationMatch) {\n  tourLocation = locationMatch[1].trim();\n}\n\n// Fallback: t√¨m city names\nif (!tourLocation) {\n  const cities = ['h√† n·ªôi', 's√†i g√≤n', 'ƒë√† n·∫µng', 'hu·∫ø', 'nha trang', 'ph√∫ qu·ªëc', 'h·ªôi an', 'ƒë√† l·∫°t', 'sapa', 'h·∫° long', 'ninh b√¨nh', 'mi·ªÅn b·∫Øc', 'mi·ªÅn trung', 'mi·ªÅn nam', 'vi·ªát nam'];\n  const found = cities.find(c => msg.includes(c));\n  if (found) tourLocation = found;\n}\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  intent: 'SEARCH_TOUR',\n  tourDuration: duration,\n  tourLocation,\n  hasLocation: !!tourLocation\n};"
      },
      "id": "fn-parse-tour-duration",
      "name": "Fn_ParseTourDuration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58368,
        68112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasLocation }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "if-tour-no-location",
      "name": "IF_Tour_NoLocation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58592,
        68112
      ]
    },
    {
      "parameters": {
        "jsCode": "const duration = $json.tourDuration || '';\nreturn {\n  response: `üìç B·∫°n mu·ªën t√¨m tour ${duration} ng√†y ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•: ƒê√† N·∫µng, Ph√∫ Qu·ªëc, Sapa, H·∫° Long...`,\n  type: 'clarify_tour_location'\n};"
      },
      "id": "respond-clarify-tour-location",
      "name": "Respond_ClarifyTourLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        67904
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "=tour {{ $json.tourDuration }} ng√†y {{ $json.tourLocation }} gi√°"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-tour",
      "name": "HTTP_SearchTour",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        58816,
        68208
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT TOUR RESULTS =====\nconst prevData = $('Fn_ParseTourDuration').item.json;\nconst apiData = $json;\n\nconst results = apiData.organic_results || [];\n\nif (results.length === 0) {\n  return {\n    intent: 'SEARCH_TOUR',\n    tours_raw: [],\n    location: prevData.tourLocation,\n    duration: prevData.tourDuration,\n    has_results: false\n  };\n}\n\nconst tours_raw = results.slice(0, 5).map(t => ({\n  title: t.title || 'N/A',\n  snippet: t.snippet || null,\n  source: t.link || null,\n  provider: t.displayed_link || null\n}));\n\nreturn {\n  intent: 'SEARCH_TOUR',\n  tours_raw,\n  location: prevData.tourLocation,\n  duration: prevData.tourDuration,\n  has_results: true\n};"
      },
      "id": "fn-format-tour",
      "name": "Fn_FormatTour",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59040,
        68208
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasPlaceName }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "if-placeinfo-no-placename",
      "name": "IF_PlaceInfo_NoPlaceName",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58368,
        68304
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: 'üìç B·∫°n mu·ªën xem th√¥ng tin ƒë·ªãa ƒëi·ªÉm n√†o?\\n\\nV√≠ d·ª•:\\n‚Ä¢ ƒê·ªÅn Th√°i Vi\\n‚Ä¢ Ch√πa B√°i ƒê√≠nh\\n‚Ä¢ LƒÉng B√°c H·ªì\\n‚Ä¢ H·ªì Ho√†n Ki·∫øm',\n  type: 'clarify_place_name'\n};"
      },
      "id": "respond-clarify-placename",
      "name": "Respond_ClarifyPlaceName",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68112
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== RESOLVE PLACE NAME =====\n// Mission: Extract place name t·ª´ message cho GET_PLACE_INFO\n// Kh√°c v·ªõi location, placeName kh√¥ng c·∫ßn geocode\n\nconst data = $json;\nconst msg = data.messageLower || '';\nlet placeName = null;\n\n// Strategy 1: Place type keywords (ƒë·ªÅn, ch√πa, lƒÉng...)\nconst placeMatch = msg.match(/(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu|h·ªì|n√∫i|b√£i bi·ªÉn|c√¥ng vi√™n|b·∫£o t√†ng|di t√≠ch|khu)\\s+([\\w√Ä-·ªπ\\s]+?)(?:\\s+gi√°|\\s+gi·ªù|\\s+th√¥ng|\\s+cu·ªëi|\\s+h√¥m|\\s+\\?|$)/i);\nif (placeMatch) {\n  // Get full match and clean\n  placeName = placeMatch[0].replace(/gi√°|gi·ªù|th√¥ng.*$|cu·ªëi.*$|h√¥m.*$|\\?/gi, '').trim();\n}\n\n// Strategy 2: Reversed pattern (\"Th√°i Vi ƒë·ªÅn\")\nif (!placeName) {\n  const reversedMatch = msg.match(/([\\w√Ä-·ªπ]+)\\s+(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu)/i);\n  if (reversedMatch) {\n    placeName = reversedMatch[0].trim();\n  }\n}\n\n// Strategy 3: Famous landmarks\nif (!placeName) {\n  const landmarks = ['h·ªì ho√†n ki·∫øm', 'h·ªì g∆∞∆°m', 'lƒÉng b√°c', 'ch√πa m·ªôt c·ªôt', 'ch√πa b√°i ƒë√≠nh', 'tr√†ng an', 'tam c·ªëc', 'v·ªãnh h·∫° long', 'ƒë·ªông phong nha'];\n  const found = landmarks.find(l => msg.includes(l));\n  if (found) {\n    placeName = found;\n  }\n}\n\n// Strategy 4: Remove noise words and use what's left\nif (!placeName) {\n  const noiseWords = ['th√¥ng tin', 'gi√° v√©', 'gi·ªù m·ªü c·ª≠a', 'xem', 'cho bi·∫øt', 't√¥i', 'mu·ªën', 'cu·ªëi tu·∫ßn'];\n  let cleaned = msg;\n  for (const noise of noiseWords) {\n    cleaned = cleaned.replace(new RegExp(`\\\\s*${noise}\\\\s*`, 'gi'), ' ');\n  }\n  cleaned = cleaned.trim();\n  if (cleaned.length >= 3) {\n    placeName = cleaned;\n  }\n}\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  intent: 'GET_PLACE_INFO',\n  placeName,\n  locationDisplay: placeName\n};"
      },
      "id": "fn-resolve-placename",
      "name": "Fn_ResolvePlaceName",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasLocationHint }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "2c3deda8-90b2-40d9-8d47-0853896dfa4d",
      "name": "IF_NeedLocationClarification",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58368,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "const intent = $json.intent;\nlet question = '';\n\nif (intent === 'SEARCH_POI') {\n  question = 'üìç B·∫°n mu·ªën t√¨m ƒë·ªãa ƒëi·ªÉm du l·ªãch ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•:\\n‚Ä¢ H√† N·ªôi\\n‚Ä¢ Ninh B√¨nh\\n‚Ä¢ S√†i G√≤n\\n‚Ä¢ ƒê√† N·∫µng';\n} else if (intent === 'GET_WEATHER') {\n  question = 'üå¶Ô∏è B·∫°n mu·ªën xem th·ªùi ti·∫øt ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•:\\n‚Ä¢ H√† N·ªôi\\n‚Ä¢ Ninh B√¨nh\\n‚Ä¢ ƒê√† N·∫µng';\n} else if (intent === 'SEARCH_HOTEL') {\n  question = 'üèöÔ∏è B·∫°n mu·ªën t√¨m kh√°ch s·∫°n ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•:\\n‚Ä¢ H√† N·ªôi\\n‚Ä¢ Ninh B√¨nh\\n‚Ä¢ Qu·∫≠n 1 S√†i G√≤n';\n} else {\n  question = 'üìç B·∫°n c√≥ th·ªÉ cho bi·∫øt ƒë·ªãa ƒëi·ªÉm c·ª• th·ªÉ kh√¥ng?\\n\\nV√≠ d·ª•: H√† N·ªôi, Ninh B√¨nh, ƒê√† N·∫µng...';\n}\n\nreturn {\n  response: question,\n  type: 'clarify_location'\n};"
      },
      "id": "4d688a01-03dc-4f31-ba03-3e1873cc3868",
      "name": "Respond_ClarifyLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68624
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== EXTRACT LOCATION =====\n// Mission: Extract location t·ª´ message\n\nconst message = $json.messageLower || '';\nconst intent = $json.intent;\nlet locationRaw = null;\n\n// Strategy 1: After location keywords\nconst matchAfter = message.match(/(?:·ªü|t·∫°i|g·∫ßn|quanh|xung quanh)\\s+([^,?.!]+)/i);\nif (matchAfter) {\n  locationRaw = matchAfter[1].trim();\n}\n\n// Strategy 2: Place names (ƒë·ªÅn, ch√πa, lƒÉng...)\nif (!locationRaw && intent === 'GET_PLACE_INFO') {\n  const placeMatch = message.match(/(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu|h·ªì|n√∫i|b√£i|c√¥ng vi√™n|b·∫£o t√†ng)\\s+([\\w√Ä-·ªπ\\s]+?)(?:\\s+gi√°|\\s+gi·ªù|\\s+th√¥ng|$)/i);\n  if (placeMatch) {\n    locationRaw = placeMatch[0].replace(/gi√°|gi·ªù|th√¥ng.*$/i, '').trim();\n  }\n  \n  // Try reversed pattern: \"Th√°i Vi ƒë·ªÅn\"\n  if (!locationRaw) {\n    const reversedMatch = message.match(/([\\w√Ä-·ªπ]+)\\s+(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu)/i);\n    if (reversedMatch) {\n      locationRaw = reversedMatch[0].trim();\n    }\n  }\n}\n\n// Strategy 3: Common city names\nif (!locationRaw) {\n  const cities = ['h√† n·ªôi', 'hanoi', 's√†i g√≤n', 'saigon', 'h·ªì ch√≠ minh', 'ƒë√† n·∫µng', 'da nang', 'hu·∫ø', 'hue', 'nha trang', 'ph√∫ qu·ªëc', 'h·ªôi an', 'ƒë√† l·∫°t', 'sapa', 'h·∫° long', 'ninh b√¨nh'];\n  const found = cities.find(c => message.includes(c));\n  if (found) {\n    locationRaw = found;\n  }\n}\n\n// Strategy 4: Remove noise words\nif (!locationRaw) {\n  const noiseWords = ['t√¨m', 'ƒë·ªãa ƒëi·ªÉm', 'du l·ªãch', 'th·ªùi ti·∫øt', 'kh√°ch s·∫°n', 'hotel', 'weather', 'xem', 'tham quan', 'th√¥ng tin', 'gi√° v√©', 'gi·ªù m·ªü c·ª≠a'];\n  let cleaned = message;\n  for (const noise of noiseWords) {\n    cleaned = cleaned.replace(new RegExp(`\\\\s*${noise}\\\\s*`, 'gi'), ' ');\n  }\n  cleaned = cleaned.trim();\n  if (cleaned.length >= 3) {\n    locationRaw = cleaned;\n  }\n}\n\nreturn {\n  sessionId: $json.sessionId,\n  message: $json.message,\n  intent: $json.intent,\n  location: locationRaw\n};"
      },
      "id": "a394e134-30f7-4b83-b444-d5a928b0eb28",
      "name": "Fn_ExtractLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        68496
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.location }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "6b174c18-a629-4546-a47c-3896f3ffdc8f",
      "name": "IF_LocationValid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        58816,
        68496
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: '‚ùå Kh√¥ng th·ªÉ x√°c ƒë·ªãnh ƒë·ªãa ƒëi·ªÉm.\\n\\nVui l√≤ng cung c·∫•p r√µ h∆°n, v√≠ d·ª•:\\n- H√† N·ªôi\\n- ƒê·ªÅn Th√°i Vi\\n- Qu·∫≠n 1, S√†i G√≤n',\n  type: 'error'\n};"
      },
      "id": "1607049d-25fe-40d2-8d81-6ae1489fe4e7",
      "name": "Respond_LocationInvalid",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68816
      ]
    },
    {
      "parameters": {
        "url": "https://geocode.search.hereapi.com/v1/geocode",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.location }}"
            },
            {
              "name": "apiKey",
              "value": "DyD7QbF6uEeLGB47HYJ-ixnpiuYuS_HNFVaZso01_lQ"
            },
            {
              "name": "lang",
              "value": "vi-VN"
            },
            {
              "name": "limit",
              "value": "1"
            },
            {
              "name": "in",
              "value": "countryCode:VNM"
            }
          ]
        },
        "options": {
          "timeout": 8000
        }
      },
      "id": "806ae408-3190-4e59-9a65-dcd8facb0895",
      "name": "HTTP_Geocode",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59040,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE GEOCODING =====\nconst prevData = $('Fn_ExtractLocation').item.json;\nconst geoData = $json;\n\nlet coordinates = null;\nlet displayName = null;\n\nif (geoData.items && geoData.items.length > 0) {\n  const item = geoData.items[0];\n  if (item.position) {\n    const lat = item.position.lat;\n    const lon = item.position.lng;\n    coordinates = `${lat},${lon}`;\n  }\n  displayName = item.title || item.address?.label || prevData.location;\n} else {\n  displayName = prevData.location;\n}\n\nreturn {\n  sessionId: prevData.sessionId,\n  message: prevData.message,\n  intent: prevData.intent,\n  location: prevData.location,\n  locationDisplay: displayName,\n  coordinates\n};"
      },
      "id": "0ff38a7e-07e4-4890-afcb-b6139dd74ee5",
      "name": "Fn_ParseGeocode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59264,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.coordinates }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "70536312-8e87-4d32-b301-0d8f5413af13",
      "name": "IF_GeocodeSuccess",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        59488,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: '‚ùå Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm \"' + $json.location + '\".\\n\\nVui l√≤ng th·ª≠ l·∫°i v·ªõi t√™n kh√°c ho·∫∑c cung c·∫•p th√™m th√¥ng tin (qu·∫≠n/huy·ªán/th√†nh ph·ªë).',\n  type: 'geocode_failed'\n};"
      },
      "id": "560a2e50-2aaf-4cdc-9f61-2284cce524a1",
      "name": "Respond_GeocodeFailed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68432
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_POI",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "POI"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "GET_WEATHER",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Weather"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_HOTEL",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Hotel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "GET_PLACE_INFO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PlaceInfo"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "f8548ae8-94b7-4444-bf78-106ed6fb9af4",
      "name": "Switch_RouteToAPI",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        59712,
        68208
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} ƒëi·ªÉm tham quan du l·ªãch"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "e8527309-6d6e-408d-af81-ba96205b257f",
      "name": "HTTP_SearchPOI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        67904
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "url": "https://api.weatherapi.com/v1/current.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "52c2f536877444ec8a0165526260501"
            },
            {
              "name": "q",
              "value": "={{ $json.coordinates || $json.location }}"
            },
            {
              "name": "lang",
              "value": "vi"
            },
            {
              "name": "aqi",
              "value": "yes"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "cba5b795-a0ab-4259-a4af-ccafb8ee1caf",
      "name": "HTTP_GetWeather",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        68096
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google_hotels"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} hotels"
            },
            {
              "name": "check_in_date",
              "value": "={{ $now.format('yyyy-MM-dd') }}"
            },
            {
              "name": "check_out_date",
              "value": "={{ $now.plus({days: 1}).format('yyyy-MM-dd') }}"
            },
            {
              "name": "currency",
              "value": "VND"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "6110ff85-c776-413d-a9a5-262e39153206",
      "name": "HTTP_SearchHotel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        68288
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} gi√° v√© gi·ªù m·ªü c·ª≠a th√¥ng tin"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-place-info",
      "name": "HTTP_SearchPlaceInfo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        68480
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT POI RESULTS (AGODA-STYLE) =====\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y - d√πng data t·ª´ Fn_ParseGeocode\nconst geocodeData = $('Fn_ParseGeocode').item.json;\nconst apiData = $json;\n\nconst results = apiData.organic_results || [];\n\nif (results.length === 0) {\n  return {\n    intent: 'SEARCH_POI',\n    poi_raw: [],\n    location: geocodeData.locationDisplay,\n    has_results: false\n  };\n}\n\nconst poi_raw = results.slice(0, 5).map(p => ({\n  name: p.title || 'N/A',\n  source: p.link || null,\n  short_fact: p.snippet || null\n}));\n\nreturn {\n  intent: 'SEARCH_POI',\n  poi_raw,\n  location: geocodeData.locationDisplay,\n  has_results: true\n};"
      },
      "id": "bd6b8407-7cd8-4982-84cc-ce2a87573e1e",
      "name": "Fn_FormatPOI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        67904
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT WEATHER RESULTS (AGODA-STYLE) =====\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y\nconst geocodeData = $('Fn_ParseGeocode').item.json;\nconst apiData = $json;\n\nif (!apiData.current) {\n  return {\n    intent: 'GET_WEATHER',\n    weather_raw: null,\n    location: geocodeData.locationDisplay,\n    has_results: false\n  };\n}\n\nconst current = apiData.current;\n\nconst weather_raw = {\n  temp_c: current.temp_c,\n  feelslike_c: current.feelslike_c,\n  condition: current.condition?.text || '',\n  humidity: current.humidity || 0,\n  wind_kph: current.wind_kph || 0,\n  last_updated: current.last_updated || ''\n};\n\nreturn {\n  intent: 'GET_WEATHER',\n  weather_raw,\n  location: geocodeData.locationDisplay,\n  has_results: true\n};"
      },
      "id": "83122bb9-7642-43d0-ac79-2f4e8af4b9d1",
      "name": "Fn_FormatWeather",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        68096
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT HOTEL RESULTS (AGODA-STYLE) =====\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y\nconst geocodeData = $('Fn_ParseGeocode').item.json;\nconst apiData = $json;\n\nconst hotels = apiData.properties || [];\n\nif (hotels.length === 0) {\n  return {\n    intent: 'SEARCH_HOTEL',\n    hotels_raw: [],\n    location: geocodeData.locationDisplay,\n    has_results: false\n  };\n}\n\nconst hotels_raw = hotels.slice(0, 5).map(h => ({\n  name: h.name || 'N/A',\n  price: h.rate_per_night?.lowest || null,\n  rating: h.overall_rating || null,\n  description: h.description || null\n}));\n\nreturn {\n  intent: 'SEARCH_HOTEL',\n  hotels_raw,\n  location: geocodeData.locationDisplay,\n  has_results: true\n};"
      },
      "id": "9d281c1c-5090-4fcc-9260-d88cc269b7ae",
      "name": "Fn_FormatHotel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        68288
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT PLACE INFO RESULTS (AGODA-STYLE) =====\n// Mission: Extract gi√° v√©, gi·ªù m·ªü c·ª≠a t·ª´ search results\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y - d√πng data t·ª´ Fn_ResolvePlaceName\n\nconst placeData = $('Fn_ResolvePlaceName').item.json;\nconst apiData = $json;\n\nconst results = apiData.organic_results || [];\nconst knowledgeGraph = apiData.knowledge_graph || {};\n\n// Structured place info\nconst place_info = {\n  name: placeData.placeName || placeData.locationDisplay,\n  description: null,\n  ticket_price: null,\n  opening_hours: null,\n  address: null,\n  note_if_unknown: null\n};\n\n// Try knowledge graph first\nif (knowledgeGraph.title) {\n  place_info.description = knowledgeGraph.description || null;\n  place_info.address = knowledgeGraph.address || null;\n  // Opening hours from KG\n  if (knowledgeGraph.hours) {\n    place_info.opening_hours = typeof knowledgeGraph.hours === 'string' \n      ? knowledgeGraph.hours \n      : JSON.stringify(knowledgeGraph.hours);\n  }\n}\n\n// Extract from snippets\nfor (const r of results) {\n  const snippet = (r.snippet || '').toLowerCase();\n  \n  // Look for ticket price\n  const priceMatch = snippet.match(/(\\d+[.,]?\\d*)\\s*(ƒë|vnƒë|ƒë·ªìng|k|ngh√¨n|tri·ªáu)/i);\n  if (priceMatch && !place_info.ticket_price) {\n    place_info.ticket_price = priceMatch[0];\n  }\n  \n  // Look for opening hours\n  const hoursMatch = snippet.match(/(\\d{1,2}[h:]\\d{0,2}\\s*-\\s*\\d{1,2}[h:]\\d{0,2}|m·ªü c·ª≠a[^.]+)/i);\n  if (hoursMatch && !place_info.opening_hours) {\n    place_info.opening_hours = hoursMatch[0];\n  }\n  \n  // Get description if not set\n  if (!place_info.description && r.snippet && r.snippet.length > 50) {\n    place_info.description = r.snippet;\n  }\n}\n\n// Add commercial note if missing critical info\nif (!place_info.ticket_price) {\n  place_info.note_if_unknown = 'Hi·ªán ch∆∞a c√≥ th√¥ng tin gi√° v√© ch√≠nh th·ª©c, b·∫°n n√™n li√™n h·ªá ƒë·ªãa ph∆∞∆°ng ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.';\n}\nif (!place_info.opening_hours) {\n  place_info.note_if_unknown = (place_info.note_if_unknown || '') + ' Th√¥ng tin gi·ªù m·ªü c·ª≠a ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t.';\n}\n\nreturn {\n  intent: 'GET_PLACE_INFO',\n  place_info,\n  location: placeData.placeName || placeData.locationDisplay,\n  has_results: !!(place_info.description || place_info.ticket_price || place_info.opening_hours)\n};"
      },
      "id": "fn-format-place-info",
      "name": "Fn_FormatPlaceInfo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        68480
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== BUILD COMPLETE REQUEST BODY =====\n// Mission: T·∫°o TO√ÄN B·ªò request body cho OpenRouter\n// ‚ö° UPDATED: H·ªó tr·ª£ 6 intents\n\nconst data = $json;\n\nconst intent = data.intent || 'UNKNOWN';\nconst location = data.location || null;\nconst has_results = data.has_results !== false;\n\n// Chu·∫©n h√≥a data theo intent\nlet structured_data = null;\n\nif (intent === 'SEARCH_POI') {\n  structured_data = {\n    places: data.poi_raw || [],\n    count: (data.poi_raw || []).length\n  };\n} else if (intent === 'GET_WEATHER') {\n  structured_data = {\n    weather: data.weather_raw || null\n  };\n} else if (intent === 'SEARCH_HOTEL') {\n  structured_data = {\n    hotels: data.hotels_raw || [],\n    count: (data.hotels_raw || []).length\n  };\n} else if (intent === 'GET_PLACE_INFO') {\n  structured_data = {\n    place_info: data.place_info || null\n  };\n} else if (intent === 'SEARCH_NEARBY') {\n  structured_data = {\n    nearby_places: data.nearby_raw || [],\n    count: (data.nearby_raw || []).length,\n    poi_type: data.poiType || 'ƒë·ªãa ƒëi·ªÉm'\n  };\n} else if (intent === 'SEARCH_TOUR') {\n  structured_data = {\n    tours: data.tours_raw || [],\n    count: (data.tours_raw || []).length,\n    duration: data.duration || null\n  };\n}\n\nconst ai_input = {\n  intent,\n  location,\n  has_results,\n  data: structured_data\n};\n\nconst systemPrompt = `VAI TR√í\nB·∫°n l√† module VI·∫æT L·∫†I K·∫æT QU·∫¢ cho chatbot du l·ªãch th∆∞∆°ng m·∫°i.\nB·∫°n KH√îNG ph·∫£i c√¥ng c·ª• t√¨m ki·∫øm, KH√îNG ph·∫£i AI s√°ng t√°c.\n\nM·ª§C TI√äU\n- ƒê√°ng tin\n- Kh√¥ng n√≥i sai\n- Kh√¥ng g√¢y r·ªëi\n- Gi·ªëng c√°ch nh√¢n vi√™n t∆∞ v·∫•n du l·ªãch vi·∫øt\n\nNGUY√äN T·∫ÆC B·∫ÆT BU·ªòC\n1. CH·ªà s·ª≠ d·ª•ng d·ªØ li·ªáu ƒë∆∞·ª£c cung c·∫•p trong ƒë·∫ßu v√†o.\n2. KH√îNG b·ªãa th√™m ƒë·ªãa ƒëi·ªÉm, th√¥ng tin, ho·∫∑c chi ti·∫øt.\n3. KH√îNG suy di·ªÖn v∆∞·ª£t qu√° d·ªØ li·ªáu.\n4. N·∫øu d·ªØ li·ªáu ch·ªâ mang t√≠nh t·ªïng quan ‚Üí n√≥i r√µ l√† \"th√¥ng tin t·ªïng quan\".\n5. N·∫øu ƒë·ªãa danh trong input kh√¥ng r√µ r√†ng ‚Üí di·ªÖn ƒë·∫°t trung t√≠nh, kh√¥ng kh·∫≥ng ƒë·ªãnh sai.\n6. N·∫øu c√≥ note_if_unknown ‚Üí B·∫ÆT BU·ªòC ƒë∆∞a v√†o response.\n\nQUY T·∫ÆC VI·∫æT N·ªòI DUNG\n- ƒê∆Ø·ª¢C t√≥m t·∫Øt v√† di·ªÖn ƒë·∫°t l·∫°i t·ª´ n·ªôi dung ngu·ªìn.\n- KH√îNG sao ch√©p nguy√™n vƒÉn ti√™u ƒë·ªÅ, snippet, ho·∫∑c m√¥ t·∫£ SEO.\n- M·ªói ƒë·ªãa ƒëi·ªÉm: 2‚Äì3 c√¢u ng·∫Øn, trung t√≠nh.\n- Tr√°nh t·ª´ ng·ªØ qu·∫£ng c√°o, tr√°nh vƒÉn phong AI.\n- TUY·ªÜT ƒê·ªêI KH√îNG d√πng d·∫•u \"...\".\n\nƒê·∫∂C BI·ªÜT CHO GET_PLACE_INFO\n- N·∫øu c√≥ gi√° v√©: ghi r√µ\n- N·∫øu c√≥ gi·ªù m·ªü c·ª≠a: ghi r√µ\n- N·∫øu KH√îNG c√≥: n√≥i \"Hi·ªán ch∆∞a c√≥ th√¥ng tin ch√≠nh th·ª©c, vui l√≤ng li√™n h·ªá ƒë·ªãa ph∆∞∆°ng\"\n\nƒê·∫∂C BI·ªÜT CHO SEARCH_NEARBY\n- Li·ªát k√™ theo th·ª© t·ª± g·∫ßn nh·∫•t\n- N·∫øu c√≥ distance: ghi kho·∫£ng c√°ch\n- N·∫øu c√≥ rating: ghi ƒë√°nh gi√°\n\nƒê·∫∂C BI·ªÜT CHO SEARCH_TOUR\n- N√™u t√™n tour v√† ngu·ªìn\n- KH√îNG t·ª± l·∫≠p l·ªãch tr√¨nh\n- Khuy·∫øn ngh·ªã: \"B·∫°n c√≥ th·ªÉ li√™n h·ªá c√°c ƒë∆°n v·ªã tr√™n ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt\"\n\nTR√åNH B√ÄY\n- Danh s√°ch r√µ r√†ng\n- T√™n ƒë·ªãa ƒëi·ªÉm in ƒë·∫≠m\n- Cu·ªëi c√¢u tr·∫£ l·ªùi: h·ªèi ti·∫øp 1 c√¢u ƒë·ªãnh h∆∞·ªõng nh·∫π\n\nCH·ªà TR·∫¢ V·ªÄ JSON H·ª¢P L·ªÜ. KH√îNG th√™m ch·ªØ gi·∫£i th√≠ch. KH√îNG markdown.\n{\n  \"response\": \"N·ªôi dung ph·∫£n h·ªìi cho ng∆∞·ªùi d√πng\",\n  \"type\": \"success\"\n}`;\n\nconst requestBody = {\n  model: 'openai/gpt-4o-mini',\n  temperature: 0.3,\n  max_tokens: 600,\n  messages: [\n    {\n      role: 'system',\n      content: systemPrompt\n    },\n    {\n      role: 'user',\n      content: 'D·ªØ li·ªáu:\\n' + JSON.stringify(ai_input, null, 2)\n    }\n  ]\n};\n\nreturn { requestBody };"
      },
      "id": "81319b58-db1e-4c99-b48b-945095e276eb",
      "name": "Fn_BuildAIInput",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60384,
        68192
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.requestBody }}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "f23f27eb-999a-4639-8f22-e314a3615a9e",
      "name": "AI_Response_Guard",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        60608,
        68192
      ],
      "credentials": {
        "httpBearerAuth": {
          "id": "SVjS2GRy7ezqnu9w",
          "name": "Bearer Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE AI GUARD RESPONSE =====\nconst content = ($json.choices?.[0]?.message?.content || '{}').trim();\nlet parsed = {};\ntry {\n  parsed = JSON.parse(content);\n} catch(e) {\n  parsed = {\n    response: 'ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.',\n    type: 'error'\n  };\n}\n\nreturn parsed;"
      },
      "id": "c99dcf1d-9084-4f2a-af5a-d4888a6c4248",
      "name": "Fn_ParseGuardResponse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60832,
        68192
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "c2424688-fba9-492d-a100-f70a68c7a014",
      "name": "Respond_Final",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        61856,
        68432
      ]
    }
  ],
  "connections": {
    "Webhook_ReceiveMessage": {
      "main": [
        [
          {
            "node": "Fn_NormalizeInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_NormalizeInput": {
      "main": [
        [
          {
            "node": "IF_IsTravelDomain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_IsTravelDomain": {
      "main": [
        [
          {
            "node": "Fn_DetectIntentRuleBased",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_OutOfScope",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_OutOfScope": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_DetectIntentRuleBased": {
      "main": [
        [
          {
            "node": "Fn_CheckRequiredSlots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_CheckRequiredSlots": {
      "main": [
        [
          {
            "node": "IF_NeedIntentClarification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_NeedIntentClarification": {
      "main": [
        [
          {
            "node": "Respond_ClarifyIntent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch_SpecialIntent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyIntent": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_SpecialIntent": {
      "main": [
        [
          {
            "node": "IF_Nearby_NoLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ParseTourDuration",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF_PlaceInfo_NoPlaceName",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF_NeedLocationClarification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_Nearby_NoLocation": {
      "main": [
        [
          {
            "node": "Respond_RequestLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_BuildNearbySearch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_RequestLocation": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_BuildNearbySearch": {
      "main": [
        [
          {
            "node": "HTTP_SearchNearby",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchNearby": {
      "main": [
        [
          {
            "node": "Fn_FormatNearby",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatNearby": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseTourDuration": {
      "main": [
        [
          {
            "node": "IF_Tour_NoLocation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_Tour_NoLocation": {
      "main": [
        [
          {
            "node": "Respond_ClarifyTourLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchTour",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyTourLocation": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchTour": {
      "main": [
        [
          {
            "node": "Fn_FormatTour",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatTour": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_PlaceInfo_NoPlaceName": {
      "main": [
        [
          {
            "node": "Respond_ClarifyPlaceName",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ResolvePlaceName",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyPlaceName": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ResolvePlaceName": {
      "main": [
        [
          {
            "node": "HTTP_SearchPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_NeedLocationClarification": {
      "main": [
        [
          {
            "node": "Respond_ClarifyLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ExtractLocation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyLocation": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ExtractLocation": {
      "main": [
        [
          {
            "node": "IF_LocationValid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_LocationValid": {
      "main": [
        [
          {
            "node": "HTTP_Geocode",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_LocationInvalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_LocationInvalid": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_Geocode": {
      "main": [
        [
          {
            "node": "Fn_ParseGeocode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseGeocode": {
      "main": [
        [
          {
            "node": "IF_GeocodeSuccess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_GeocodeSuccess": {
      "main": [
        [
          {
            "node": "Switch_RouteToAPI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_GeocodeFailed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_GeocodeFailed": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_RouteToAPI": {
      "main": [
        [
          {
            "node": "HTTP_SearchPOI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_GetWeather",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchHotel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchPOI": {
      "main": [
        [
          {
            "node": "Fn_FormatPOI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_GetWeather": {
      "main": [
        [
          {
            "node": "Fn_FormatWeather",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchHotel": {
      "main": [
        [
          {
            "node": "Fn_FormatHotel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchPlaceInfo": {
      "main": [
        [
          {
            "node": "Fn_FormatPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatPOI": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatWeather": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatHotel": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatPlaceInfo": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_BuildAIInput": {
      "main": [
        [
          {
            "node": "AI_Response_Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI_Response_Guard": {
      "main": [
        [
          {
            "node": "Fn_ParseGuardResponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseGuardResponse": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "8298d6d82438e8d5ee28189bff4aaace26c9e5a75151cb6d6f4c18d7bb992ea7"
  }
}




{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "disciplined-travel",
        "responseMode": "lastNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "61bf2a25-6106-4059-9c7d-16c4fd853e25",
      "name": "Webhook_ReceiveMessage",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [
        56800,
        68400
      ],
      "webhookId": "disciplined-travel"
    },
    {
      "parameters": {
        "jsCode": "// ===== NORMALIZE INPUT =====\n// Mission: Clean ONLY, kh√¥ng s·ª≠a nghƒ©a\n// ‚ö° FIX: X·ª≠ l√Ω m·ªçi c√°ch n8n tr·∫£ data t·ª´ webhook\n\n// n8n webhook tr·∫£ data trong $json.body\nconst body = $json.body || {};\nconst query = $json.query || {};\nconst headers = $json.headers || {};\n\n// Get or generate sessionId\nlet sessionId = body.sessionId || query.sessionId || headers['x-session-id'];\nif (!sessionId) {\n  const timestamp = Date.now();\n  const random = Math.random().toString(36).substring(2, 15);\n  sessionId = `sess_${timestamp}_${random}`;\n}\n\n// Extract message t·ª´ body\nconst message = String(body.message || '').trim();\nconst messageLower = message.toLowerCase();\n\n// Nh·∫≠n user_location t·ª´ client (cho Nearby)\nconst userLocation = body.user_location || null;\n\nreturn {\n  sessionId,\n  message,\n  messageLower,\n  userLocation\n};"
      },
      "id": "d1dd8dc6-c5a1-4739-a831-e70ae7bfa4ae",
      "name": "Fn_NormalizeInput",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57024,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.messageLower }}",
              "rightValue": "du l·ªãch|ƒë·ªãa ƒëi·ªÉm|tham quan|ƒëi ch∆°i|ƒëi ƒë√¢u|th·ªùi ti·∫øt|kh√°ch s·∫°n|hotel|weather|attraction|tour|g·∫ßn t√¥i|quanh t√¥i|gi√° v√©|gi·ªù m·ªü c·ª≠a|th√¥ng tin|h√†nh tr√¨nh|ng√†y",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "6dd02752-a823-4850-b3b9-27d87d26a203",
      "name": "IF_IsTravelDomain",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        57248,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: 'Hi·ªán t·∫°i t√¥i h·ªó tr·ª£:\\n\\nüìç Th√¥ng tin ƒë·ªãa ƒëi·ªÉm (gi√° v√©, gi·ªù m·ªü c·ª≠a)\\nüèûÔ∏è T√¨m ƒë·ªãa ƒëi·ªÉm du l·ªãch\\nüèöÔ∏è T√¨m kh√°ch s·∫°n\\nüß≥ T√¨m tour tr·ªçn g√≥i\\nüå¶Ô∏è Xem th·ªùi ti·∫øt\\nüìç T√¨m g·∫ßn t√¥i\\n\\nV√≠ d·ª•: \"Th√¥ng tin ƒë·ªÅn Th√°i Vi\" ho·∫∑c \"3 ƒëi·ªÉm du l·ªãch g·∫ßn t√¥i\"',\n  type: 'out_of_scope'\n};"
      },
      "id": "dfaba99e-ddd3-40f9-80cd-2360487bdcc5",
      "name": "Respond_OutOfScope",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        69200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== RULE-BASED INTENT DETECTION =====\n// Mission: Ph√¢n lo·∫°i intent b·∫±ng keyword, KH√îNG AI\n// ‚ö° TH√äM: GET_PLACE_INFO, SEARCH_NEARBY, SEARCH_TOUR\n\nconst msg = $json.messageLower;\nconst prevData = $json;\n\nlet intent = 'UNKNOWN';\nlet confidence = 'low';\n\n// ===== PRIORITY ORDER (quan tr·ªçng!) =====\n\n// 1Ô∏è‚É£ SEARCH_NEARBY - ∆Øu ti√™n cao nh·∫•t\nif (\n  msg.includes('g·∫ßn t√¥i') ||\n  msg.includes('quanh t√¥i') ||\n  msg.includes('xung quanh t√¥i') ||\n  msg.includes('g·∫ßn ƒë√¢y') ||\n  msg.includes('near me') ||\n  msg.includes('nearby')\n) {\n  intent = 'SEARCH_NEARBY';\n  confidence = 'high';\n}\n\n// 2Ô∏è‚É£ GET_PLACE_INFO - Th√¥ng tin chi ti·∫øt\nelse if (\n  msg.includes('gi√° v√©') ||\n  msg.includes('gi·ªù m·ªü c·ª≠a') ||\n  msg.includes('th√¥ng tin') ||\n  msg.includes('m·ªü c·ª≠a l√∫c') ||\n  msg.includes('v√© v√†o') ||\n  msg.includes('ph√≠ tham quan') ||\n  msg.includes('mi·ªÖn ph√≠') ||\n  msg.includes('m·∫•t ph√≠')\n) {\n  intent = 'GET_PLACE_INFO';\n  confidence = 'high';\n}\n\n// 3Ô∏è‚É£ SEARCH_TOUR - Tour du l·ªãch\nelse if (\n  msg.includes('tour ') ||\n  msg.match(/\\d+\\s*ng√†y/) ||  // \"5 ng√†y\", \"3ng√†y\"\n  msg.includes('h√†nh tr√¨nh') ||\n  msg.includes('l·ªãch tr√¨nh') ||\n  msg.includes('chuy·∫øn ƒëi')\n) {\n  intent = 'SEARCH_TOUR';\n  confidence = 'high';\n}\n\n// 4Ô∏è‚É£ GET_WEATHER - Th·ªùi ti·∫øt\nelse if (\n  msg.includes('th·ªùi ti·∫øt') ||\n  msg.includes('weather') ||\n  msg.includes('m∆∞a') ||\n  msg.includes('n·∫Øng') ||\n  msg.includes('nhi·ªát ƒë·ªô') ||\n  msg.includes('ƒë·ªô c')\n) {\n  intent = 'GET_WEATHER';\n  confidence = 'high';\n}\n\n// 5Ô∏è‚É£ SEARCH_HOTEL - Kh√°ch s·∫°n\nelse if (\n  msg.includes('kh√°ch s·∫°n') ||\n  msg.includes('hotel') ||\n  msg.includes('ph√≤ng ngh·ªâ') ||\n  msg.includes('homestay') ||\n  msg.includes('resort') ||\n  msg.includes('nh√† ngh·ªâ')\n) {\n  intent = 'SEARCH_HOTEL';\n  confidence = 'high';\n}\n\n// 6Ô∏è‚É£ SEARCH_POI - ƒê·ªãa ƒëi·ªÉm du l·ªãch (default cho travel domain)\nelse if (\n  msg.includes('ƒë·ªãa ƒëi·ªÉm') ||\n  msg.includes('tham quan') ||\n  msg.includes('du l·ªãch') ||\n  msg.includes('ƒëi ch∆°i') ||\n  msg.includes('ƒëi ƒë√¢u') ||\n  msg.includes('attraction')\n) {\n  intent = 'SEARCH_POI';\n  confidence = 'high';\n}\n\nreturn {\n  sessionId: prevData.sessionId,\n  message: prevData.message,\n  messageLower: prevData.messageLower,\n  userLocation: prevData.userLocation,\n  intent,\n  confidence\n};"
      },
      "id": "af8b5ae1-rule-based-intent",
      "name": "Fn_DetectIntentRuleBased",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57472,
        68304
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== CHECK REQUIRED SLOTS (STRICT, NO GUESS) =====\n// Mission: Check d·ªØ li·ªáu c√≥ s·∫µn - KH√îNG t·∫°o default\n// ‚ö° AGODA-STYLE: Location = placeName HO·∫∂C userLocation (ch∆∞a c·∫ßn lat/lng)\n\nconst data = $json;\nconst message = data.messageLower || '';\nconst intent = data.intent || 'UNKNOWN';\n\n// ‚úÖ LU√îN ƒê·ªåC T·ª™ $json\nconst userLocation = data.userLocation || null;\n\n// ---- CHECK PLACE NAME (explicit text) ----\nconst hasPlaceName =\n  message.includes('ƒë·ªÅn') ||\n  message.includes('ch√πa') ||\n  message.includes('nh√† th·ªù') ||\n  message.includes('b·∫£o t√†ng') ||\n  message.includes('lƒÉng') ||\n  message.includes('h·ªì ') ||\n  message.includes('n√∫i ') ||\n  message.includes('bi·ªÉn');\n\n// ---- CHECK LOCATION HINT (city/area names) ----\nconst hasLocationHint =\n  message.includes('·ªü ') ||\n  message.includes('t·∫°i ') ||\n  message.includes('g·∫ßn ') ||\n  message.includes('quanh ') ||\n  message.includes('xung quanh ') ||\n  message.includes('khu v·ª±c ') ||\n  message.includes('h√† n·ªôi') ||\n  message.includes('s√†i g√≤n') ||\n  message.includes('ƒë√† n·∫µng') ||\n  message.includes('ninh b√¨nh');\n\n// ---- CHECK \"G·∫¶N T√îI\" ----\nconst isNearMe =\n  message.includes('g·∫ßn t√¥i') ||\n  message.includes('quanh t√¥i') ||\n  message.includes('xung quanh t√¥i') ||\n  message.includes('g·∫ßn ƒë√¢y');\n\n// ---- CHECK USER LOCATION AVAILABLE ----\nconst hasUserLocation = !!(userLocation && userLocation.lat && userLocation.lng);\n\n// ---- CHECK TIME ----\nconst hasTimeHint =\n  message.includes('h√¥m nay') ||\n  message.includes('cu·ªëi tu·∫ßn') ||\n  message.includes('ng√†y mai') ||\n  message.includes('tu·∫ßn n√†y');\n\n// ---- CHECK TOUR DURATION ----\nconst durationMatch = message.match(/(\\d+)\\s*ng√†y/);\nconst tourDuration = durationMatch ? parseInt(durationMatch[1]) : null;\n\n// ---- SLOT VALIDATION - AGODA LOGIC ----\nlet missingSlots = [];\nlet needClarification = false;\n\n// üî• SEARCH_POI / SEARCH_NEARBY - Ch·∫•p nh·∫≠n place name HO·∫∂C userLocation\nif (intent === 'SEARCH_POI' || intent === 'SEARCH_NEARBY') {\n  // C√≥ place name ‚Üí OK (s·∫Ω geocode sau)\n  // C√≥ userLocation ‚Üí OK (d√πng device)\n  // \"g·∫ßn t√¥i\" ‚Üí OK (s·∫Ω xin quy·ªÅn sau)\n  const hasAnyLocationSource = hasPlaceName || hasLocationHint || hasUserLocation || isNearMe;\n  \n  if (!hasAnyLocationSource) {\n    missingSlots.push('location');\n    needClarification = true;\n  }\n}\n// GET_PLACE_INFO - Ch·ªâ c·∫ßn place name\nelse if (intent === 'GET_PLACE_INFO') {\n  if (!hasPlaceName) {\n    missingSlots.push('placeName');\n    needClarification = true;\n  }\n}\n// GET_WEATHER - C·∫ßn location hint\nelse if (intent === 'GET_WEATHER') {\n  if (!hasLocationHint && !hasPlaceName) {\n    missingSlots.push('location');\n    needClarification = true;\n  }\n}\n// SEARCH_HOTEL - C·∫ßn location hint\nelse if (intent === 'SEARCH_HOTEL') {\n  if (!hasLocationHint) {\n    missingSlots.push('location');\n    needClarification = true;\n  }\n}\n// SEARCH_TOUR - C·∫ßn duration\nelse if (intent === 'SEARCH_TOUR') {\n  if (!tourDuration) {\n    missingSlots.push('duration');\n    needClarification = true;\n  }\n}\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  messageLower: data.messageLower,\n  userLocation: data.userLocation,\n  intent: data.intent,\n  confidence: data.confidence,\n  hasLocationHint,\n  isNearMe,\n  hasUserLocation,\n  hasPlaceName,\n  hasTimeHint,\n  tourDuration,\n  missingSlots,\n  needClarification\n};"
      },
      "id": "6661cacf-8468-4fc4-a8c7-2194fee08157",
      "name": "Fn_CheckRequiredSlots",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        57696,
        68304
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.confidence }}",
              "rightValue": "low",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "78a1e412-7eed-4b7e-9471-7f72c8f92e3c",
      "name": "IF_NeedIntentClarification",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        57920,
        68304
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== GUIDE USER (AGODA-STYLE) =====\n// Mission: Xoay user v·ªÅ h∆∞·ªõng r√µ r√†ng - KH√îNG h·ªèi m∆° h·ªì\n\nreturn {\n  response: 'B·∫°n ƒëang mu·ªën:\\n\\nüìç Xem th√¥ng tin ƒë·ªãa ƒëi·ªÉm (gi√° v√©, gi·ªù m·ªü c·ª≠a)\\nüèûÔ∏è T√¨m ƒë·ªãa ƒëi·ªÉm du l·ªãch\\nüèöÔ∏è T√¨m kh√°ch s·∫°n\\nüß≥ T√¨m tour tr·ªçn g√≥i\\nüå¶Ô∏è Xem th·ªùi ti·∫øt\\nüìç T√¨m ƒëi·ªÉm g·∫ßn t√¥i\\n\\nV√≠ d·ª•: \"Th√¥ng tin ƒë·ªÅn Th√°i Vi\" ho·∫∑c \"T√¨m 3 ƒëi·ªÉm du l·ªãch g·∫ßn t√¥i\"',\n  type: 'guide_user'\n};"
      },
      "id": "75036388-2e81-49ee-ae1a-652ee1c16f20",
      "name": "Respond_ClarifyIntent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        69008
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_NEARBY",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Nearby"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_TOUR",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Tour"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "GET_PLACE_INFO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PlaceInfo"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "switch-special-intent",
      "name": "Switch_SpecialIntent",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        58144,
        68208
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasUserLocation }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "if-nearby-no-location",
      "name": "IF_Nearby_NoLocation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58368,
        67904
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: 'üìç ƒê·ªÉ t√¨m ƒë·ªãa ƒëi·ªÉm g·∫ßn b·∫°n, vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ c·ªßa b·∫°n.\\n\\nB·∫°n c√≥ th·ªÉ:\\n1. B·∫≠t ƒë·ªãnh v·ªã tr√™n thi·∫øt b·ªã\\n2. Ho·∫∑c cho bi·∫øt khu v·ª±c b·∫°n ƒëang ·ªü (VD: \"Qu·∫≠n 1 S√†i G√≤n\")',\n  type: 'request_location_permission',\n  require_location: true\n};"
      },
      "id": "respond-request-location",
      "name": "Respond_RequestLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        67712
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== BUILD NEARBY SEARCH (AGODA-STYLE) =====\n// Mission: X√¢y d·ª±ng query t√¨m ki·∫øm theo t·ªça ƒë·ªô user\n// ‚ö° CH·ªà ·ªü ƒê√ÇY m·ªõi fallback default coords (SAU KHI bi·∫øt intent)\n\nconst data = $json;\n\n// Fallback default coords n·∫øu client kh√¥ng g·ª≠i\nconst finalUserLocation = (!data.userLocation || !data.userLocation.lat || !data.userLocation.lng) \n  ? { lat: 21.0285, lng: 105.8542, source: 'device-default' }\n  : data.userLocation;\n\nconst lat = finalUserLocation.lat;\nconst lng = finalUserLocation.lng;\n\n// X√°c ƒë·ªãnh lo·∫°i ƒë·ªãa ƒëi·ªÉm t·ª´ message\nconst msg = data.messageLower;\nlet poiType = 'ƒë·ªãa ƒëi·ªÉm du l·ªãch';\n\nif (msg.includes('ƒÉn') || msg.includes('qu√°n') || msg.includes('nh√† h√†ng')) {\n  poiType = 'nh√† h√†ng qu√°n ƒÉn';\n} else if (msg.includes('cafe') || msg.includes('c√† ph√™')) {\n  poiType = 'qu√°n cafe';\n} else if (msg.includes('kh√°ch s·∫°n') || msg.includes('hotel')) {\n  poiType = 'kh√°ch s·∫°n';\n}\n\n// Extract s·ªë l∆∞·ª£ng n·∫øu c√≥\nconst countMatch = msg.match(/(\\d+)\\s*(?:ƒëi·ªÉm|ch·ªó|n∆°i|ƒë·ªãa ƒëi·ªÉm)/);\nconst requestedCount = countMatch ? parseInt(countMatch[1]) : 5;\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  intent: 'SEARCH_NEARBY',\n  userLocation: finalUserLocation,\n  coordinates: `${lat},${lng}`,\n  searchQuery: `${poiType} g·∫ßn ${lat},${lng}`,\n  poiType,\n  requestedCount: Math.min(requestedCount, 10)\n};"
      },
      "id": "fn-build-nearby-search",
      "name": "Fn_BuildNearbySearch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        67808
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google_maps"
            },
            {
              "name": "q",
              "value": "={{ $json.poiType }}"
            },
            {
              "name": "ll",
              "value": "=@{{ $json.userLocation.lat }},{{ $json.userLocation.lng }},15z"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "type",
              "value": "search"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-nearby",
      "name": "HTTP_SearchNearby",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        58816,
        67808
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT NEARBY RESULTS =====\nconst prevData = $('Fn_BuildNearbySearch').item.json;\nconst apiData = $json;\n\nconst results = apiData.local_results || [];\nconst requestedCount = prevData.requestedCount || 5;\n\nif (results.length === 0) {\n  return {\n    intent: 'SEARCH_NEARBY',\n    nearby_raw: [],\n    location: 'v·ªã tr√≠ c·ªßa b·∫°n',\n    poiType: prevData.poiType,\n    has_results: false\n  };\n}\n\nconst nearby_raw = results.slice(0, requestedCount).map((p, idx) => ({\n  rank: idx + 1,\n  name: p.title || 'N/A',\n  address: p.address || null,\n  rating: p.rating || null,\n  reviews: p.reviews || null,\n  type: p.type || prevData.poiType,\n  distance: p.distance || null\n}));\n\nreturn {\n  intent: 'SEARCH_NEARBY',\n  nearby_raw,\n  location: 'v·ªã tr√≠ c·ªßa b·∫°n',\n  poiType: prevData.poiType,\n  requestedCount,\n  has_results: true\n};"
      },
      "id": "fn-format-nearby",
      "name": "Fn_FormatNearby",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59040,
        67808
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE TOUR DURATION =====\n// Mission: Extract s·ªë ng√†y v√† location cho tour\n\nconst data = $json;\nconst msg = data.messageLower;\n\n// Extract duration\nlet duration = data.tourDuration || 3; // default 3 ng√†y\n\n// Extract location n·∫øu c√≥\nlet tourLocation = null;\nconst locationMatch = msg.match(/(?:·ªü|t·∫°i|ƒëi|tour)\\s+([\\w√Ä-·ªπ\\s]+?)(?:\\s+\\d+|$)/i);\nif (locationMatch) {\n  tourLocation = locationMatch[1].trim();\n}\n\n// Fallback: t√¨m city names\nif (!tourLocation) {\n  const cities = ['h√† n·ªôi', 's√†i g√≤n', 'ƒë√† n·∫µng', 'hu·∫ø', 'nha trang', 'ph√∫ qu·ªëc', 'h·ªôi an', 'ƒë√† l·∫°t', 'sapa', 'h·∫° long', 'ninh b√¨nh', 'mi·ªÅn b·∫Øc', 'mi·ªÅn trung', 'mi·ªÅn nam', 'vi·ªát nam'];\n  const found = cities.find(c => msg.includes(c));\n  if (found) tourLocation = found;\n}\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  intent: 'SEARCH_TOUR',\n  tourDuration: duration,\n  tourLocation,\n  hasLocation: !!tourLocation\n};"
      },
      "id": "fn-parse-tour-duration",
      "name": "Fn_ParseTourDuration",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58368,
        68112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasLocation }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "if-tour-no-location",
      "name": "IF_Tour_NoLocation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58592,
        68112
      ]
    },
    {
      "parameters": {
        "jsCode": "const duration = $json.tourDuration || '';\nreturn {\n  response: `üìç B·∫°n mu·ªën t√¨m tour ${duration} ng√†y ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•: ƒê√† N·∫µng, Ph√∫ Qu·ªëc, Sapa, H·∫° Long...`,\n  type: 'clarify_tour_location'\n};"
      },
      "id": "respond-clarify-tour-location",
      "name": "Respond_ClarifyTourLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        67904
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "=tour {{ $json.tourDuration }} ng√†y {{ $json.tourLocation }} gi√°"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-tour",
      "name": "HTTP_SearchTour",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        58816,
        68208
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT TOUR RESULTS =====\nconst prevData = $('Fn_ParseTourDuration').item.json;\nconst apiData = $json;\n\nconst results = apiData.organic_results || [];\n\nif (results.length === 0) {\n  return {\n    intent: 'SEARCH_TOUR',\n    tours_raw: [],\n    location: prevData.tourLocation,\n    duration: prevData.tourDuration,\n    has_results: false\n  };\n}\n\nconst tours_raw = results.slice(0, 5).map(t => ({\n  title: t.title || 'N/A',\n  snippet: t.snippet || null,\n  source: t.link || null,\n  provider: t.displayed_link || null\n}));\n\nreturn {\n  intent: 'SEARCH_TOUR',\n  tours_raw,\n  location: prevData.tourLocation,\n  duration: prevData.tourDuration,\n  has_results: true\n};"
      },
      "id": "fn-format-tour",
      "name": "Fn_FormatTour",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59040,
        68208
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasPlaceName }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "if-placeinfo-no-placename",
      "name": "IF_PlaceInfo_NoPlaceName",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58368,
        68304
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: 'üìç B·∫°n mu·ªën xem th√¥ng tin ƒë·ªãa ƒëi·ªÉm n√†o?\\n\\nV√≠ d·ª•:\\n‚Ä¢ ƒê·ªÅn Th√°i Vi\\n‚Ä¢ Ch√πa B√°i ƒê√≠nh\\n‚Ä¢ LƒÉng B√°c H·ªì\\n‚Ä¢ H·ªì Ho√†n Ki·∫øm',\n  type: 'clarify_place_name'\n};"
      },
      "id": "respond-clarify-placename",
      "name": "Respond_ClarifyPlaceName",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68112
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== RESOLVE PLACE NAME =====\n// Mission: Extract place name t·ª´ message cho GET_PLACE_INFO\n// Kh√°c v·ªõi location, placeName kh√¥ng c·∫ßn geocode\n\nconst data = $json;\nconst msg = data.messageLower || '';\nlet placeName = null;\n\n// Strategy 1: Place type keywords (ƒë·ªÅn, ch√πa, lƒÉng...)\nconst placeMatch = msg.match(/(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu|h·ªì|n√∫i|b√£i bi·ªÉn|c√¥ng vi√™n|b·∫£o t√†ng|di t√≠ch|khu)\\s+([\\w√Ä-·ªπ\\s]+?)(?:\\s+gi√°|\\s+gi·ªù|\\s+th√¥ng|\\s+cu·ªëi|\\s+h√¥m|\\s+\\?|$)/i);\nif (placeMatch) {\n  // Get full match and clean\n  placeName = placeMatch[0].replace(/gi√°|gi·ªù|th√¥ng.*$|cu·ªëi.*$|h√¥m.*$|\\?/gi, '').trim();\n}\n\n// Strategy 2: Reversed pattern (\"Th√°i Vi ƒë·ªÅn\")\nif (!placeName) {\n  const reversedMatch = msg.match(/([\\w√Ä-·ªπ]+)\\s+(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu)/i);\n  if (reversedMatch) {\n    placeName = reversedMatch[0].trim();\n  }\n}\n\n// Strategy 3: Famous landmarks\nif (!placeName) {\n  const landmarks = ['h·ªì ho√†n ki·∫øm', 'h·ªì g∆∞∆°m', 'lƒÉng b√°c', 'ch√πa m·ªôt c·ªôt', 'ch√πa b√°i ƒë√≠nh', 'tr√†ng an', 'tam c·ªëc', 'v·ªãnh h·∫° long', 'ƒë·ªông phong nha'];\n  const found = landmarks.find(l => msg.includes(l));\n  if (found) {\n    placeName = found;\n  }\n}\n\n// Strategy 4: Remove noise words and use what's left\nif (!placeName) {\n  const noiseWords = ['th√¥ng tin', 'gi√° v√©', 'gi·ªù m·ªü c·ª≠a', 'xem', 'cho bi·∫øt', 't√¥i', 'mu·ªën', 'cu·ªëi tu·∫ßn'];\n  let cleaned = msg;\n  for (const noise of noiseWords) {\n    cleaned = cleaned.replace(new RegExp(`\\\\s*${noise}\\\\s*`, 'gi'), ' ');\n  }\n  cleaned = cleaned.trim();\n  if (cleaned.length >= 3) {\n    placeName = cleaned;\n  }\n}\n\nreturn {\n  sessionId: data.sessionId,\n  message: data.message,\n  intent: 'GET_PLACE_INFO',\n  placeName,\n  locationDisplay: placeName\n};"
      },
      "id": "fn-resolve-placename",
      "name": "Fn_ResolvePlaceName",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.hasLocationHint }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "2c3deda8-90b2-40d9-8d47-0853896dfa4d",
      "name": "IF_NeedLocationClarification",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        58368,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "const intent = $json.intent;\nlet question = '';\n\nif (intent === 'SEARCH_POI') {\n  question = 'üìç B·∫°n mu·ªën t√¨m ƒë·ªãa ƒëi·ªÉm du l·ªãch ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•:\\n‚Ä¢ H√† N·ªôi\\n‚Ä¢ Ninh B√¨nh\\n‚Ä¢ S√†i G√≤n\\n‚Ä¢ ƒê√† N·∫µng';\n} else if (intent === 'GET_WEATHER') {\n  question = 'üå¶Ô∏è B·∫°n mu·ªën xem th·ªùi ti·∫øt ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•:\\n‚Ä¢ H√† N·ªôi\\n‚Ä¢ Ninh B√¨nh\\n‚Ä¢ ƒê√† N·∫µng';\n} else if (intent === 'SEARCH_HOTEL') {\n  question = 'üèöÔ∏è B·∫°n mu·ªën t√¨m kh√°ch s·∫°n ·ªü ƒë√¢u?\\n\\nV√≠ d·ª•:\\n‚Ä¢ H√† N·ªôi\\n‚Ä¢ Ninh B√¨nh\\n‚Ä¢ Qu·∫≠n 1 S√†i G√≤n';\n} else {\n  question = 'üìç B·∫°n c√≥ th·ªÉ cho bi·∫øt ƒë·ªãa ƒëi·ªÉm c·ª• th·ªÉ kh√¥ng?\\n\\nV√≠ d·ª•: H√† N·ªôi, Ninh B√¨nh, ƒê√† N·∫µng...';\n}\n\nreturn {\n  response: question,\n  type: 'clarify_location'\n};"
      },
      "id": "4d688a01-03dc-4f31-ba03-3e1873cc3868",
      "name": "Respond_ClarifyLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68624
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== EXTRACT LOCATION =====\n// Mission: Extract location t·ª´ message\n\nconst message = $json.messageLower || '';\nconst intent = $json.intent;\nlet locationRaw = null;\n\n// Strategy 1: After location keywords\nconst matchAfter = message.match(/(?:·ªü|t·∫°i|g·∫ßn|quanh|xung quanh)\\s+([^,?.!]+)/i);\nif (matchAfter) {\n  locationRaw = matchAfter[1].trim();\n}\n\n// Strategy 2: Place names (ƒë·ªÅn, ch√πa, lƒÉng...)\nif (!locationRaw && intent === 'GET_PLACE_INFO') {\n  const placeMatch = message.match(/(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu|h·ªì|n√∫i|b√£i|c√¥ng vi√™n|b·∫£o t√†ng)\\s+([\\w√Ä-·ªπ\\s]+?)(?:\\s+gi√°|\\s+gi·ªù|\\s+th√¥ng|$)/i);\n  if (placeMatch) {\n    locationRaw = placeMatch[0].replace(/gi√°|gi·ªù|th√¥ng.*$/i, '').trim();\n  }\n  \n  // Try reversed pattern: \"Th√°i Vi ƒë·ªÅn\"\n  if (!locationRaw) {\n    const reversedMatch = message.match(/([\\w√Ä-·ªπ]+)\\s+(?:ƒë·ªÅn|ch√πa|lƒÉng|mi·∫øu)/i);\n    if (reversedMatch) {\n      locationRaw = reversedMatch[0].trim();\n    }\n  }\n}\n\n// Strategy 3: Common city names\nif (!locationRaw) {\n  const cities = ['h√† n·ªôi', 'hanoi', 's√†i g√≤n', 'saigon', 'h·ªì ch√≠ minh', 'ƒë√† n·∫µng', 'da nang', 'hu·∫ø', 'hue', 'nha trang', 'ph√∫ qu·ªëc', 'h·ªôi an', 'ƒë√† l·∫°t', 'sapa', 'h·∫° long', 'ninh b√¨nh'];\n  const found = cities.find(c => message.includes(c));\n  if (found) {\n    locationRaw = found;\n  }\n}\n\n// Strategy 4: Remove noise words\nif (!locationRaw) {\n  const noiseWords = ['t√¨m', 'ƒë·ªãa ƒëi·ªÉm', 'du l·ªãch', 'th·ªùi ti·∫øt', 'kh√°ch s·∫°n', 'hotel', 'weather', 'xem', 'tham quan', 'th√¥ng tin', 'gi√° v√©', 'gi·ªù m·ªü c·ª≠a'];\n  let cleaned = message;\n  for (const noise of noiseWords) {\n    cleaned = cleaned.replace(new RegExp(`\\\\s*${noise}\\\\s*`, 'gi'), ' ');\n  }\n  cleaned = cleaned.trim();\n  if (cleaned.length >= 3) {\n    locationRaw = cleaned;\n  }\n}\n\nreturn {\n  sessionId: $json.sessionId,\n  message: $json.message,\n  intent: $json.intent,\n  location: locationRaw\n};"
      },
      "id": "a394e134-30f7-4b83-b444-d5a928b0eb28",
      "name": "Fn_ExtractLocation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        58592,
        68496
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.location }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "6b174c18-a629-4546-a47c-3896f3ffdc8f",
      "name": "IF_LocationValid",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        58816,
        68496
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: '‚ùå Kh√¥ng th·ªÉ x√°c ƒë·ªãnh ƒë·ªãa ƒëi·ªÉm.\\n\\nVui l√≤ng cung c·∫•p r√µ h∆°n, v√≠ d·ª•:\\n- H√† N·ªôi\\n- ƒê·ªÅn Th√°i Vi\\n- Qu·∫≠n 1, S√†i G√≤n',\n  type: 'error'\n};"
      },
      "id": "1607049d-25fe-40d2-8d81-6ae1489fe4e7",
      "name": "Respond_LocationInvalid",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68816
      ]
    },
    {
      "parameters": {
        "url": "https://geocode.search.hereapi.com/v1/geocode",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "q",
              "value": "={{ $json.location }}"
            },
            {
              "name": "apiKey",
              "value": "DyD7QbF6uEeLGB47HYJ-ixnpiuYuS_HNFVaZso01_lQ"
            },
            {
              "name": "lang",
              "value": "vi-VN"
            },
            {
              "name": "limit",
              "value": "1"
            },
            {
              "name": "in",
              "value": "countryCode:VNM"
            }
          ]
        },
        "options": {
          "timeout": 8000
        }
      },
      "id": "806ae408-3190-4e59-9a65-dcd8facb0895",
      "name": "HTTP_Geocode",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59040,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE GEOCODING =====\nconst prevData = $('Fn_ExtractLocation').item.json;\nconst geoData = $json;\n\nlet coordinates = null;\nlet displayName = null;\n\nif (geoData.items && geoData.items.length > 0) {\n  const item = geoData.items[0];\n  if (item.position) {\n    const lat = item.position.lat;\n    const lon = item.position.lng;\n    coordinates = `${lat},${lon}`;\n  }\n  displayName = item.title || item.address?.label || prevData.location;\n} else {\n  displayName = prevData.location;\n}\n\nreturn {\n  sessionId: prevData.sessionId,\n  message: prevData.message,\n  intent: prevData.intent,\n  location: prevData.location,\n  locationDisplay: displayName,\n  coordinates\n};"
      },
      "id": "0ff38a7e-07e4-4890-afcb-b6139dd74ee5",
      "name": "Fn_ParseGeocode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        59264,
        68400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.coordinates }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "70536312-8e87-4d32-b301-0d8f5413af13",
      "name": "IF_GeocodeSuccess",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        59488,
        68400
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  response: '‚ùå Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm \"' + $json.location + '\".\\n\\nVui l√≤ng th·ª≠ l·∫°i v·ªõi t√™n kh√°c ho·∫∑c cung c·∫•p th√™m th√¥ng tin (qu·∫≠n/huy·ªán/th√†nh ph·ªë).',\n  type: 'geocode_failed'\n};"
      },
      "id": "560a2e50-2aaf-4cdc-9f61-2284cce524a1",
      "name": "Respond_GeocodeFailed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        61600,
        68432
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_POI",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "POI"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "GET_WEATHER",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Weather"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "SEARCH_HOTEL",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Hotel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.intent }}",
                    "rightValue": "GET_PLACE_INFO",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PlaceInfo"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "f8548ae8-94b7-4444-bf78-106ed6fb9af4",
      "name": "Switch_RouteToAPI",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        59712,
        68208
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} ƒëi·ªÉm tham quan du l·ªãch"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "e8527309-6d6e-408d-af81-ba96205b257f",
      "name": "HTTP_SearchPOI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        67904
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "url": "https://api.weatherapi.com/v1/current.json",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "52c2f536877444ec8a0165526260501"
            },
            {
              "name": "q",
              "value": "={{ $json.coordinates || $json.location }}"
            },
            {
              "name": "lang",
              "value": "vi"
            },
            {
              "name": "aqi",
              "value": "yes"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "cba5b795-a0ab-4259-a4af-ccafb8ee1caf",
      "name": "HTTP_GetWeather",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        68096
      ]
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google_hotels"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} hotels"
            },
            {
              "name": "check_in_date",
              "value": "={{ $now.format('yyyy-MM-dd') }}"
            },
            {
              "name": "check_out_date",
              "value": "={{ $now.plus({days: 1}).format('yyyy-MM-dd') }}"
            },
            {
              "name": "currency",
              "value": "VND"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "6110ff85-c776-413d-a9a5-262e39153206",
      "name": "HTTP_SearchHotel",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        68288
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "url": "https://serpapi.com/search",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "serpApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "engine",
              "value": "google"
            },
            {
              "name": "q",
              "value": "={{ $json.locationDisplay }} gi√° v√© gi·ªù m·ªü c·ª≠a th√¥ng tin"
            },
            {
              "name": "hl",
              "value": "vi"
            },
            {
              "name": "gl",
              "value": "vn"
            },
            {
              "name": "num",
              "value": "5"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "http-search-place-info",
      "name": "HTTP_SearchPlaceInfo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        59936,
        68480
      ],
      "credentials": {
        "serpApi": {
          "id": "vD3y3KChuLVK1OPF",
          "name": "SerpAPI account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT POI RESULTS (AGODA-STYLE) =====\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y - d√πng data t·ª´ Fn_ParseGeocode\nconst geocodeData = $('Fn_ParseGeocode').item.json;\nconst apiData = $json;\n\nconst results = apiData.organic_results || [];\n\nif (results.length === 0) {\n  return {\n    intent: 'SEARCH_POI',\n    poi_raw: [],\n    location: geocodeData.locationDisplay,\n    has_results: false\n  };\n}\n\nconst poi_raw = results.slice(0, 5).map(p => ({\n  name: p.title || 'N/A',\n  source: p.link || null,\n  short_fact: p.snippet || null\n}));\n\nreturn {\n  intent: 'SEARCH_POI',\n  poi_raw,\n  location: geocodeData.locationDisplay,\n  has_results: true\n};"
      },
      "id": "bd6b8407-7cd8-4982-84cc-ce2a87573e1e",
      "name": "Fn_FormatPOI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        67904
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT WEATHER RESULTS (AGODA-STYLE) =====\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y\nconst geocodeData = $('Fn_ParseGeocode').item.json;\nconst apiData = $json;\n\nif (!apiData.current) {\n  return {\n    intent: 'GET_WEATHER',\n    weather_raw: null,\n    location: geocodeData.locationDisplay,\n    has_results: false\n  };\n}\n\nconst current = apiData.current;\n\nconst weather_raw = {\n  temp_c: current.temp_c,\n  feelslike_c: current.feelslike_c,\n  condition: current.condition?.text || '',\n  humidity: current.humidity || 0,\n  wind_kph: current.wind_kph || 0,\n  last_updated: current.last_updated || ''\n};\n\nreturn {\n  intent: 'GET_WEATHER',\n  weather_raw,\n  location: geocodeData.locationDisplay,\n  has_results: true\n};"
      },
      "id": "83122bb9-7642-43d0-ac79-2f4e8af4b9d1",
      "name": "Fn_FormatWeather",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        68096
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT HOTEL RESULTS (AGODA-STYLE) =====\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y\nconst geocodeData = $('Fn_ParseGeocode').item.json;\nconst apiData = $json;\n\nconst hotels = apiData.properties || [];\n\nif (hotels.length === 0) {\n  return {\n    intent: 'SEARCH_HOTEL',\n    hotels_raw: [],\n    location: geocodeData.locationDisplay,\n    has_results: false\n  };\n}\n\nconst hotels_raw = hotels.slice(0, 5).map(h => ({\n  name: h.name || 'N/A',\n  price: h.rate_per_night?.lowest || null,\n  rating: h.overall_rating || null,\n  description: h.description || null\n}));\n\nreturn {\n  intent: 'SEARCH_HOTEL',\n  hotels_raw,\n  location: geocodeData.locationDisplay,\n  has_results: true\n};"
      },
      "id": "9d281c1c-5090-4fcc-9260-d88cc269b7ae",
      "name": "Fn_FormatHotel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        68288
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMAT PLACE INFO RESULTS (AGODA-STYLE) =====\n// Mission: Extract gi√° v√©, gi·ªù m·ªü c·ª≠a t·ª´ search results\n// ‚ö° FIX: KH√îNG ƒë·ªçc Switch ch∆∞a ch·∫°y - d√πng data t·ª´ Fn_ResolvePlaceName\n\nconst placeData = $('Fn_ResolvePlaceName').item.json;\nconst apiData = $json;\n\nconst results = apiData.organic_results || [];\nconst knowledgeGraph = apiData.knowledge_graph || {};\n\n// Structured place info\nconst place_info = {\n  name: placeData.placeName || placeData.locationDisplay,\n  description: null,\n  ticket_price: null,\n  opening_hours: null,\n  address: null,\n  note_if_unknown: null\n};\n\n// Try knowledge graph first\nif (knowledgeGraph.title) {\n  place_info.description = knowledgeGraph.description || null;\n  place_info.address = knowledgeGraph.address || null;\n  // Opening hours from KG\n  if (knowledgeGraph.hours) {\n    place_info.opening_hours = typeof knowledgeGraph.hours === 'string' \n      ? knowledgeGraph.hours \n      : JSON.stringify(knowledgeGraph.hours);\n  }\n}\n\n// Extract from snippets\nfor (const r of results) {\n  const snippet = (r.snippet || '').toLowerCase();\n  \n  // Look for ticket price\n  const priceMatch = snippet.match(/(\\d+[.,]?\\d*)\\s*(ƒë|vnƒë|ƒë·ªìng|k|ngh√¨n|tri·ªáu)/i);\n  if (priceMatch && !place_info.ticket_price) {\n    place_info.ticket_price = priceMatch[0];\n  }\n  \n  // Look for opening hours\n  const hoursMatch = snippet.match(/(\\d{1,2}[h:]\\d{0,2}\\s*-\\s*\\d{1,2}[h:]\\d{0,2}|m·ªü c·ª≠a[^.]+)/i);\n  if (hoursMatch && !place_info.opening_hours) {\n    place_info.opening_hours = hoursMatch[0];\n  }\n  \n  // Get description if not set\n  if (!place_info.description && r.snippet && r.snippet.length > 50) {\n    place_info.description = r.snippet;\n  }\n}\n\n// Add commercial note if missing critical info\nif (!place_info.ticket_price) {\n  place_info.note_if_unknown = 'Hi·ªán ch∆∞a c√≥ th√¥ng tin gi√° v√© ch√≠nh th·ª©c, b·∫°n n√™n li√™n h·ªá ƒë·ªãa ph∆∞∆°ng ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.';\n}\nif (!place_info.opening_hours) {\n  place_info.note_if_unknown = (place_info.note_if_unknown || '') + ' Th√¥ng tin gi·ªù m·ªü c·ª≠a ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t.';\n}\n\nreturn {\n  intent: 'GET_PLACE_INFO',\n  place_info,\n  location: placeData.placeName || placeData.locationDisplay,\n  has_results: !!(place_info.description || place_info.ticket_price || place_info.opening_hours)\n};"
      },
      "id": "fn-format-place-info",
      "name": "Fn_FormatPlaceInfo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60160,
        68480
      ]
    },
    {
      "parameters": {
        "jsCode": "// ===== BUILD COMPLETE REQUEST BODY =====\n// Mission: T·∫°o TO√ÄN B·ªò request body cho OpenRouter\n// ‚ö° UPDATED: H·ªó tr·ª£ 6 intents\n\nconst data = $json;\n\nconst intent = data.intent || 'UNKNOWN';\nconst location = data.location || null;\nconst has_results = data.has_results !== false;\n\n// Chu·∫©n h√≥a data theo intent\nlet structured_data = null;\n\nif (intent === 'SEARCH_POI') {\n  structured_data = {\n    places: data.poi_raw || [],\n    count: (data.poi_raw || []).length\n  };\n} else if (intent === 'GET_WEATHER') {\n  structured_data = {\n    weather: data.weather_raw || null\n  };\n} else if (intent === 'SEARCH_HOTEL') {\n  structured_data = {\n    hotels: data.hotels_raw || [],\n    count: (data.hotels_raw || []).length\n  };\n} else if (intent === 'GET_PLACE_INFO') {\n  structured_data = {\n    place_info: data.place_info || null\n  };\n} else if (intent === 'SEARCH_NEARBY') {\n  structured_data = {\n    nearby_places: data.nearby_raw || [],\n    count: (data.nearby_raw || []).length,\n    poi_type: data.poiType || 'ƒë·ªãa ƒëi·ªÉm'\n  };\n} else if (intent === 'SEARCH_TOUR') {\n  structured_data = {\n    tours: data.tours_raw || [],\n    count: (data.tours_raw || []).length,\n    duration: data.duration || null\n  };\n}\n\nconst ai_input = {\n  intent,\n  location,\n  has_results,\n  data: structured_data\n};\n\nconst systemPrompt = `VAI TR√í\nB·∫°n l√† module VI·∫æT L·∫†I K·∫æT QU·∫¢ cho chatbot du l·ªãch th∆∞∆°ng m·∫°i.\nB·∫°n KH√îNG ph·∫£i c√¥ng c·ª• t√¨m ki·∫øm, KH√îNG ph·∫£i AI s√°ng t√°c.\n\nM·ª§C TI√äU\n- ƒê√°ng tin\n- Kh√¥ng n√≥i sai\n- Kh√¥ng g√¢y r·ªëi\n- Gi·ªëng c√°ch nh√¢n vi√™n t∆∞ v·∫•n du l·ªãch vi·∫øt\n\nNGUY√äN T·∫ÆC B·∫ÆT BU·ªòC\n1. CH·ªà s·ª≠ d·ª•ng d·ªØ li·ªáu ƒë∆∞·ª£c cung c·∫•p trong ƒë·∫ßu v√†o.\n2. KH√îNG b·ªãa th√™m ƒë·ªãa ƒëi·ªÉm, th√¥ng tin, ho·∫∑c chi ti·∫øt.\n3. KH√îNG suy di·ªÖn v∆∞·ª£t qu√° d·ªØ li·ªáu.\n4. N·∫øu d·ªØ li·ªáu ch·ªâ mang t√≠nh t·ªïng quan ‚Üí n√≥i r√µ l√† \"th√¥ng tin t·ªïng quan\".\n5. N·∫øu ƒë·ªãa danh trong input kh√¥ng r√µ r√†ng ‚Üí di·ªÖn ƒë·∫°t trung t√≠nh, kh√¥ng kh·∫≥ng ƒë·ªãnh sai.\n6. N·∫øu c√≥ note_if_unknown ‚Üí B·∫ÆT BU·ªòC ƒë∆∞a v√†o response.\n\nQUY T·∫ÆC VI·∫æT N·ªòI DUNG\n- ƒê∆Ø·ª¢C t√≥m t·∫Øt v√† di·ªÖn ƒë·∫°t l·∫°i t·ª´ n·ªôi dung ngu·ªìn.\n- KH√îNG sao ch√©p nguy√™n vƒÉn ti√™u ƒë·ªÅ, snippet, ho·∫∑c m√¥ t·∫£ SEO.\n- M·ªói ƒë·ªãa ƒëi·ªÉm: 2‚Äì3 c√¢u ng·∫Øn, trung t√≠nh.\n- Tr√°nh t·ª´ ng·ªØ qu·∫£ng c√°o, tr√°nh vƒÉn phong AI.\n- TUY·ªÜT ƒê·ªêI KH√îNG d√πng d·∫•u \"...\".\n\nƒê·∫∂C BI·ªÜT CHO GET_PLACE_INFO\n- N·∫øu c√≥ gi√° v√©: ghi r√µ\n- N·∫øu c√≥ gi·ªù m·ªü c·ª≠a: ghi r√µ\n- N·∫øu KH√îNG c√≥: n√≥i \"Hi·ªán ch∆∞a c√≥ th√¥ng tin ch√≠nh th·ª©c, vui l√≤ng li√™n h·ªá ƒë·ªãa ph∆∞∆°ng\"\n\nƒê·∫∂C BI·ªÜT CHO SEARCH_NEARBY\n- Li·ªát k√™ theo th·ª© t·ª± g·∫ßn nh·∫•t\n- N·∫øu c√≥ distance: ghi kho·∫£ng c√°ch\n- N·∫øu c√≥ rating: ghi ƒë√°nh gi√°\n\nƒê·∫∂C BI·ªÜT CHO SEARCH_TOUR\n- N√™u t√™n tour v√† ngu·ªìn\n- KH√îNG t·ª± l·∫≠p l·ªãch tr√¨nh\n- Khuy·∫øn ngh·ªã: \"B·∫°n c√≥ th·ªÉ li√™n h·ªá c√°c ƒë∆°n v·ªã tr√™n ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt\"\n\nTR√åNH B√ÄY\n- Danh s√°ch r√µ r√†ng\n- T√™n ƒë·ªãa ƒëi·ªÉm in ƒë·∫≠m\n- Cu·ªëi c√¢u tr·∫£ l·ªùi: h·ªèi ti·∫øp 1 c√¢u ƒë·ªãnh h∆∞·ªõng nh·∫π\n\nCH·ªà TR·∫¢ V·ªÄ JSON H·ª¢P L·ªÜ. KH√îNG th√™m ch·ªØ gi·∫£i th√≠ch. KH√îNG markdown.\n{\n  \"response\": \"N·ªôi dung ph·∫£n h·ªìi cho ng∆∞·ªùi d√πng\",\n  \"type\": \"success\"\n}`;\n\nconst requestBody = {\n  model: 'openai/gpt-4o-mini',\n  temperature: 0.3,\n  max_tokens: 600,\n  messages: [\n    {\n      role: 'system',\n      content: systemPrompt\n    },\n    {\n      role: 'user',\n      content: 'D·ªØ li·ªáu:\\n' + JSON.stringify(ai_input, null, 2)\n    }\n  ]\n};\n\nreturn { requestBody };"
      },
      "id": "81319b58-db1e-4c99-b48b-945095e276eb",
      "name": "Fn_BuildAIInput",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60384,
        68192
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.requestBody }}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "f23f27eb-999a-4639-8f22-e314a3615a9e",
      "name": "AI_Response_Guard",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        60608,
        68192
      ],
      "credentials": {
        "httpBearerAuth": {
          "id": "SVjS2GRy7ezqnu9w",
          "name": "Bearer Auth account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ===== PARSE AI GUARD RESPONSE =====\nconst content = ($json.choices?.[0]?.message?.content || '{}').trim();\nlet parsed = {};\ntry {\n  parsed = JSON.parse(content);\n} catch(e) {\n  parsed = {\n    response: 'ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.',\n    type: 'error'\n  };\n}\n\nreturn parsed;"
      },
      "id": "c99dcf1d-9084-4f2a-af5a-d4888a6c4248",
      "name": "Fn_ParseGuardResponse",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        60832,
        68192
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "c2424688-fba9-492d-a100-f70a68c7a014",
      "name": "Respond_Final",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        61856,
        68432
      ]
    }
  ],
  "connections": {
    "Webhook_ReceiveMessage": {
      "main": [
        [
          {
            "node": "Fn_NormalizeInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_NormalizeInput": {
      "main": [
        [
          {
            "node": "IF_IsTravelDomain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_IsTravelDomain": {
      "main": [
        [
          {
            "node": "Fn_DetectIntentRuleBased",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_OutOfScope",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_OutOfScope": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_DetectIntentRuleBased": {
      "main": [
        [
          {
            "node": "Fn_CheckRequiredSlots",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_CheckRequiredSlots": {
      "main": [
        [
          {
            "node": "IF_NeedIntentClarification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_NeedIntentClarification": {
      "main": [
        [
          {
            "node": "Respond_ClarifyIntent",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch_SpecialIntent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyIntent": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_SpecialIntent": {
      "main": [
        [
          {
            "node": "IF_Nearby_NoLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ParseTourDuration",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF_PlaceInfo_NoPlaceName",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF_NeedLocationClarification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_Nearby_NoLocation": {
      "main": [
        [
          {
            "node": "Respond_RequestLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_BuildNearbySearch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_RequestLocation": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_BuildNearbySearch": {
      "main": [
        [
          {
            "node": "HTTP_SearchNearby",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchNearby": {
      "main": [
        [
          {
            "node": "Fn_FormatNearby",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatNearby": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseTourDuration": {
      "main": [
        [
          {
            "node": "IF_Tour_NoLocation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_Tour_NoLocation": {
      "main": [
        [
          {
            "node": "Respond_ClarifyTourLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchTour",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyTourLocation": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchTour": {
      "main": [
        [
          {
            "node": "Fn_FormatTour",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatTour": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_PlaceInfo_NoPlaceName": {
      "main": [
        [
          {
            "node": "Respond_ClarifyPlaceName",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ResolvePlaceName",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyPlaceName": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ResolvePlaceName": {
      "main": [
        [
          {
            "node": "HTTP_SearchPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_NeedLocationClarification": {
      "main": [
        [
          {
            "node": "Respond_ClarifyLocation",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fn_ExtractLocation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_ClarifyLocation": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ExtractLocation": {
      "main": [
        [
          {
            "node": "IF_LocationValid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_LocationValid": {
      "main": [
        [
          {
            "node": "HTTP_Geocode",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_LocationInvalid",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_LocationInvalid": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_Geocode": {
      "main": [
        [
          {
            "node": "Fn_ParseGeocode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseGeocode": {
      "main": [
        [
          {
            "node": "IF_GeocodeSuccess",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF_GeocodeSuccess": {
      "main": [
        [
          {
            "node": "Switch_RouteToAPI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respond_GeocodeFailed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respond_GeocodeFailed": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch_RouteToAPI": {
      "main": [
        [
          {
            "node": "HTTP_SearchPOI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_GetWeather",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchHotel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP_SearchPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchPOI": {
      "main": [
        [
          {
            "node": "Fn_FormatPOI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_GetWeather": {
      "main": [
        [
          {
            "node": "Fn_FormatWeather",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchHotel": {
      "main": [
        [
          {
            "node": "Fn_FormatHotel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP_SearchPlaceInfo": {
      "main": [
        [
          {
            "node": "Fn_FormatPlaceInfo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatPOI": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatWeather": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatHotel": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_FormatPlaceInfo": {
      "main": [
        [
          {
            "node": "Fn_BuildAIInput",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_BuildAIInput": {
      "main": [
        [
          {
            "node": "AI_Response_Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI_Response_Guard": {
      "main": [
        [
          {
            "node": "Fn_ParseGuardResponse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fn_ParseGuardResponse": {
      "main": [
        [
          {
            "node": "Respond_Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "8298d6d82438e8d5ee28189bff4aaace26c9e5a75151cb6d6f4c18d7bb992ea7"
  }
}



